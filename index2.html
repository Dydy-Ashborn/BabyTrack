<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BabyTrack</title>

    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3B82F6">

    <!-- Favicons -->
    <link rel="icon" type="image/png" href="logo.PNG">

    <!-- Apple iOS Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BabyTrack">
    <link rel="apple-touch-icon" sizes="152x152" href="logo.PNG">
    <link rel="apple-touch-icon" sizes="180x180" href="logo.PNG">
    <link rel="apple-touch-icon" sizes="192x192" href="logo.PNG">

    <!-- Mobile Web App -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <!-- Scripts et styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <!-- CDN jsPDF + html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .logo-gradient {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
        }

        .logo-gradient-text {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-gradient-border {
            border-image: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%) 1;
        }

        .gradient-animation {
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb, #f5576c, #4facfe, #00f2fe);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .slide-up {
            animation: slideUp 0.6s ease-out forwards;
            transform: translateY(30px);
            opacity: 0;
        }

        @keyframes slideUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .bounce-in {
            animation: bounceIn 0.8s ease-out forwards;
            transform: scale(0.8);
            opacity: 0;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            60% {
                transform: scale(1.05);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .theme-transition {
            transition: all 0.5s ease-in-out;
        }

        .animate-in {
            animation: slideIn 0.3s ease-out forwards;
            opacity: 0;
            transform: translate(-50%, 0) scale(0.8);
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translate(-50%, 0) scale(1);
            }
        }

        body {
            overscroll-behavior: none;
            -ms-overflow-style: none;
            scrollbar-width: none;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        body::-webkit-scrollbar {
            display: none;
        }

        .glass {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.7);
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pulse-gentle {
            animation: pulse-gentle 2s ease-in-out infinite;
        }

        @keyframes pulse-gentle {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .medication-available {
            border-color: #10b981;
            background-color: #f0fdf4;
        }

        .medication-waiting {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }

        .medication-soon {
            border-color: #ef4444;
            background-color: #fef2f2;
        }

        .appointment-today {
            border-color: #ef4444;
            background-color: #fef2f2;
        }

        .appointment-upcoming {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }
    </style>

    <!-- Logo BabyTrack en SVG -->
    <svg id="babytrack-logo" style="display: none;">
        <defs>
            <symbol id="logo-symbol" viewBox="0 0 200 120">
                <!-- Montre/cadre -->
                <rect x="20" y="30" width="100" height="60" rx="20" ry="20" fill="url(#gradient1)" stroke="#2563eb"
                    stroke-width="4" />
                <rect x="25" y="35" width="90" height="50" rx="15" ry="15" fill="white" />

                <!-- Visage bÃ©bÃ© -->
                <circle cx="70" cy="60" r="20" fill="white" stroke="#2563eb" stroke-width="3" />
                <path d="M70 45 Q75 40, 80 45" fill="none" stroke="#2563eb" stroke-width="2" stroke-linecap="round" />
                <circle cx="65" cy="55" r="2" fill="#2563eb" />
                <circle cx="75" cy="55" r="2" fill="#2563eb" />
                <path d="M65 65 Q70 70, 75 65" fill="none" stroke="#2563eb" stroke-width="2" stroke-linecap="round" />

                <!-- Bracelet -->
                <rect x="10" y="45" width="15" height="30" rx="7" ry="7" fill="url(#gradient2)" />
                <rect x="115" y="45" width="15" height="30" rx="7" ry="7" fill="url(#gradient2)" />

                <!-- Gradients -->
                <defs>
                    <linearGradient id="gradient1" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="gradient2" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
                    </linearGradient>
                </defs>
            </symbol>
        </defs>
    </svg>
</head>

<body>
    <!-- Ã‰cran de chargement amÃ©liorÃ© -->
    <!-- Ã‰cran de chargement simple -->
    <div id="loading-screen" style="
    position: fixed;
    inset: 0;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    transition: opacity 0.8s ease-out;
">
        <div style="text-align: center;">
            <!-- Logo -->
            <div style="
            width: 120px;
            height: 120px;
            margin: 0 auto 40px;
            position: relative;
            animation: pulse 2s ease-in-out infinite;
        ">
                <img src="logo.PNG" alt="BabyTrack" style="
                width: 100%;
                height: 100%;
                border-radius: 24px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            ">
            </div>

            <!-- Animation de chargement -->
            <div style="
            width: 60px;
            height: 60px;
            margin: 0 auto;
            border: 4px solid #f3f4f6;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        "></div>
        </div>
    </div>

    <style>
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }
    </style>

    <script>
        window.addEventListener('load', () => {
            setTimeout(() => {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => loadingScreen.remove(), 800);
                }
            }, 1500);
        });
    </script>

    <style>
        @keyframes gradientMove {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-15px);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.05);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(200%);
            }
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>

    <script>
        window.addEventListener('load', () => {
            setTimeout(() => {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => loadingScreen.remove(), 800);
                }
            }, 1500);
        });
    </script>
    <div id="root"></div>

    <script type="text/babel">
        // Protection contre les erreurs externes
        window.addEventListener('error', function (e) {
            if (e.filename && e.filename.includes('page-events.js')) {
                e.preventDefault();
                return true;
            }
        });
        const { useState, useEffect, useRef } = React;

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCPQpB3cYk2sgbOVQ8KLbU1Qj2U67D2rZ4",
            authDomain: "suivi-loan.firebaseapp.com",
            projectId: "suivi-loan",
            storageBucket: "suivi-loan.firebasestorage.app",
            messagingSenderId: "334984699415",
            appId: "1:334984699415:web:8b41abb9360d31efabc652"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();




        const BabyTracker = () => {
            // Ã‰tats principaux
            const [user, setUser] = useState(null);
            const [entries, setEntries] = useState([]);
            const [stocks, setStocks] = useState({});
            // Ã‰tat pour les notifications personnalisÃ©es
            const [customAlert, setCustomAlert] = useState(null);

            // Ã‰tat pour le suivi du poids
            const [currentWeight, setCurrentWeight] = useState(null);
            const [lastWeightUpdate, setLastWeightUpdate] = useState(null);
            // Ã‰tat pour le suivi de la diversification alimentaire
            const [diversificationEntries, setDiversificationEntries] = useState([]);
            const [diversificationData, setDiversificationData] = useState({
                category: '',
                food: '',
                quantity: '',
                notes: ''
            });

            const [wardrobe, setWardrobe] = useState([]);
            const [wardrobeData, setWardrobeData] = useState({
                type: '',
                size: '',
                quantity: 1,
                notes: ''
            });

            // Ã‰tats pour la liste de cadeaux
            const [giftList, setGiftList] = useState([]);
            const [showGiftModal, setShowGiftModal] = useState(false);
            const [giftData, setGiftData] = useState({
                url: '',
                name: '',
                price: '',
                image: '',
                reserved: false,
                notes: ''
            });
            const [editingGiftId, setEditingGiftId] = useState(null);
            // Ã‰tats pour le suivi du sommeil
            const [sleepSessions, setSleepSessions] = useState([]);
            const [currentSleep, setCurrentSleep] = useState(null); // Session en cours
            const [sleepData, setSleepData] = useState({
                startTime: '',
                endTime: '',
                date: new Date().toISOString().slice(0, 10)
            });
            // Ã‰tat pour le suivi de la croissance
            const [currentHeight, setCurrentHeight] = useState(null);
            const [lastHeightUpdate, setLastHeightUpdate] = useState(null);

            // Ã‰tats d'interface
            const [showAuth, setShowAuth] = useState(true);
            const [authMode, setAuthMode] = useState('login');
            const [currentView, setCurrentView] = useState('daily');
            const [periodView, setPeriodView] = useState('daily');
            const [showForm, setShowForm] = useState(false);
            const [formType, setFormType] = useState('');
            const [editingId, setEditingId] = useState(null);
            const [currentPage, setCurrentPage] = useState(0);
            const [historyFilter, setHistoryFilter] = useState('today');
            const [tipsExpanded, setTipsExpanded] = useState(0);
            const [showMoreMenu, setShowMoreMenu] = useState(false);
            const [showPlusMenu, setShowPlusMenu] = useState(false);
            const [editingWardrobeId, setEditingWardrobeId] = useState(null);
            const [editingSleepId, setEditingSleepId] = useState(null);
            // Ã‰tats des formulaires
            const [authData, setAuthData] = useState({
                code: '',
                babyName: '',
                inviteCode: '',
                birthDate: '',
                birthTime: '06:00',
                birthWeight: '',
                birthHeight: '',
                parents: '',
                gender: 'boy'
            });

            const [formData, setFormData] = useState({
                time: '',
                date: '',
                amount: '',
                hasPee: false,
                hasPoop: false,
                poopQuantity: '',
                poopConsistency: '',
                poopColor: ''
            });

            // Etats pour les pÃ©diatres et hÃ´pitaux
            const [showExportMenu, setShowExportMenu] = useState(false);
            const [exportPeriod, setExportPeriod] = useState('week');
            const [isExporting, setIsExporting] = useState(false);

            //Etats pour les graphiques sommeil
            const [sleepPeriodView, setSleepPeriodView] = useState('week');
            const sleepChartRef = useRef(null);
            const sleepChartInstance = useRef(null);

            // Ã‰tats pour les notifications
            const [notificationPermission, setNotificationPermission] = useState('default');
            const [activeNotifications, setActiveNotifications] = useState([]);
            // Ajoutez ceci avec vos autres dÃ©clarations useState
            const [scheduledNotifications, setScheduledNotifications] = useState(new Map());
            // Ã‰tats pour l'intervalle personnalisÃ© des biberons
            const [feedingInterval, setFeedingInterval] = useState(3); // 3 heures par dÃ©faut
            const [nextFeedingInfo, setNextFeedingInfo] = useState(null);



            // Ã‰tats pour le profil et paramÃ¨tres
            const [showProfileSettings, setShowProfileSettings] = useState(false);
            const [appSettings, setAppSettings] = useState({
                darkMode: false,
                notifications: true,
                autoBackup: true
            });
            // Ã‰tats pour l'allaitement
            const [breastfeedingSession, setBreastfeedingSession] = useState(null);
            const [breastfeedingEntries, setBreastfeedingEntries] = useState([]);
            const [breastfeedingData, setBreastfeedingData] = useState({
                breast: 'left', // left, right, both
                duration: '',
                notes: ''
            });

            // Ã‰tats pour le tire-lait  
            const [breastPumpEntries, setBreastPumpEntries] = useState([]);
            const [breastPumpData, setBreastPumpData] = useState({
                volume: '',
                duration: '',
                storage: 'fridge', // fridge, freezer, immediate
                notes: ''
            });
            const [showBreastfeedingModal, setShowBreastfeedingModal] = useState(false);
            const [showBreastPumpModal, setShowBreastPumpModal] = useState(false);


            // Ã‰tats pour les analytics
            const [analyticsFilter, setAnalyticsFilter] = useState(['feeding', 'diaper-pee']);
            const [analyticsPeriod, setAnalyticsPeriod] = useState('weekly');

            // Ã‰tats pour l'onboarding et l'essai gratuit
            const [showOnboarding, setShowOnboarding] = useState(false); const [onboardingStep, setOnboardingStep] = useState(0);
            const [onboardingData, setOnboardingData] = useState({
                babyName: '',
                gender: 'boy',
                birthDate: '',
                birthWeight: '',
                birthHeight: '',
                photo: null,
                trialStarted: false,
                feedingMode: ''
            });

            // Ã‰tats pour l'onboarding et l'essai gratuit
            const { useCallback } = React;

            // Fonction optimisÃ©e pour les changements d'input avec debounce
            const handleOnboardingChange = useCallback((field, value) => {
                setOnboardingData(prev => {
                    // Ã‰viter le re-render si la valeur n'a pas changÃ©
                    if (prev[field] === value) return prev;
                    return { ...prev, [field]: value };
                });
            }, []);
            const [trialInfo, setTrialInfo] = useState({
                isActive: false,
                startDate: null,
                endDate: null,
                plan: 'Solo'
            });
            // Ã‰tats pour le timer et l'affichage de l'essai
            const [trialTimeRemaining, setTrialTimeRemaining] = useState(null);
            const [showTrialBanner, setShowTrialBanner] = useState(false);
            const [currentPlan, setCurrentPlan] = useState('Solo'); // Solo, Freemium, Premium

            // Ã‰tats pour les accomplissements
            const [accomplishments, setAccomplishments] = useState({});
            const [showAccomplishments, setShowAccomplishments] = useState(false);
            const [selectedMilestone, setSelectedMilestone] = useState(null);
            const [selectedCategory, setSelectedCategory] = useState('movement');
            const [currentMilestoneAge, setCurrentMilestoneAge] = useState('2months');

            const [showWeightModal, setShowWeightModal] = useState(false);
            const [showHeightModal, setShowHeightModal] = useState(false);
            const [weightInput, setWeightInput] = useState('');
            const [heightInput, setHeightInput] = useState('');

            const [showSleepModal, setShowSleepModal] = useState(false);

            const [showFoodModal, setShowFoodModal] = useState(false);
            const [showWardrobeModal, setShowWardrobeModal] = useState(false);

            const [showMilkStockModal, setShowMilkStockModal] = useState(false);
            const [showWaterStockModal, setShowWaterStockModal] = useState(false);
            const [milkDateInput, setMilkDateInput] = useState('');
            const [waterDateTimeInput, setWaterDateTimeInput] = useState('');

            // Ã‰tat pour l'invitation
            const [inviteCodeInput, setInviteCodeInput] = useState('');
            const [generatedInviteCode, setGeneratedInviteCode] = useState('');


            // DonnÃ©es des accomplissements par Ã¢ge et catÃ©gorie
            const accomplishmentData = {
                '2months': {
                    movement: [
                        'Tient la tÃªte haute lorsque {babyName} est sur le ventre',
                        'Bouge les bras et les jambes de faÃ§on symÃ©trique',
                        'Commence Ã  tenir sa tÃªte droite quand on le porte'
                    ],
                    cognitive: [
                        'Suit des objets des yeux',
                        'RÃ©agit aux sons forts',
                        'Commence Ã  sourire en rÃ©ponse'
                    ],
                    language: [
                        'Fait des sons de gorge (ah, eh, oh)',
                        'Pleure diffÃ©remment selon ses besoins',
                        'Ã‰coute quand on lui parle'
                    ],
                    social: [
                        'Sourit en rÃ©ponse aux autres',
                        'Regarde les visages avec intÃ©rÃªt',
                        'Se calme quand on lui parle doucement'
                    ]
                },
                '4months': {
                    movement: [
                        'Tient sa tÃªte stable sans support',
                        'Se retourne du ventre vers le dos',
                        'Porte ses mains Ã  sa bouche'
                    ],
                    cognitive: [
                        'ReconnaÃ®t les visages familiers',
                        'Suit les objets en mouvement',
                        'Montre de la curiositÃ© pour son environnement'
                    ],
                    language: [
                        'Babille avec des sons variÃ©s',
                        'Rit aux Ã©clats',
                        'RÃ©pond quand on lui parle'
                    ],
                    social: [
                        'Sourit spontanÃ©ment',
                        'Aime jouer avec les autres',
                        'Exprime la joie et la contrariÃ©tÃ©'
                    ]
                },
                '6months': {
                    movement: [
                        'S\'assoit avec un support',
                        'Se retourne dans les deux sens',
                        'TransfÃ¨re des objets d\'une main Ã  l\'autre'
                    ],
                    cognitive: [
                        'Explore les objets avec sa bouche',
                        'Montre de l\'intÃ©rÃªt pour les images',
                        'Commence Ã  comprendre cause et effet'
                    ],
                    language: [
                        'Babille avec des consonnes (ma, ba, da)',
                        'RÃ©pond Ã  son nom',
                        'Fait des bruits pour attirer l\'attention'
                    ],
                    social: [
                        'ReconnaÃ®t les personnes familiÃ¨res',
                        'Aime regarder son reflet',
                        'Distingue les Ã©motions dans les voix'
                    ]
                },
                '9months': {
                    movement: [
                        'S\'assoit sans support',
                        'Rampe ou se dÃ©place au sol',
                        'Se tient debout avec aide'
                    ],
                    cognitive: [
                        'Cherche les objets cachÃ©s',
                        'Comprend la permanence des objets',
                        'Imite les actions simples'
                    ],
                    language: [
                        'Dit "mama" ou "papa" sans signification prÃ©cise',
                        'Comprend des mots simples',
                        'Utilise des gestes pour communiquer'
                    ],
                    social: [
                        'Montre de l\'anxiÃ©tÃ© face aux Ã©trangers',
                        'PrÃ©fÃ¨re les personnes familiÃ¨res',
                        'Joue Ã  des jeux simples comme "coucou"'
                    ]
                }
            };
            // Ref pour le graphique principal
            const analyticsChartRef = useRef(null);
            const analyticsChartInstance = useRef(null);
            // Refs pour les graphiques analytics
            const feedingChartRef = useRef(null);
            const diaperChartRef = useRef(null);
            const breastfeedingChartRef = useRef(null);
            const sleepAnalyticsChartRef = useRef(null);
            const foodChartRef = useRef(null);

            // Instances des graphiques
            const feedingChartInstance = useRef(null);
            const diaperChartInstance = useRef(null);
            const breastfeedingChartInstance = useRef(null);
            const sleepAnalyticsChartInstance = useRef(null);
            const foodChartInstance = useRef(null);
            // Demander la permission pour les notifications
            const requestNotificationPermission = async () => {
                if ('Notification' in window) {
                    const permission = await Notification.requestPermission();
                    setNotificationPermission(permission);
                    if (permission === 'granted') {
                        console.log('Notifications autorisÃ©es');
                        scheduleAllNotifications();
                    }
                    return permission === 'granted';
                }
                return false;
            };

            const scheduleAllNotifications = () => {
                if (notificationPermission !== 'granted') return;

                console.log('Programmation de toutes les notifications...');

                // Effacer les anciennes notifications
                clearAllNotifications();



                console.log(`${scheduledNotifications.size} notifications programmÃ©es`);
            };

            // Envoyer une notification immÃ©diate
            const sendNotification = (title, body) => {
                if (notificationPermission === 'granted' && 'Notification' in window) {
                    const notification = new Notification(title, {
                        body,
                        icon: 'logo.PNG',
                        badge: 'logo.PNG',
                        requireInteraction: false
                    });

                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };

                    return notification;
                }
            };

            // Programmer une notification avec setTimeout
            const scheduleNotification = (title, body, delayMinutes, uniqueKey) => {
                if (notificationPermission !== 'granted') return null;

                // Annuler l'ancienne notification si elle existe
                if (scheduledNotifications.has(uniqueKey)) {
                    clearTimeout(scheduledNotifications.get(uniqueKey));
                }

                // Programmer la nouvelle notification
                const timeoutId = setTimeout(() => {
                    sendNotification(title, body);
                    // Nettoyer la rÃ©fÃ©rence
                    setScheduledNotifications(prev => {
                        const newMap = new Map(prev);
                        newMap.delete(uniqueKey);
                        return newMap;
                    });
                }, delayMinutes * 60 * 1000);

                // Stocker la rÃ©fÃ©rence
                setScheduledNotifications(prev => {
                    const newMap = new Map(prev);
                    newMap.set(uniqueKey, timeoutId);
                    return newMap;
                });

                console.log(`Notification programmÃ©e: ${title} dans ${delayMinutes} minutes`);
                return timeoutId;
            };

            // Annuler toutes les notifications
            const clearAllNotifications = () => {
                scheduledNotifications.forEach((timeoutId) => {
                    clearTimeout(timeoutId);
                });
                setScheduledNotifications(new Map());
            };// Notifications pour biberon
            const scheduleNextFeedingNotification = () => {
                if (notificationPermission !== 'granted') return;

                if (!nextFeedingInfo) return;

                const now = new Date();
                const timeDiff = nextFeedingInfo.nextTime - now; const minutesUntilFeeding = Math.ceil(timeDiff / (1000 * 60));

                // Seulement si c'est dans les prochaines 8 heures et pas dÃ©jÃ  passÃ©
                if (minutesUntilFeeding > 0 && minutesUntilFeeding <= 480) {
                    scheduleNotification(
                        'ðŸ¼ C\'est l\'heure du biberon !',
                        `Il est temps de donner le biberon Ã  ${user?.babyName}`,
                        minutesUntilFeeding,
                        'next-feeding'
                    );
                }
            };

            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // Fonctions utilitaires
            const generateCode = () => Math.random().toString(36).substring(2, 8).toUpperCase();
            const getCurrentTime = () => new Date().toTimeString().slice(0, 5);
            const getCurrentDate = () => {
                const now = new Date();
                return now.toLocaleDateString('sv-SE'); // Format YYYY-MM-DD en heure locale
            };


            const calculateAge = () => {
                if (!user?.birthDate) {
                    return 0;
                }

                try {
                    // CrÃ©er les dates en heure locale pour Ã©viter les problÃ¨mes de fuseau
                    const birth = new Date(user.birthDate + 'T00:00:00');
                    const today = new Date();

                    // VÃ©rification que la date est valide
                    if (isNaN(birth.getTime())) {
                        console.log('Date de naissance invalide:', user.birthDate);
                        return 0;
                    }

                    // Si la date de naissance est dans le futur, retourner 0
                    if (birth > today) {
                        console.log('Date de naissance dans le futur');
                        return 0;
                    }

                    const diffTime = today - birth;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                    console.log('Calcul Ã¢ge:', {
                        birthDate: user.birthDate,
                        birth: birth,
                        today: today,
                        diffDays: diffDays
                    });

                    return Math.max(0, diffDays);
                } catch (error) {
                    console.error('Erreur calcul Ã¢ge:', error);
                    return 0;
                }
            };
            const formatAgeDisplay = (ageInDays) => {
                if (ageInDays <= 30) {
                    return `Jour ${ageInDays}`;
                }

                const months = Math.floor(ageInDays / 30);
                const remainingDays = ageInDays % 30;

                if (remainingDays === 0) {
                    return `${months} mois`;
                } else {
                    return `${months} mois ${remainingDays}j`;
                }
            };

            const formatTime = (timestamp) => {
                return new Date(timestamp).toLocaleTimeString('fr-FR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            const formatDate = (timestamp) => {
                return new Date(timestamp).toLocaleDateString('fr-FR', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long'
                });
            };
            // Fonction pour formater les dates des stocks
            const formatStockDate = (dateString) => {
                if (!dateString) return 'Non renseignÃ©e';

                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                } catch (error) {
                    return dateString; // Retourner la chaÃ®ne originale en cas d'erreur
                }
            };

            const formatStockDateTime = (datetimeString) => {
                if (!datetimeString) return 'Non renseignÃ©e';

                try {
                    const date = new Date(datetimeString);
                    return date.toLocaleString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (error) {
                    return datetimeString; // Retourner la chaÃ®ne originale en cas d'erreur
                }
            };

            const formatDateTime = (timestamp) => {
                const date = new Date(timestamp);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                if (date.toDateString() === today.toDateString()) {
                    return formatTime(timestamp);
                } else if (date.toDateString() === yesterday.toDateString()) {
                    return `Hier ${formatTime(timestamp)}`;
                } else {
                    return `${date.getDate()}/${date.getMonth() + 1} ${formatTime(timestamp)}`;
                }
            };

            const getDayStart = (date) => {
                const dayStart = new Date(date);
                dayStart.setHours(0, 0, 0, 0);
                return dayStart;
            };

            const getDayEnd = (date) => {
                const dayEnd = new Date(date);
                dayEnd.setHours(23, 59, 59, 999);
                return dayEnd;
            };

            // Fonction pour les couleurs selon le sexe
            const getThemeColors = () => {
                return user?.gender === 'girl' ? {
                    primary: 'from-pink-500 to-pink-600',
                    primaryBg: 'bg-pink-500',
                    primaryText: 'text-pink-600',
                    primaryBorder: 'border-pink-200',
                    primaryHover: 'hover:bg-pink-50',
                    primaryLight: 'bg-pink-100',
                    primaryDark: 'text-pink-800'
                } : {
                    primary: 'from-blue-500 to-blue-600',
                    primaryBg: 'bg-blue-500',
                    primaryText: 'text-blue-600',
                    primaryBorder: 'border-blue-200',
                    primaryHover: 'hover:bg-blue-50',
                    primaryLight: 'bg-blue-100',
                    primaryDark: 'text-blue-800'
                };
            };



            // Calculs statistiques
            const getFilteredEntries = (period) => {
                const now = new Date();
                let startDate, endDate;

                switch (period) {
                    case 'daily':
                        startDate = getDayStart(now);
                        endDate = getDayEnd(now);
                        break;
                    case 'yesterday':
                        const yesterday = new Date(now);
                        yesterday.setDate(yesterday.getDate() - 1);
                        startDate = getDayStart(yesterday);
                        endDate = getDayEnd(yesterday);
                        break;

                    case 'weekly':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 7);
                        endDate = new Date(now);
                        break;
                    case 'monthly':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 30);
                        endDate = new Date(now);
                        break;
                    default:
                        return [];
                }

                return entries.filter(entry => {
                    const entryDate = new Date(entry.timestamp);
                    return entryDate >= startDate && entryDate <= endDate;
                });
            };

            const getStats = (period) => {
                const now = new Date();
                let startDate, endDate;

                switch (period) {
                    case 'daily':
                        startDate = getDayStart(now);
                        endDate = getDayEnd(now);
                        break;
                    case 'weekly':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 7);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = getDayEnd(now);
                        break;
                    case 'monthly':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 30);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = getDayEnd(now);
                        break;
                    default:
                        return { totalMilk: 0, totalPees: 0, totalPoops: 0, feedingCount: 0 };
                }

                const filteredEntries = entries.filter(entry => {
                    const entryDate = new Date(entry.timestamp);
                    return entryDate >= startDate && entryDate <= endDate;
                });

                const feedings = filteredEntries.filter(entry => entry.type === 'feeding');
                const totalMilk = feedings.reduce((sum, entry) => sum + parseInt(entry.amount || 0), 0);
                const totalPees = filteredEntries.filter(entry => entry.hasPee).length;
                const totalPoops = filteredEntries.filter(entry => entry.hasPoop).length;

                return { totalMilk, totalPees, totalPoops, feedingCount: feedings.length };
            };
            // Fonctions pour les statistiques analytics
            const getFeedingStats = () => {
                const filtered = getFilteredEntries(analyticsPeriod);
                const feedings = filtered.filter(e => e.type === 'feeding');
                const total = feedings.reduce((sum, e) => sum + parseInt(e.amount || 0), 0);
                const count = feedings.length;
                const average = count > 0 ? Math.round(total / count) : 0;
                return { total, count, average };
            };

            const getDiaperStats = () => {
                const filtered = getFilteredEntries(analyticsPeriod);
                const pees = filtered.filter(e => e.hasPee).length;
                const poops = filtered.filter(e => e.hasPoop).length;
                const total = pees + poops;
                return { pees, poops, total };
            };
            const getBreastfeedingStatsForAnalytics = () => {
                const now = new Date();
                let startDate, endDate;

                switch (analyticsPeriod) {
                    case 'daily':
                        startDate = getDayStart(now);
                        endDate = getDayEnd(now);
                        break;
                    case 'yesterday':
                        const yesterday = new Date(now);
                        yesterday.setDate(yesterday.getDate() - 1);
                        startDate = getDayStart(yesterday);
                        endDate = getDayEnd(yesterday);
                        break;
                    case 'weekly':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 6);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = getDayEnd(now);
                        break;
                    case 'monthly':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 29);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = getDayEnd(now);
                        break;
                }

                const filtered = breastfeedingEntries.filter(entry => {
                    const entryDate = new Date(entry.timestamp);
                    return entryDate >= startDate && entryDate <= endDate && entry.status === 'completed';
                });

                const sessions = filtered.length;
                const totalMinutes = filtered.reduce((sum, e) => sum + (e.duration || 0), 0);
                const averageMinutes = sessions > 0 ? Math.round(totalMinutes / sessions) : 0;
                return { sessions, totalMinutes, averageMinutes };
            };

            const getBreastPumpStatsForAnalytics = () => {
                const now = new Date();
                let startDate, endDate;

                switch (analyticsPeriod) {
                    case 'daily':
                        startDate = getDayStart(now);
                        endDate = getDayEnd(now);
                        break;
                    case 'yesterday':
                        const yesterday = new Date(now);
                        yesterday.setDate(yesterday.getDate() - 1);
                        startDate = getDayStart(yesterday);
                        endDate = getDayEnd(yesterday);
                        break;
                    case 'weekly':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 6);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = getDayEnd(now);
                        break;
                    case 'monthly':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 29);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = getDayEnd(now);
                        break;
                }

                const filtered = breastPumpEntries.filter(entry => {
                    const entryDate = new Date(entry.timestamp);
                    return entryDate >= startDate && entryDate <= endDate;
                });

                const sessions = filtered.length;
                const totalVolume = filtered.reduce((sum, e) => sum + (e.volume || 0), 0);
                const averageVolume = sessions > 0 ? Math.round(totalVolume / sessions) : 0;
                return { sessions, totalVolume, averageVolume };
            };
            const getSleepStats = () => {
                const now = new Date();
                let startDate, endDate;

                switch (analyticsPeriod) {
                    case 'daily':
                        startDate = getDayStart(now);
                        endDate = getDayEnd(now);
                        break;
                    case 'yesterday':
                        const yesterday = new Date(now);
                        yesterday.setDate(yesterday.getDate() - 1);
                        startDate = getDayStart(yesterday);
                        endDate = getDayEnd(yesterday);
                        break;
                    case 'weekly':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 6);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = getDayEnd(now);
                        break;
                    case 'monthly':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 29);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = getDayEnd(now);
                        break;
                }

                const filtered = sleepSessions.filter(session => {
                    const sessionDate = new Date(session.startTime);
                    return sessionDate >= startDate && sessionDate <= endDate && session.status === 'completed';
                });

                const sessions = filtered.length;
                const totalMinutes = filtered.reduce((sum, s) => sum + (s.duration || 0), 0);
                const totalHours = Math.round(totalMinutes / 60 * 10) / 10;
                const averageHours = sessions > 0 ? Math.round(totalMinutes / sessions / 60 * 10) / 10 : 0;
                return { sessions, totalHours, averageHours };
            };
            // Filtrage de l'historique avec pagination
            const getFilteredHistory = () => {
                const now = new Date();
                let startDate, endDate;

                switch (historyFilter) {
                    case 'today':
                        startDate = getDayStart(now);
                        endDate = getDayEnd(now);
                        break;
                    case 'yesterday':
                        const yesterday = new Date(now);
                        yesterday.setDate(yesterday.getDate() - 1);
                        startDate = getDayStart(yesterday);
                        endDate = getDayEnd(yesterday);
                        break;
                    case 'week':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 7);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = getDayEnd(now);
                        break;
                    default:
                        startDate = new Date(0);
                        endDate = new Date();
                }

                // Fonction helper pour parser les timestamps correctement
                const parseTimestamp = (timestamp) => {
                    if (!timestamp) return null;

                    // Si le timestamp contient dÃ©jÃ  un fuseau horaire, l'utiliser tel quel
                    if (timestamp.includes('Z') || timestamp.includes('+') || timestamp.includes('-')) {
                        return new Date(timestamp);
                    }

                    // Sinon, le traiter comme heure locale
                    return new Date(timestamp);
                };

                // Fonction helper pour vÃ©rifier si une date est dans la plage
                const isInDateRange = (timestamp, start, end) => {
                    const date = parseTimestamp(timestamp);
                    if (!date || isNaN(date.getTime())) return false;
                    return date >= start && date <= end;
                };



                // Filtrer les entrÃ©es normales (biberon, couche)
                const filteredEntries = entries.filter(entry => {
                    const parsedDate = parseTimestamp(entry.timestamp);
                    const inRange = isInDateRange(entry.timestamp, startDate, endDate);



                    return inRange;
                });

                // Filtrer les sessions de sommeil terminÃ©es
                const filteredSleep = sleepSessions.filter(session => {
                    if (!session.startTime || session.status !== 'completed') return false;
                    const inRange = isInDateRange(session.startTime, startDate, endDate);
                    console.log('Sleep:', session.startTime, 'in range:', inRange);
                    return inRange;
                }).map(session => ({
                    ...session,
                    type: 'sleep',
                    timestamp: session.startTime
                }));

                // Filtrer les tÃ©tÃ©es terminÃ©es
                const filteredBreastfeeding = breastfeedingEntries.filter(entry => {
                    if (!entry.timestamp || entry.status !== 'completed') return false;
                    const inRange = isInDateRange(entry.timestamp, startDate, endDate);
                    console.log('Breastfeeding:', entry.timestamp, 'in range:', inRange);
                    return inRange;
                }).map(entry => ({
                    ...entry,
                    type: 'breastfeeding',
                    timestamp: entry.timestamp
                }));

                // Filtrer les sessions tire-lait
                const filteredBreastPump = breastPumpEntries.filter(entry => {
                    if (!entry.timestamp) return false;
                    const inRange = isInDateRange(entry.timestamp, startDate, endDate);
                    console.log('Breast pump:', entry.timestamp, 'in range:', inRange);
                    return inRange;
                }).map(entry => ({
                    ...entry,
                    type: 'breast_pump',
                    timestamp: entry.timestamp
                }));

                const totalFiltered = filteredEntries.length + filteredSleep.length +
                    filteredBreastfeeding.length + filteredBreastPump.length;


                // Combiner et trier par timestamp (plus rÃ©cent en premier)
                const allEntries = [...filteredEntries, ...filteredSleep, ...filteredBreastfeeding, ...filteredBreastPump];

                return allEntries.sort((a, b) => {
                    const dateA = parseTimestamp(a.timestamp);
                    const dateB = parseTimestamp(b.timestamp);
                    return dateB - dateA;
                });
            };
            // VÃ©rification connexion au chargement
            useEffect(() => {
                const savedCode = localStorage.getItem('familyCode');

                if (savedCode) {
                    // Utilisateur existant - connexion automatique
                    setAuthData(prev => ({ ...prev, code: savedCode }));
                    handleLogin(savedCode);
                    setShowOnboarding(false);
                    setShowAuth(false);
                } else {
                    // Nouvel utilisateur - afficher Ã©cran d'authentification
                    setShowAuth(true);
                    setShowOnboarding(false);
                }
            }, []);
            // Ã‰coute des donnÃ©es Firebase
            useEffect(() => {
                if (!user) return;

                const familyCode = user.code;
                const unsubscribers = [];

                // Ã‰coute des entrÃ©es filtrÃ©es par famille
                const entriesUnsubscribe = db.collection('entries')
                    .where('familyCode', '==', familyCode)
                    .orderBy('timestamp', 'desc')
                    .onSnapshot((snapshot) => {
                        const entriesData = [];
                        snapshot.forEach((doc) => {
                            entriesData.push({ id: doc.id, ...doc.data() });
                        });
                        setEntries(entriesData);
                        localStorage.setItem('babyTrackerEntries', JSON.stringify(entriesData));
                    });
                unsubscribers.push(entriesUnsubscribe);

                // Charger les accomplissements depuis Firebase
                // Ã‰couter les accomplissements en temps rÃ©el depuis Firebase
                const accomplishmentsUnsubscribe = db.collection('families').doc(user.code)
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const userData = doc.data();
                            if (userData.accomplishments) {
                                setAccomplishments(userData.accomplishments);
                                console.log('Accomplissements chargÃ©s:', userData.accomplishments);
                            } else {
                                // Initialiser avec un objet vide si pas encore d'accomplissements
                                setAccomplishments({});
                                console.log('Aucun accomplissement trouvÃ©, initialisation');
                            }
                        }
                    }, (error) => {
                        console.error('Erreur Ã©coute accomplissements:', error);
                    });

                unsubscribers.push(accomplishmentsUnsubscribe);


                // Ã‰coute des stocks filtrÃ©s par famille
                const stocksUnsubscribe = db.collection('stocks')
                    .where('familyCode', '==', familyCode)
                    .onSnapshot((snapshot) => {
                        const stocksData = {};
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            stocksData[data.type] = data;
                        });
                        setStocks(stocksData);
                    });
                unsubscribers.push(stocksUnsubscribe);



                // Ã‰coute de la diversification filtrÃ©e par famille
                const diversificationUnsubscribe = db.collection('diversification')
                    .where('familyCode', '==', familyCode)
                    .orderBy('timestamp', 'desc')
                    .onSnapshot((snapshot) => {
                        const diversificationData = [];
                        snapshot.forEach((doc) => {
                            diversificationData.push({ id: doc.id, ...doc.data() });
                        });
                        setDiversificationEntries(diversificationData);
                    });
                unsubscribers.push(diversificationUnsubscribe);

                // Ã‰coute de la garde-robe filtrÃ©e par famille
                const wardrobeUnsubscribe = db.collection('wardrobe')
                    .where('familyCode', '==', familyCode)
                    .orderBy('timestamp', 'desc')
                    .onSnapshot((snapshot) => {
                        const wardrobeData = [];
                        snapshot.forEach((doc) => {
                            wardrobeData.push({ id: doc.id, ...doc.data() });
                        });
                        setWardrobe(wardrobeData);
                    });

                // Ã‰coute du sommeil filtrÃ© par famille
                const sleepUnsubscribe = db.collection('sleep_sessions')
                    .where('familyCode', '==', familyCode)
                    .onSnapshot((snapshot) => {
                        const sleepData = [];
                        let ongoingSession = null;

                        snapshot.forEach((doc) => {
                            const sessionData = { id: doc.id, ...doc.data() };
                            sleepData.push(sessionData);

                            if (sessionData.status === 'ongoing') {
                                ongoingSession = sessionData;
                            }
                        });

                        // Trier cÃ´tÃ© client
                        sleepData.sort((a, b) => new Date(b.timestamp || b.startTime) - new Date(a.timestamp || a.startTime));

                        console.log('Sessions chargÃ©es depuis Firebase:', sleepData);
                        setSleepSessions(sleepData);
                        setCurrentSleep(ongoingSession);
                    });
                unsubscribers.push(sleepUnsubscribe);
                // Ã‰coute de l'allaitement filtrÃ© par famille
                // Ã‰coute de l'allaitement filtrÃ© par famille
                const breastfeedingUnsubscribe = db.collection('breastfeeding')
                    .where('familyCode', '==', familyCode)
                    .orderBy('timestamp', 'desc')
                    .onSnapshot((snapshot) => {
                        const breastfeedingData = [];
                        let ongoingSession = null;

                        snapshot.forEach((doc) => {
                            const sessionData = { id: doc.id, ...doc.data() };
                            breastfeedingData.push(sessionData);

                            if (sessionData.status === 'ongoing') {
                                ongoingSession = sessionData;
                            }
                        });

                        setBreastfeedingEntries(breastfeedingData);
                        setBreastfeedingSession(ongoingSession);
                    });
                unsubscribers.push(breastfeedingUnsubscribe);

                // Ã‰coute de la liste de cadeaux
                const giftsUnsubscribe = db.collection('gifts')
                    .where('familyCode', '==', familyCode)
                    .orderBy('timestamp', 'desc')
                    .onSnapshot((snapshot) => {
                        const giftsData = [];
                        snapshot.forEach((doc) => {
                            giftsData.push({ id: doc.id, ...doc.data() });
                        });
                        setGiftList(giftsData);
                    });
                unsubscribers.push(giftsUnsubscribe);
                // Ã‰coute du tire-lait filtrÃ© par famille
                const breastPumpUnsubscribe = db.collection('breast_pump')
                    .where('familyCode', '==', familyCode)
                    .orderBy('timestamp', 'desc')
                    .onSnapshot((snapshot) => {
                        const breastPumpData = [];
                        snapshot.forEach((doc) => {
                            breastPumpData.push({ id: doc.id, ...doc.data() });
                        });
                        setBreastPumpEntries(breastPumpData);
                    });
                unsubscribers.push(breastPumpUnsubscribe);
                unsubscribers.push(wardrobeUnsubscribe);

                return () => {
                    unsubscribers.forEach(unsubscribe => unsubscribe());
                };
            }, [user]);
            // Mise Ã  jour du graphique
            useEffect(() => {
                if (currentView === 'daily' && chartRef.current && entries.length > 0) {
                    updateChart();
                }
            }, [entries, currentView, periodView]);
            // Mise Ã  jour du graphique sommeil
            useEffect(() => {
                if (currentView === 'sleep-tracker' && sleepChartRef.current && sleepSessions.length > 0) {
                    updateSleepChart();
                }
            }, [sleepSessions, currentView, sleepPeriodView]);
            // Fermer le menu "Plus" quand on clique ailleurs
            useEffect(() => {
                const handleClickOutside = (event) => {
                    // GÃ©rer le menu Plus
                    if (showPlusMenu) {
                        const plusButton = event.target.closest('[data-menu="plus"]');
                        const plusContainer = event.target.closest('.relative[data-menu="plus"]');
                        if (!plusButton && !plusContainer) {
                            setShowPlusMenu(false);
                        }
                    }

                    // GÃ©rer le menu More
                    if (showMoreMenu) {
                        const moreButton = event.target.closest('[data-menu="more"]');
                        if (!moreButton) {
                            setShowMoreMenu(false);
                        }
                    }
                };

                document.addEventListener('mousedown', handleClickOutside);
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [showMoreMenu, showPlusMenu]);
            // Calcul du prochain biberon
            useEffect(() => {
                if (entries.length === 0) {
                    setNextFeedingInfo(null);
                    return;
                }

                const lastFeeding = entries
                    .filter(entry => entry.type === 'feeding')
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];

                if (lastFeeding) {
                    const lastFeedingTime = new Date(lastFeeding.timestamp);
                    const nextFeedingTime = new Date(lastFeedingTime.getTime() + (feedingInterval * 60 * 60 * 1000));

                    setNextFeedingInfo({
                        lastFeeding: lastFeedingTime,
                        nextTime: nextFeedingTime
                    });
                } else {
                    setNextFeedingInfo(null);
                }
            }, [entries, feedingInterval]);
            // Charger les soins depuis Firebase
            useEffect(() => {
                if (!user) return;

                const today = getCurrentDate();

                // Ã‰couter les changements en temps rÃ©el
                const unsubscribe = db.collection('daily_care')
                    .doc(`${user.code}_${today}`)
                    .onSnapshot(async (doc) => {
                        if (doc.exists) {
                            const data = doc.data();

                            // VÃ©rifier que les donnÃ©es sont bien du jour actuel
                            if (data.date === today) {
                                console.log('Chargement soins du jour:', data.care);
                            } else {
                                // DonnÃ©es d'un autre jour, rÃ©initialiser
                                console.log('RÃ©initialisation des soins pour nouveau jour');
                                const freshCare = {
                                    cordon: {
                                        active: data.care?.cordon?.active ?? true,
                                        morning_done: false,
                                        evening_done: false,
                                        last_updated: null
                                    },
                                    visage: { done: false, last_updated: null },
                                    vitamines: { done: false, last_updated: null }
                                };
                                await saveDailyCareToFirebase(freshCare, today);
                            }
                        } else {
                            // Aucune donnÃ©e pour aujourd'hui, crÃ©er l'initial
                            console.log('CrÃ©ation initiale des soins');
                            const initialCare = {
                                cordon: {
                                    active: true,
                                    morning_done: false,
                                    evening_done: false,
                                    last_updated: null
                                },
                                visage: { done: false, last_updated: null },
                                vitamines: { done: false, last_updated: null }
                            };
                            await saveDailyCareToFirebase(initialCare, today);
                        }
                    }, (error) => {
                        console.error('Erreur chargement soins:', error);
                    });

                return () => unsubscribe();
            }, [user]);
            // Initialiser les notifications
            useEffect(() => {
                if ('Notification' in window) {
                    setNotificationPermission(Notification.permission);

                    // Si dÃ©jÃ  autorisÃ©, programmer les notifications
                    if (Notification.permission === 'granted' && user) {
                        scheduleAllNotifications();
                    }
                }
            }, []);

            // Reprogrammer quand les donnÃ©es changent
            useEffect(() => {
                if (notificationPermission === 'granted' && user) {
                    scheduleAllNotifications();
                }
            }, [user, entries, notificationPermission]);

            // Cleanup au dÃ©montage
            useEffect(() => {
                return () => {
                    clearAllNotifications();
                };
            }, []);
            // Reprogrammer les notifications quand une nouvelle entrÃ©e est ajoutÃ©e
            useEffect(() => {
                if (notificationPermission === 'granted' && user) {
                    // Attendre un peu pour que les donnÃ©es soient mises Ã  jour
                    setTimeout(() => {
                        scheduleNextFeedingNotification();
                    }, 1000);
                }
            }, [entries.length]);

            // VÃ©rifier permission au chargement
            useEffect(() => {
                if ('Notification' in window) {
                    setNotificationPermission(Notification.permission);
                }
            }, []);

            useEffect(() => {
                // DÃ©tection iOS pour les notifications
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

                if (isIOS) {
                    // Message spÃ©cifique pour iOS
                    console.log('iOS dÃ©tectÃ© - PWA mode');

                    // VÃ©rifier si l'app est en mode PWA
                    const isStandalone = window.navigator.standalone === true;
                    if (!isStandalone) {
                        // SuggÃ©rer d'ajouter Ã  l'Ã©cran d'accueil aprÃ¨s 5 secondes
                        // setTimeout(() => {
                        //     if (window.confirm('Pour une meilleure expÃ©rience, ajoutez BabyTrack Ã  votre Ã©cran d\'accueil !')) {
                        //         showCustomAlert('Appuyez sur le bouton Partager puis "Sur l\'Ã©cran d\'accueil"');
                        //     }
                        // }, 5000);
                    }
                }
            }, []);
            // Fonction helper pour afficher les alertes
            const showCustomAlert = (message, type = 'info') => {
                setCustomAlert({ message, type });
            };
            // Authentification
            const handleCreateAccount = async () => {
                const { babyName, birthDate, birthTime, birthWeight, birthHeight, parents, gender } = authData;

                if (!babyName || !birthDate) {
                    showCustomAlert('Nom du bÃ©bÃ© et date de naissance obligatoires');
                    return;
                }

                const familyCode = generateCode();
                const familyData = {
                    code: familyCode,
                    babyName,
                    birthDate: authData.birthDate,
                    birthTime: birthTime || '06:00',
                    birthWeight: parseFloat(birthWeight) || 3.290,
                    birthHeight: parseInt(birthHeight) || 48,
                    parents: parents || 'Papa & Maman',
                    gender: gender,
                    accomplishments: {}, // Initialiser avec un objet vide
                    createdAt: new Date().toISOString()
                };
                try {
                    await db.collection('families').doc(familyCode).set(familyData);
                    showCustomAlert(`Famille crÃ©Ã©e avec succÃ¨s!\n\nCode famille: ${familyCode}\n\nNotez bien ce code!`);

                    setUser(familyData);
                    localStorage.setItem('familyCode', familyCode);
                    setShowAuth(false);
                } catch (error) {
                    console.error('Erreur crÃ©ation:', error);
                    showCustomAlert('Erreur lors de la crÃ©ation du compte');
                }
            };

            const handleLogin = async (code = authData.code) => {
                if (!code || code.length !== 6) {
                    showCustomAlert('Code famille invalide (6 caractÃ¨res requis)');
                    return;
                }

                try {
                    console.log('Tentative de connexion avec le code:', code.toUpperCase());

                    const doc = await db.collection('families').doc(code.toUpperCase()).get();

                    if (doc.exists) {
                        const userData = doc.data();
                        console.log('DonnÃ©es utilisateur trouvÃ©es:', userData);

                        setUser(userData);
                        setCurrentPlan(userData.currentPlan || 'Freemium'); // Ajouter cette ligne

                        // Charger les infos d'essai
                        if (userData.trialInfo) {
                            setTrialInfo(userData.trialInfo);

                            if (userData.trialInfo.isActive) {
                                const remaining = calculateTimeRemaining(userData.trialInfo.endDate);
                                setTrialTimeRemaining(remaining);
                                setShowTrialBanner(!!remaining);

                                if (!remaining) {
                                    setTimeout(() => switchToFreemium(), 1000);
                                }
                            }
                        }
                        localStorage.setItem('familyCode', code.toUpperCase());
                        setShowAuth(false);
                        console.log('Connexion rÃ©ussie');
                    } else {
                        console.log('Code famille introuvable dans la base');
                        showCustomAlert('Code famille introuvable. VÃ©rifiez le code ou crÃ©ez un nouveau compte.');
                    }
                } catch (error) {
                    console.error('Erreur connexion dÃ©taillÃ©e:', error);
                    showCustomAlert(`Erreur de connexion: ${error.message || 'Erreur inconnue'}`);
                }
            };
            const joinWithInviteFromAuth = async () => {
                const inviteCode = authData.inviteCode;

                if (!inviteCode || inviteCode.length < 10) {
                    showCustomAlert('Code d\'invitation invalide');
                    return;
                }

                try {
                    const inviteDoc = await db.collection('invites').doc(inviteCode).get();

                    if (!inviteDoc.exists) {
                        showCustomAlert('Code d\'invitation introuvable');
                        return;
                    }

                    const inviteData = inviteDoc.data();

                    if (inviteData.used) {
                        showCustomAlert('Ce code d\'invitation a dÃ©jÃ  Ã©tÃ© utilisÃ©');
                        return;
                    }

                    if (new Date() > new Date(inviteData.expiresAt)) {
                        showCustomAlert('Ce code d\'invitation a expirÃ©');
                        return;
                    }

                    // VÃ©rifier la limite d'utilisateurs
                    const familyDoc = await db.collection('families').doc(inviteData.familyCode).get();
                    if (!familyDoc.exists) {
                        showCustomAlert('Famille introuvable');
                        return;
                    }

                    const familyData = familyDoc.data();

                    if ((familyData.connectedUsers?.length || 1) >= (familyData.maxUsers || 1)) {
                        showCustomAlert('Ce compte a atteint sa limite d\'utilisateurs');
                        return;
                    }

                    // Ajouter l'utilisateur
                    await db.collection('families').doc(inviteData.familyCode).update({
                        connectedUsers: [...(familyData.connectedUsers || []), {
                            joinedAt: new Date().toISOString(),
                            inviteCode: inviteCode,
                            joinedVia: 'invitation'
                        }]
                    });

                    // Marquer l'invitation comme utilisÃ©e
                    await db.collection('invites').doc(inviteCode).update({
                        used: true,
                        usedAt: new Date().toISOString()
                    });

                    // Connecter l'utilisateur au compte
                    localStorage.setItem('familyCode', inviteData.familyCode);
                    setUser(familyData);
                    setCurrentPlan(familyData.currentPlan || 'Freemium');

                    // Charger les infos d'essai si nÃ©cessaire
                    if (familyData.trialInfo) {
                        setTrialInfo(familyData.trialInfo);
                        if (familyData.trialInfo.isActive) {
                            const remaining = calculateTimeRemaining(familyData.trialInfo.endDate);
                            setTrialTimeRemaining(remaining);
                            setShowTrialBanner(!!remaining);
                        }
                    }

                    setShowAuth(false);
                    showCustomAlert(`Bienvenue dans le compte de ${familyData.babyName} !`);

                } catch (error) {
                    console.error('Erreur invitation:', error);
                    showCustomAlert('Erreur lors de l\'utilisation de l\'invitation');
                }
            };

            // Fonctions d'exportation

            async function exportToPDF() {
                // VÃ©rification que user existe
                if (!user) {
                    showCustomAlert('Erreur : donnÃ©es utilisateur manquantes');
                    return;
                }
                setIsExporting(true);

                try {
                    const stats = getStats(exportPeriod === "day" ? "daily" : exportPeriod === "week" ? "weekly" : "monthly");

                    const now = new Date();
                    let startDate, endDate, periodLabel;
                    switch (exportPeriod) {
                        case "day":
                            startDate = getDayStart(now);
                            endDate = getDayEnd(now);
                            periodLabel = "Rapport du jour";
                            break;
                        case "week":
                            startDate = new Date(now);
                            startDate.setDate(startDate.getDate() - 7);
                            startDate.setHours(0, 0, 0, 0);
                            endDate = getDayEnd(now);
                            periodLabel = "Rapport hebdomadaire";
                            break;
                        case "month":
                            startDate = new Date(now);
                            startDate.setDate(startDate.getDate() - 30);
                            startDate.setHours(0, 0, 0, 0);
                            endDate = getDayEnd(now);
                            periodLabel = "Rapport mensuel";
                            break;
                    }

                    const exportEntries = entries.filter(entry => {
                        const entryDate = new Date(entry.timestamp);
                        return entryDate >= startDate && entryDate <= endDate;
                    });

                    // Ajouter les donnÃ©es d'allaitement
                    const exportBreastfeeding = breastfeedingEntries.filter(entry => {
                        const entryDate = new Date(entry.timestamp);
                        return entry.status === 'completed' && entryDate >= startDate && entryDate <= endDate;
                    });

                    // Ajouter les donnÃ©es de tire-lait
                    const exportBreastPump = breastPumpEntries.filter(entry => {
                        const entryDate = new Date(entry.timestamp);
                        return entryDate >= startDate && entryDate <= endDate;
                    });

                    // Ajouter les donnÃ©es de sommeil
                    const exportSleep = sleepSessions.filter(session => {
                        const sessionDate = new Date(session.startTime);
                        return session.status === 'completed' && sessionDate >= startDate && sessionDate <= endDate;
                    });

                    // Combiner toutes les entrÃ©es pour l'historique
                    const allExportEntries = [
                        ...exportEntries.map(e => ({ ...e, type: e.type, timestamp: e.timestamp })),
                        ...exportBreastfeeding.map(e => ({ ...e, type: 'breastfeeding', timestamp: e.timestamp })),
                        ...exportBreastPump.map(e => ({ ...e, type: 'breastpump', timestamp: e.timestamp })),
                        ...exportSleep.map(e => ({ ...e, type: 'sleep', timestamp: e.startTime }))
                    ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    // Contenu HTML pour le PDF
                    const printHTML = `
<div id="pdf-report" style="width:210mm; background:white; padding:20px; font-family:Arial, sans-serif; color:#1a1a1a;">

  <!-- HEADER -->
  <div style="display:flex; align-items:center; border-bottom:3px solid #3B82F6; margin-bottom:20px; padding-bottom:10px;">
    <div style="width:100px;height:100px;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center;margin-right:15px;">
      <img src="logo.PNG" style="width:100%;height:100%;object-fit:cover;" alt="Logo">
    </div>
    <div>
      <h1 style="margin:0;font-size:22px;color:#1e293b;">BabyTrack</h1>
      <p style="margin:0;color:#64748b;font-size:14px;">${user.babyName} - ${periodLabel}</p>
      <p style="margin:0;color:#3B82F6;font-size:12px;">Du ${startDate.toLocaleDateString("fr-FR")} au ${endDate.toLocaleDateString("fr-FR")}</p>
    </div>
  </div>

  <!-- INFOS -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;">
    <div style="background:#f8fafc;border:1px solid #e2e8f0;border-left:4px solid #3B82F6;padding:12px;border-radius:6px;">
      <h3 style="margin:0 0 8px 0;font-size:13px;color:#1e293b;">ðŸ‘¶ Informations du bÃ©bÃ©</h3>
      <p><strong>Nom:</strong> ${user.babyName}</p>
      <p><strong>Ã‚ge:</strong> ${formatAgeDisplay(calculateAge())}</p>
      <p><strong>Poids:</strong> ${currentWeight || user.birthWeight}kg</p>
      <p><strong>Taille:</strong> ${currentHeight || user.birthHeight}cm</p>
    </div>
    <div style="background:#f8fafc;border:1px solid #e2e8f0;border-left:4px solid #3B82F6;padding:12px;border-radius:6px;">
      <h3 style="margin:0 0 8px 0;font-size:13px;color:#1e293b;">ðŸ‘ª Informations famille</h3>
      <p><strong>Parents:</strong> ${user.parents}</p>
      <p><strong>Date du rapport:</strong> ${new Date().toLocaleDateString("fr-FR")}</p>
    </div>
  </div>

  <!-- STATS -->
  <div style="margin-bottom:20px;">
    <h2 style="font-size:14px;font-weight:600;color:#1e293b;border-bottom:2px solid #3B82F6;padding-bottom:4px;">ðŸ“Š Statistiques de la pÃ©riode</h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;">
      <div style="text-align:center;padding:12px;background:#f1f5f9;border-radius:6px;border:1px solid #e2e8f0;">
        <span style="font-size:18px;font-weight:bold;color:#3B82F6;">${stats.totalMilk}</span><br>
        <span style="font-size:10px;color:#64748b;">ml de lait</span>
      </div>
      <div style="text-align:center;padding:12px;background:#f1f5f9;border-radius:6px;border:1px solid #e2e8f0;">
        <span style="font-size:18px;font-weight:bold;color:#3B82F6;">${stats.feedingCount}</span><br>
        <span style="font-size:10px;color:#64748b;">biberons</span>
      </div>
      <div style="text-align:center;padding:12px;background:#f1f5f9;border-radius:6px;border:1px solid #e2e8f0;">
        <span style="font-size:18px;font-weight:bold;color:#3B82F6;">${stats.totalPees}</span><br>
        <span style="font-size:10px;color:#64748b;">pipis</span>
      </div>
      <div style="text-align:center;padding:12px;background:#f1f5f9;border-radius:6px;border:1px solid #e2e8f0;">
        <span style="font-size:18px;font-weight:bold;color:#3B82F6;">${stats.totalPoops}</span><br>
        <span style="font-size:10px;color:#64748b;">cacas</span>
      </div>
      ${exportBreastfeeding.length > 0 ? `
      <div style="text-align:center;padding:12px;background:#f1f5f9;border-radius:6px;border:1px solid #e2e8f0;">
        <span style="font-size:18px;font-weight:bold;color:#ec4899;">${exportBreastfeeding.reduce((sum, e) => sum + (e.duration || 0), 0)}</span><br>
        <span style="font-size:10px;color:#64748b;">min d'allaitement</span>
      </div>
      <div style="text-align:center;padding:12px;background:#f1f5f9;border-radius:6px;border:1px solid #e2e8f0;">
        <span style="font-size:18px;font-weight:bold;color:#ec4899;">${exportBreastfeeding.length}</span><br>
        <span style="font-size:10px;color:#64748b;">tÃ©tÃ©es</span>
      </div>` : ''}
      ${exportBreastPump.length > 0 ? `
      <div style="text-align:center;padding:12px;background:#f1f5f9;border-radius:6px;border:1px solid #e2e8f0;">
        <span style="font-size:18px;font-weight:bold;color:#8b5cf6;">${exportBreastPump.reduce((sum, e) => sum + (e.volume || 0), 0)}</span><br>
        <span style="font-size:10px;color:#64748b;">ml tire-lait</span>
      </div>
      <div style="text-align:center;padding:12px;background:#f1f5f9;border-radius:6px;border:1px solid #e2e8f0;">
        <span style="font-size:18px;font-weight:bold;color:#8b5cf6;">${exportBreastPump.length}</span><br>
        <span style="font-size:10px;color:#64748b;">sessions tire-lait</span>
      </div>` : ''}
      ${exportSleep.length > 0 ? `
      <div style="text-align:center;padding:12px;background:#f1f5f9;border-radius:6px;border:1px solid #e2e8f0;">
        <span style="font-size:18px;font-weight:bold;color:#6366f1;">${Math.round(exportSleep.reduce((sum, s) => sum + (s.duration || 0), 0) / 60 * 10) / 10}</span><br>
        <span style="font-size:10px;color:#64748b;">h de sommeil</span>
      </div>
      <div style="text-align:center;padding:12px;background:#f1f5f9;border-radius:6px;border:1px solid #e2e8f0;">
        <span style="font-size:18px;font-weight:bold;color:#6366f1;">${exportSleep.length}</span><br>
        <span style="font-size:10px;color:#64748b;">sessions sommeil</span>
      </div>` : ''}
    </div>
  </div>

  <!-- HISTORIQUE -->
  ${allExportEntries.length > 0 ? `
  <div style="margin-bottom:20px;">
    <h2 style="font-size:14px;font-weight:600;color:#1e293b;border-bottom:2px solid #3B82F6;padding-bottom:4px;">ðŸ“‹ Historique dÃ©taillÃ© (15 derniÃ¨res entrÃ©es)</h2>
    ${allExportEntries
                                .slice(0, 15)
                                .map(entry => {
                                    const time = new Date(entry.timestamp).toLocaleString("fr-FR");

                                    if (entry.type === "feeding") {
                                        return `
<div style="display:flex;align-items:center;padding:8px 12px;margin-bottom:8px;background:#f9fafb;border-radius:8px;border-left:4px solid #3B82F6;">
  <div style="min-width:120px;font-size:12px;font-weight:600;color:#3B82F6;">${time}</div>
  <div style="color:#3B82F6;padding:4px 12px;font-size:12px;font-weight:700;margin-right:12px;">BIBERON</div>
  <div style="font-size:12px;color:#374151;font-weight:500;">QuantitÃ©: ${entry.amount}ml</div>
</div>`;
                                    }
                                    else if (entry.type === "diaper") {
                                        const details = [];
                                        if (entry.hasPee) details.push("Pipi");
                                        if (entry.hasPoop) {
                                            let poopDetails = "Caca";
                                            if (entry.poopQuantity || entry.poopConsistency || entry.poopColor) {
                                                const poopInfo = [];
                                                if (entry.poopQuantity) poopInfo.push(entry.poopQuantity);
                                                if (entry.poopConsistency) poopInfo.push(entry.poopConsistency);
                                                if (entry.poopColor) poopInfo.push(entry.poopColor);
                                                poopDetails = `Caca (${poopInfo.join(', ')})`;
                                            }
                                            details.push(poopDetails);
                                        }
                                        return `
<div style="display:flex;align-items:center;padding:8px 12px;margin-bottom:8px;background:#f9fafb;border-radius:8px;border-left:4px solid #10b981;">
  <div style="min-width:120px;font-size:12px;font-weight:600;color:#3B82F6;">${time}</div>
  <div style="color:#10b981;padding:4px 12px;font-size:12px;font-weight:700;margin-right:12px;">CHANGE</div>
  <div style="font-size:12px;color:#374151;font-weight:500;">${details.join(" + ")}</div>
</div>`;
                                    }
                                    else if (entry.type === "breastfeeding") {
                                        return `
<div style="display:flex;align-items:center;padding:8px 12px;margin-bottom:8px;background:#f9fafb;border-radius:8px;border-left:4px solid #ec4899;">
  <div style="min-width:120px;font-size:12px;font-weight:600;color:#3B82F6;">${time}</div>
  <div style="color:#ec4899;padding:4px 12px;font-size:12px;font-weight:700;margin-right:12px;">TÃ‰TÃ‰E</div>
  <div style="font-size:12px;color:#374151;font-weight:500;">${entry.breast === 'left' ? 'Sein gauche' : entry.breast === 'right' ? 'Sein droit' : 'Les deux seins'}${entry.duration ? ` - ${entry.duration}min` : ''}</div>
</div>`;
                                    }
                                    else if (entry.type === "breastpump") {
                                        return `
<div style="display:flex;align-items:center;padding:8px 12px;margin-bottom:8px;background:#f9fafb;border-radius:8px;border-left:4px solid #8b5cf6;">
  <div style="min-width:120px;font-size:12px;font-weight:600;color:#3B82F6;">${time}</div>
  <div style="color:#8b5cf6;padding:4px 12px;font-size:12px;font-weight:700;margin-right:12px;">TIRE-LAIT</div>
  <div style="font-size:12px;color:#374151;font-weight:500;">${entry.volume}ml en ${entry.duration}min</div>
</div>`;
                                    }
                                    else if (entry.type === "sleep") {
                                        const durationMinutes = entry.duration || 0;
                                        const hours = Math.floor(durationMinutes / 60);
                                        const mins = durationMinutes % 60;
                                        const durationText = hours > 0 ? `${hours}h${mins.toString().padStart(2, '0')}` : `${mins}min`;
                                        return `
<div style="display:flex;align-items:center;padding:8px 12px;margin-bottom:8px;background:#f9fafb;border-radius:8px;border-left:4px solid #6366f1;">
  <div style="min-width:120px;font-size:12px;font-weight:600;color:#3B82F6;">${time}</div>
  <div style="color:#6366f1;padding:4px 12px;font-size:12px;font-weight:700;margin-right:12px;">SOMMEIL</div>
  <div style="font-size:12px;color:#374151;font-weight:500;">DurÃ©e: ${durationText}</div>
</div>`;
                                    }
                                    return "";
                                })
                                .join("")}
  </div>` : ""}

</div>
`;

                    // Ajout temporaire au DOM
                    const container = document.createElement("div");
                    container.innerHTML = printHTML;
                    document.body.appendChild(container);

                    const element = container.querySelector("#pdf-report");

                    // Conversion en canvas puis PDF
                    const canvas = await html2canvas(element, { scale: 2 });
                    const imgData = canvas.toDataURL("image/png");

                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF("p", "mm", "a4");
                    const imgWidth = 210;
                    const pageHeight = 297;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save(`Rapport_${periodLabel}_${new Date().toLocaleDateString("fr-FR")}.pdf`);

                    // Nettoyage
                    document.body.removeChild(container);
                    setShowExportMenu(false);
                } catch (error) {
                    console.error("Erreur export PDF:", error);
                    showCustomAlert("Erreur lors de l'export PDF");
                } finally {
                    setIsExporting(false);
                }
            }
            const logout = () => {
                setUser(null);
                localStorage.removeItem('familyCode');
                localStorage.removeItem('hasSeenOnboarding');
                setShowAuth(true);
                setShowOnboarding(false);
                setAuthMode('login');
            };
            // Fonction de debug pour changer de plan (Ã  retirer en production)
            // Fonction de debug pour changer de plan (Ã  retirer en production)
            const debugChangePlan = (newPlan) => {
                const isDevelopment = window.location.hostname === 'localhost' ||
                    window.location.hostname === '127.0.0.1' ||
                    window.location.hostname.includes('local');

                if (isDevelopment) {
                    setCurrentPlan(newPlan);
                    setUser(prev => ({ ...prev, currentPlan: newPlan }));

                    // Mettre Ã  jour Firebase
                    db.collection('families').doc(user.code).update({
                        currentPlan: newPlan,
                        debugMode: true
                    }).catch(console.error);

                    console.log(`Plan changÃ© vers: ${newPlan}`);
                }
            };
            // Ajouter ce bouton temporaire dans le header (ligne ~1315 aprÃ¨s le bouton dÃ©connexion)
            {
                (() => {
                    const isDevelopment = window.location.hostname === 'localhost' ||
                        window.location.hostname === '127.0.0.1' ||
                        window.location.hostname.includes('local');
                    return isDevelopment && (
                        <div className="mt-2">
                            <select
                                onChange={(e) => debugChangePlan(e.target.value)}
                                value={currentPlan}
                                className="text-xs p-1 border rounded"
                            >
                                <option value="Freemium">Plan dÃ©couverte</option>
                                <option value="Solo">Solo</option>
                                <option value="Premium">Plan VIP</option>
                                <option value="Parentale">Parentale</option>
                                <option value="Familial">Familial</option>
                            </select>
                        </div>
                    );
                })()
            }
            // Fonctions pour l'onboarding
            const startFreeTrial = async (planType = 'Solo') => {
                const startDate = new Date();
                const endDate = new Date();
                endDate.setDate(endDate.getDate() + 7);

                const trialData = {
                    isActive: true,
                    startDate: startDate.toISOString(),
                    endDate: endDate.toISOString(),
                    plan: planType
                };

                setTrialInfo(trialData);
                setCurrentPlan(planType);

                // CrÃ©er le compte avec essai gratuit
                const familyCode = generateCode();
                const familyData = {
                    code: familyCode,
                    babyName: onboardingData.babyName,
                    birthDate: onboardingData.birthDate,
                    birthTime: '06:00',
                    birthWeight: parseFloat(onboardingData.birthWeight) || 3.290,
                    birthHeight: parseFloat(onboardingData.birthHeight) || 48,
                    parents: 'Papa & Maman',
                    gender: onboardingData.gender,
                    photo: onboardingData.photo,
                    trialInfo: trialData,
                    currentPlan: planType,
                    maxUsers: planType === 'Solo' ? 1 : planType === 'Parentale' ? 2 : planType === 'Familial' ? 4 : 1,
                    connectedUsers: [{ joinedAt: new Date().toISOString() }],
                    accomplishments: {},
                    feedingMode: onboardingData.feedingMode,
                    createdAt: new Date().toISOString()
                };

                try {
                    await db.collection('families').doc(familyCode).set(familyData);
                    setUser(familyData);
                    localStorage.setItem('familyCode', familyCode);
                    localStorage.setItem('hasSeenOnboarding', 'true');
                    setShowOnboarding(false);
                    setShowAuth(false);
                    setShowTrialBanner(true);
                } catch (error) {
                    console.error('Erreur crÃ©ation compte essai:', error);
                    showCustomAlert('Erreur lors de la crÃ©ation du compte');
                }
            };
            const startFreemiumAccount = async () => {
                const familyCode = generateCode();
                const familyData = {
                    code: familyCode,
                    babyName: onboardingData.babyName,
                    birthDate: onboardingData.birthDate,
                    birthTime: '06:00',
                    birthWeight: parseFloat(onboardingData.birthWeight) || 3.290,
                    birthHeight: parseFloat(onboardingData.birthHeight) || 48,
                    parents: 'Papa & Maman',
                    gender: onboardingData.gender,
                    photo: onboardingData.photo,
                    trialInfo: { isActive: false, plan: 'Freemium' },
                    currentPlan: 'Freemium',
                    accomplishments: {},
                    feedingMode: onboardingData.feedingMode,
                    createdAt: new Date().toISOString()
                };

                try {
                    await db.collection('families').doc(familyCode).set(familyData);
                    setUser(familyData);
                    setCurrentPlan('Freemium');
                    localStorage.setItem('familyCode', familyCode);
                    localStorage.setItem('hasSeenOnboarding', 'true');
                    setShowOnboarding(false);
                    setShowAuth(false);
                } catch (error) {
                    console.error('Erreur crÃ©ation compte Freemium:', error);
                    showCustomAlert('Erreur lors de la crÃ©ation du compte');
                }
            };
            const nextOnboardingStep = () => {
                setOnboardingStep(prev => prev + 1);
            };

            const prevOnboardingStep = () => {
                setOnboardingStep(prev => Math.max(0, prev - 1));
            };
            // Fonctions pour la gestion de l'essai gratuit
            const calculateTimeRemaining = (endDate) => {
                const now = new Date();
                const end = new Date(endDate);
                const diff = end - now;

                if (diff <= 0) return null;

                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                return { days, hours, minutes, total: diff };
            };

            const formatTimeRemaining = (timeObj) => {
                if (!timeObj) return "Essai terminÃ©";

                if (timeObj.days > 0) {
                    return `${timeObj.days}j ${timeObj.hours}h restantes`;
                } else if (timeObj.hours > 0) {
                    return `${timeObj.hours}h ${timeObj.minutes}min restantes`;
                } else {
                    return `${timeObj.minutes}min restantes`;
                }
            };

            const switchToFreemium = async () => {
                try {
                    const freemiumData = {
                        isActive: false,
                        plan: 'Freemium',
                        switchedAt: new Date().toISOString()
                    };

                    await db.collection('families').doc(user.code).update({
                        trialInfo: freemiumData,
                        currentPlan: 'Freemium'
                    });

                    setTrialInfo(freemiumData);
                    setCurrentPlan('Freemium');
                    setShowTrialBanner(false);

                    // Notification de passage en Freemium
                    showCustomAlert(`L'essai gratuit est terminÃ© ! Vous Ãªtes maintenant sur le plan dÃ©couverte avec les fonctionnalitÃ©s de base.`);
                } catch (error) {
                    console.error('Erreur passage Freemium:', error);
                }
            };

            const generateInviteCode = async () => {
                console.log('=== DÃ©but generateInviteCode ===');
                console.log('User:', user);

                if (!user) {
                    console.log('Pas d\'utilisateur connectÃ©');
                    showCustomAlert('Erreur : aucun utilisateur connectÃ©');
                    return;
                }

                console.log('Utilisateurs connectÃ©s:', user.connectedUsers?.length || 1);
                console.log('Limite utilisateurs:', user.maxUsers || 1);

                // VÃ©rifier si on peut encore inviter
                if ((user.connectedUsers?.length || 1) >= (user.maxUsers || 1)) {
                    console.log('Limite atteinte');
                    showCustomAlert('Vous avez atteint la limite d\'utilisateurs pour votre plan');
                    return;
                }

                const inviteCode = `${user.code}-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
                console.log('Code gÃ©nÃ©rÃ©:', inviteCode);

                try {
                    console.log('Tentative de sauvegarde dans Firebase...');

                    const inviteData = {
                        familyCode: user.code,
                        createdBy: user.code,
                        createdAt: new Date().toISOString(),
                        expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                        used: false,
                        planType: user.currentPlan
                    };

                    console.log('DonnÃ©es Ã  sauvegarder:', inviteData);

                    await db.collection('invites').doc(inviteCode).set(inviteData);
                    console.log('Sauvegarde rÃ©ussie');

                    setGeneratedInviteCode(inviteCode);
                    console.log('Code stockÃ© dans l\'Ã©tat');

                    // Test simple sans partage d'abord
                    showCustomAlert(`Code gÃ©nÃ©rÃ© : ${inviteCode}`);

                } catch (error) {
                    console.error('Erreur gÃ©nÃ©ration invitation:', error);
                    showCustomAlert('Erreur lors de la gÃ©nÃ©ration du code: ' + error.message);
                }
            };
            const copyToClipboard = (text) => {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => {
                        showCustomAlert('Code d\'invitation copiÃ© dans le presse-papiers !');
                    }).catch(() => {
                        // Fallback si Ã©chec
                        fallbackCopyToClipboard(text);
                    });
                } else {
                    fallbackCopyToClipboard(text);
                }
            };

            const fallbackCopyToClipboard = (text) => {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showCustomAlert('Code d\'invitation copiÃ© !');
                } catch (err) {
                    showCustomAlert('Impossible de copier automatiquement. Copiez manuellement : ' + text);
                }
                document.body.removeChild(textArea);
            };
            const joinWithInvite = async (inviteCode) => {
                console.log('=== DÃ©but joinWithInvite ===');
                console.log('Code reÃ§u:', inviteCode);

                // Nettoyer le code : enlever espaces et tirets
                const cleanCode = inviteCode.trim().replace(/[-\s]/g, '');
                console.log('Code nettoyÃ©:', cleanCode);

                if (!cleanCode || cleanCode.length < 6) {
                    showCustomAlert('Code d\'invitation trop court (minimum 6 caractÃ¨res)');
                    return;
                }

                try {
                    // Chercher le code avec ou sans tiret
                    let inviteDoc = await db.collection('invites').doc(inviteCode.toUpperCase()).get();

                    // Si pas trouvÃ©, essayer avec le code nettoyÃ©
                    if (!inviteDoc.exists) {
                        inviteDoc = await db.collection('invites').doc(cleanCode.toUpperCase()).get();
                    }

                    if (!inviteDoc.exists) {
                        showCustomAlert('Code d\'invitation introuvable. VÃ©rifiez le code.');
                        return;
                    }

                    const inviteData = inviteDoc.data();

                    if (inviteData.used) {
                        showCustomAlert('Ce code d\'invitation a dÃ©jÃ  Ã©tÃ© utilisÃ©');
                        return;
                    }

                    if (new Date() > new Date(inviteData.expiresAt)) {
                        showCustomAlert('Ce code d\'invitation a expirÃ©');
                        return;
                    }

                    const familyDoc = await db.collection('families').doc(inviteData.familyCode).get();

                    if (!familyDoc.exists) {
                        showCustomAlert('Famille introuvable');
                        return;
                    }

                    const familyData = familyDoc.data();
                    const currentUsers = familyData.connectedUsers?.length || 1;
                    const maxUsers = familyData.maxUsers || 1;

                    if (currentUsers >= maxUsers) {
                        showCustomAlert('Ce compte a atteint sa limite d\'utilisateurs');
                        return;
                    }

                    await db.collection('families').doc(inviteData.familyCode).update({
                        connectedUsers: [...(familyData.connectedUsers || []), {
                            joinedAt: new Date().toISOString(),
                            inviteCode: inviteCode,
                            joinedVia: 'invitation'
                        }]
                    });

                    await db.collection('invites').doc(inviteDoc.id).update({
                        used: true,
                        usedAt: new Date().toISOString()
                    });

                    localStorage.setItem('familyCode', inviteData.familyCode);
                    setUser(familyData);
                    setCurrentPlan(familyData.currentPlan || 'Freemium');

                    if (familyData.trialInfo) {
                        setTrialInfo(familyData.trialInfo);
                        if (familyData.trialInfo.isActive) {
                            const remaining = calculateTimeRemaining(familyData.trialInfo.endDate);
                            setTrialTimeRemaining(remaining);
                            setShowTrialBanner(!!remaining);
                        }
                    }

                    setInviteCodeInput('');
                    setShowAuth(false);
                    showCustomAlert(`Bienvenue dans le compte de ${familyData.babyName} !`, 'success');

                } catch (error) {
                    console.error('Erreur invitation:', error);
                    showCustomAlert('Erreur lors de l\'utilisation de l\'invitation: ' + error.message);
                }
            };
            const cancelTrial = async () => {
                if (!confirm('ÃŠtes-vous sÃ»r de vouloir annuler votre essai gratuit ? Vous passerez au plan dÃ©couverte.')) {
                    return;
                }

                await switchToFreemium();
            };
            // Fonctions pour les limitations Freemium
            const isFeatureLocked = (feature) => {
                // Seul le plan Freemium est limitÃ©
                if (currentPlan !== 'Freemium') return false;

                const lockedFeatures = [
                    'analytics',
                    'export-pdf',
                    'accomplishments',
                    'full-history',
                    'advanced-charts',
                    'diversification',
                    'stocks',
                    'wardrobe',
                    'gifts',

                    'sleep-tracking',
                    'growth-charts',
                    'medication-tracking'
                ];
                return lockedFeatures.includes(feature);
            };
            const getFreemiumHistory = () => {
                if (currentPlan !== 'Freemium') return getFilteredHistory();

                // Limiter Ã  48h pour Freemium
                const now = new Date();
                const fortyEightHoursAgo = new Date(now.getTime() - (48 * 60 * 60 * 1000));

                const allEntries = getFilteredHistory();
                return allEntries.filter(entry => {
                    const entryDate = new Date(entry.timestamp);
                    return entryDate >= fortyEightHoursAgo;
                });
            };

            const showUpgradeMessage = (featureName) => {
                showCustomAlert(`ðŸ”’ ${featureName}" est disponible avec un plan payant.\n\nVotre plan dÃ©couverte vous permet de dÃ©couvrir BabyTrack avec les fonctionnalitÃ©s de base.\n\nPassez Ã  un plan VIP pour dÃ©bloquer toutes les fonctionnalitÃ©s !`);
            };
            // Composant de publicitÃ© pour Freemium
            const FreemiumAd = () => {
                const themeColors = user?.gender === 'girl' ? {
                    primaryLight: 'bg-pink-100',
                    primaryText: 'text-pink-600'
                } : {
                    primaryLight: 'bg-blue-100',
                    primaryText: 'text-blue-600'
                };

                return (
                    <div className="bg-gradient-to-r from-gray-100 to-gray-200 rounded-2xl p-4 shadow-lg border-2 border-dashed border-gray-300 mb-4">
                        <div className="text-center">
                            <div className="text-xs text-gray-500 mb-2 font-medium">SPONSORISÃ‰</div>
                            <div className={`w-12 h-12 mx-auto ${themeColors.primaryLight} rounded-xl flex items-center justify-center mb-3`}>
                                <i className={`fas fa-star ${themeColors.primaryText}`}></i>
                            </div>
                            <h4 className="font-bold text-gray-800 mb-1">DÃ©bloquez tout BabyTrack</h4>
                            <p className="text-sm text-gray-600 mb-3">Historique illimitÃ©, analytics avancÃ©es, export PDF...</p>
                            <button
                                onClick={() => showUpgradeMessage('Version complÃ¨te')}
                                className="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-xl text-sm font-medium active:scale-95 transition-transform"
                            >
                                Voir les plans
                            </button>
                        </div>
                    </div>
                );
            };
            // Gestion des entrÃ©es
            const openForm = (type) => {
                setFormType(type);
                setEditingId(null);
                setFormData({
                    time: getCurrentTime(),
                    date: getCurrentDate(),
                    amount: '',
                    hasPee: false,
                    hasPoop: false,
                    poopQuantity: '',
                    poopConsistency: '',
                    poopColor: ''
                });

                setShowForm(true);
            };

            const editEntry = (entryId) => {
                const entry = entries.find(e => e.id === entryId);
                if (!entry) return;

                setEditingId(entryId);
                setFormType(entry.type);

                const entryDate = new Date(entry.timestamp);
                setFormData({
                    time: entryDate.toTimeString().slice(0, 5),
                    date: entryDate.toISOString().slice(0, 10),
                    amount: entry.amount || '',
                    hasPee: entry.hasPee || false,
                    hasPoop: entry.hasPoop || false,
                    poopQuantity: entry.poopQuantity || '',
                    poopConsistency: entry.poopConsistency || '',
                    poopColor: entry.poopColor || ''
                });

                setShowForm(true);
            };

            const closeForm = () => {
                setShowForm(false);
                setFormType('');
                setEditingId(null);
            };

            const saveEntry = async () => {
                const { time, date, amount, hasPee, hasPoop, poopQuantity, poopConsistency, poopColor } = formData;

                if (!time || !date) {
                    showCustomAlert('Heure et date obligatoires');
                    return;
                }

                if (formType === 'feeding' && !amount) {
                    showCustomAlert('QuantitÃ© obligatoire pour le biberon');
                    return;
                }

                if (formType === 'diaper' && !hasPee && !hasPoop) {
                    showCustomAlert('Indiquez au moins pipi ou caca');
                    return;
                }

                const entry = {
                    type: formType,
                    // CORRECTION ICI : CrÃ©er le timestamp sans conversion UTC automatique
                    timestamp: `${date}T${time}:00`,
                    familyCode: user.code,
                    hasPee,
                    hasPoop,
                    poopQuantity,
                    poopConsistency,
                    poopColor
                };

                if (formType === 'feeding') {
                    entry.amount = parseInt(amount);
                }

                try {
                    if (editingId) {
                        await db.collection('entries').doc(editingId).update(entry);
                    } else {
                        await db.collection('entries').add(entry);
                    }
                    closeForm();
                } catch (error) {
                    console.error('Erreur sauvegarde:', error);
                    showCustomAlert('Erreur lors de la sauvegarde');
                }
            };
            const deleteEntry = async (entryId) => {
                if (!confirm('Supprimer cette entrÃ©e ?')) return;

                try {
                    await db.collection('entries').doc(entryId).delete();
                } catch (error) {
                    console.error('Erreur suppression:', error);
                }
            };

            // Fonctions allaitement
            const startBreastfeeding = async (breast) => {
                const now = new Date().toISOString();
                const session = {
                    familyCode: user.code,
                    breast: breast,
                    startTime: now,
                    endTime: null,
                    duration: null,
                    timestamp: now,
                    status: 'ongoing'
                };

                try {
                    const docRef = await db.collection('breastfeeding').add(session);
                    setBreastfeedingSession({ id: docRef.id, ...session });
                    setShowBreastfeedingModal(false);
                } catch (error) {
                    console.error('Erreur dÃ©marrage allaitement:', error);
                    showCustomAlert('Erreur lors du dÃ©marrage');
                }
            };

            const stopBreastfeeding = async () => {
                if (!breastfeedingSession) return;

                const now = new Date().toISOString();
                const startTime = new Date(breastfeedingSession.startTime);
                const endTime = new Date(now);
                const durationMs = endTime - startTime;
                const durationMinutes = Math.max(1, Math.floor(durationMs / (1000 * 60)));

                const updatedSession = {
                    endTime: now,
                    duration: durationMinutes,
                    status: 'completed',
                    timestamp: now
                };

                try {
                    await db.collection('breastfeeding').doc(breastfeedingSession.id).update(updatedSession);
                    setBreastfeedingSession(null);
                } catch (error) {
                    console.error('Erreur arrÃªt allaitement:', error);
                    showCustomAlert('Erreur lors de l\'arrÃªt');
                }
            };

            const saveBreastfeedingManual = async () => {
                const { breast, duration, notes } = breastfeedingData;

                if (!breast || !duration) {
                    showCustomAlert('Veuillez remplir tous les champs obligatoires');
                    return;
                }

                const entry = {
                    familyCode: user.code,
                    breast: breast,
                    duration: parseInt(duration),
                    notes: notes,
                    timestamp: new Date().toISOString(),
                    status: 'completed'
                };

                try {
                    await db.collection('breastfeeding').add(entry);
                    setBreastfeedingData({ breast: 'left', duration: '', notes: '' });
                    setShowBreastfeedingModal(false);
                } catch (error) {
                    console.error('Erreur sauvegarde allaitement:', error);
                    showCustomAlert('Erreur lors de la sauvegarde');
                }
            };

            // Fonctions tire-lait
            const saveBreastPumpEntry = async () => {
                const { volume, duration, storage, notes } = breastPumpData;

                if (!volume || !duration) {
                    showCustomAlert('Volume et durÃ©e obligatoires');
                    return;
                }

                const entry = {
                    familyCode: user.code,
                    volume: parseInt(volume),
                    duration: parseInt(duration),
                    storage: storage,
                    notes: notes,
                    timestamp: new Date().toISOString()
                };

                try {
                    await db.collection('breast_pump').add(entry);
                    setBreastPumpData({ volume: '', duration: '', storage: 'fridge', notes: '' });
                    setShowBreastPumpModal(false);
                } catch (error) {
                    console.error('Erreur sauvegarde tire-lait:', error);
                    showCustomAlert('Erreur lors de la sauvegarde');
                }
            };
            // Fonctions pour poids et taille
            const saveWeight = async () => {
                if (!weightInput || isNaN(weightInput)) {
                    showCustomAlert('Veuillez entrer un poids valide');
                    return;
                }

                try {
                    await db.collection('families').doc(user.code).update({
                        currentWeight: parseFloat(weightInput),
                        lastWeightUpdate: new Date().toISOString()
                    });

                    setUser(prev => ({ ...prev, currentWeight: parseFloat(weightInput) }));
                    setCurrentWeight(parseFloat(weightInput));
                    setLastWeightUpdate(new Date().toISOString());

                    setWeightInput('');
                    setShowWeightModal(false);
                } catch (error) {
                    console.error('Erreur sauvegarde poids:', error);
                    showCustomAlert('Erreur lors de la sauvegarde');
                }
            };

            const saveHeight = async () => {
                if (!heightInput || isNaN(heightInput)) {
                    showCustomAlert('Veuillez entrer une taille valide');
                    return;
                }

                try {
                    await db.collection('families').doc(user.code).update({
                        birthHeight: parseFloat(heightInput)
                    });

                    setUser(prev => ({ ...prev, birthHeight: parseFloat(heightInput) }));
                    setCurrentHeight(parseFloat(heightInput));
                    setLastHeightUpdate(new Date().toISOString());

                    setHeightInput('');
                    setShowHeightModal(false);
                } catch (error) {
                    console.error('Erreur sauvegarde taille:', error);
                    showCustomAlert('Erreur lors de la sauvegarde');
                }
            };
            const deleteBreastfeedingEntry = async (entryId) => {
                if (!confirm('Supprimer cette tÃ©tÃ©e ?')) return;
                try {
                    await db.collection('breastfeeding').doc(entryId).delete();
                } catch (error) {
                    console.error('Erreur suppression allaitement:', error);
                }
            };
            // Fonction pour sauvegarder les soins quotidiens
            const saveDailyCareToFirebase = async (careData, date) => {
                try {
                    await db.collection('daily_care').doc(`${user.code}_${date}`).set({
                        care: careData,
                        date: date,
                        familyCode: user.code,
                        timestamp: new Date().toISOString()
                    });
                    console.log('Soins sauvegardÃ©s avec succÃ¨s');
                } catch (error) {
                    console.error('Erreur sauvegarde soins:', error);
                    throw error;
                }
            };

            const deleteBreastPumpEntry = async (entryId) => {
                if (!confirm('Supprimer cette session de tire-lait ?')) return;
                try {
                    await db.collection('breast_pump').doc(entryId).delete();
                } catch (error) {
                    console.error('Erreur suppression tire-lait:', error);
                }
            };
            // Gestion de la diversification
            const saveDiversificationEntry = async () => {
                const { category, food, quantity, notes } = diversificationData;

                if (!category || !food || !quantity) {
                    showCustomAlert('CatÃ©gorie, aliment et quantitÃ© obligatoires');
                    return;
                }

                const entry = {
                    category,
                    food,
                    quantity,
                    notes,
                    timestamp: new Date().toISOString(),
                    familyCode: user.code
                };

                try {
                    await db.collection('diversification').add(entry);
                    setDiversificationData({ category: '', food: '', quantity: '', notes: '' });

                } catch (error) {
                    console.error('Erreur sauvegarde diversification:', error);
                    showCustomAlert('Erreur lors de la sauvegarde');
                }
            };
            const deleteDiversificationEntry = async (entryId) => {
                if (!confirm('Supprimer cette entrÃ©e ?')) return;

                try {
                    await db.collection('diversification').doc(entryId).delete();
                } catch (error) {
                    console.error('Erreur suppression diversification:', error);
                }
            };
            // Gestion de la garde-robe
            const saveWardrobeItem = async () => {
                const { type, size, quantity, notes } = wardrobeData;

                if (!type || !size) {
                    showCustomAlert('Type de vÃªtement et taille obligatoires');
                    return;
                }

                const item = {
                    type,
                    size,
                    quantity: parseInt(quantity),
                    notes,
                    familyCode: user.code,
                    timestamp: new Date().toISOString()
                };

                try {
                    if (editingWardrobeId) {
                        await db.collection('wardrobe').doc(editingWardrobeId).update(item);
                    } else {
                        await db.collection('wardrobe').add(item);
                    }
                    setWardrobeData({ type: '', size: '', quantity: 1, notes: '' });
                    setEditingWardrobeId(null);
                } catch (error) {
                    console.error('Erreur sauvegarde garde-robe:', error);
                    showCustomAlert('Erreur lors de la sauvegarde');
                }
            };
            const deleteWardrobeItem = async (itemId) => {
                if (!confirm('Supprimer cet article ?')) return;

                try {
                    await db.collection('wardrobe').doc(itemId).delete();
                } catch (error) {
                    console.error('Erreur suppression garde-robe:', error);
                }
            };
            const exportWardrobeToPDF = async () => {
                setIsExporting(true);

                try {
                    const groupedBySize = {};
                    wardrobe.forEach(item => {
                        if (!groupedBySize[item.size]) {
                            groupedBySize[item.size] = [];
                        }
                        groupedBySize[item.size].push(item);
                    });

                    const sizes = Object.keys(groupedBySize).sort((a, b) => {
                        const sizeOrder = ['Naissance', '1 mois', '3 mois', '6 mois', '9 mois', '12 mois', '18 mois', '2 ans', '3 ans'];
                        return sizeOrder.indexOf(a) - sizeOrder.indexOf(b);
                    });

                    const printHTML = `
<div style="width:210mm; background:white; padding:20px; font-family:Arial, sans-serif;">
  <div style="text-align:center; margin-bottom:30px;">
    <img src="logo.PNG" style="width:80px; height:80px; border-radius:12px; margin-bottom:15px;" alt="Logo">
    <h1 style="margin:0; color:#1e293b;">Garde-robe de ${user.babyName}</h1>
    <p style="color:#64748b;">Inventaire des vÃªtements</p>
  </div>

  ${sizes.map(size => `
    <div style="margin-bottom:25px;">
      <h2 style="color:#1e293b; font-size:18px; margin:0 0 15px 0; padding-bottom:8px; border-bottom:2px solid #3b82f6;">
        Taille ${size} (${groupedBySize[size].length} article${groupedBySize[size].length > 1 ? 's' : ''})
      </h2>
      <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;">
        ${groupedBySize[size].map(item => `
          <div style="border:1px solid #e2e8f0; border-radius:8px; padding:12px; background:#f9fafb;">
            <div style="font-weight:bold; color:#1e293b; margin-bottom:4px;">${item.type}</div>
            <div style="color:#3b82f6; font-size:14px; margin-bottom:4px;">QuantitÃ©: ${item.quantity}</div>
            ${item.notes ? `<div style="color:#64748b; font-size:12px;">${item.notes}</div>` : ''}
          </div>
        `).join('')}
      </div>
    </div>
  `).join('')}

  <div style="margin-top:30px; padding-top:20px; border-top:2px solid #e2e8f0; text-align:center; color:#64748b; font-size:12px;">
    <p>GÃ©nÃ©rÃ© le ${new Date().toLocaleDateString('fr-FR')}</p>
  </div>
</div>`;

                    const container = document.createElement("div");
                    container.innerHTML = printHTML;
                    document.body.appendChild(container);

                    const element = container.querySelector("div");
                    const canvas = await html2canvas(element, { scale: 2 });
                    const imgData = canvas.toDataURL("image/png");

                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF("p", "mm", "a4");
                    const imgWidth = 210;
                    const pageHeight = 297;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save(`Garde-robe_${user.babyName}_${new Date().toLocaleDateString('fr-FR')}.pdf`);
                    document.body.removeChild(container);
                } catch (error) {
                    console.error("Erreur export PDF:", error);
                    showCustomAlert("Erreur lors de l'export PDF");
                } finally {
                    setIsExporting(false);
                }
            };
            // Fonctions pour la liste de cadeaux
            const saveGift = async () => {
                const { url, name, price, image, notes } = giftData;

                if (!url || !name || !price) {
                    showCustomAlert('URL, nom et prix obligatoires', 'warning');
                    return;
                }

                const gift = {
                    url,
                    name,
                    price,
                    image: image || '', // S'assurer que c'est une chaÃ®ne vide si null
                    notes: notes || '',
                    reserved: false,
                    familyCode: user.code,
                    timestamp: new Date().toISOString()
                };

                try {
                    if (editingGiftId) {
                        await db.collection('gifts').doc(editingGiftId).update(gift);
                    } else {
                        await db.collection('gifts').add(gift);
                    }

                    // RÃ©initialiser le formulaire
                    setGiftData({ url: '', name: '', price: '', image: '', reserved: false, notes: '' });
                    setEditingGiftId(null);
                    setShowGiftModal(false);

                    showCustomAlert('Cadeau ajoutÃ© avec succÃ¨s !', 'success');
                } catch (error) {
                    console.error('Erreur sauvegarde cadeau:', error);
                    showCustomAlert('Erreur lors de la sauvegarde: ' + error.message, 'error');
                }
            };
            const deleteGift = async (giftId) => {
                if (!confirm('Supprimer ce cadeau de la liste ?')) return;

                try {
                    await db.collection('gifts').doc(giftId).delete();
                } catch (error) {
                    console.error('Erreur suppression cadeau:', error);
                }
            };

            const toggleGiftReserved = async (giftId) => {
                const gift = giftList.find(g => g.id === giftId);
                if (!gift) return;

                try {
                    await db.collection('gifts').doc(giftId).update({
                        reserved: !gift.reserved,
                        reservedAt: !gift.reserved ? new Date().toISOString() : null
                    });
                } catch (error) {
                    console.error('Erreur rÃ©servation:', error);
                }
            };

            const exportGiftListToPDF = async () => {
                setIsExporting(true);

                try {
                    const printHTML = `
<div style="width:210mm; background:white; padding:20px; font-family:Arial, sans-serif;">
  <div style="text-align:center; margin-bottom:30px;">
    <img src="logo.PNG" style="width:80px; height:80px; border-radius:12px; margin-bottom:15px;" alt="Logo">
    <h1 style="margin:0; color:#1e293b;">Liste de cadeaux pour ${user.babyName}</h1>
    <p style="color:#64748b;">IdÃ©es de cadeaux et souhaits</p>
  </div>

  <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:15px;">
    ${giftList.map(gift => `
      <div style="border:2px solid ${gift.reserved ? '#d1d5db' : '#3b82f6'}; border-radius:12px; padding:15px; ${gift.reserved ? 'opacity:0.6; background:#f9fafb;' : ''}">
        ${gift.image ? `<img src="${gift.image}" style="width:100%; height:150px; object-fit:cover; border-radius:8px; margin-bottom:10px;">` : ''}
        <h3 style="margin:0 0 8px 0; color:#1e293b; font-size:16px;">${gift.name}</h3>
        <p style="margin:0 0 8px 0; color:#ef4444; font-size:20px; font-weight:bold;">${gift.price}</p>
        ${gift.notes ? `<p style="margin:0 0 8px 0; color:#64748b; font-size:12px;">${gift.notes}</p>` : ''}
        <p style="margin:0; color:#3b82f6; font-size:11px; word-break:break-all;">${gift.url}</p>
        ${gift.reserved ? '<div style="margin-top:10px; background:#22c55e; color:white; padding:8px; border-radius:8px; text-align:center; font-weight:bold;">âœ“ RÃ‰SERVÃ‰</div>' : ''}
      </div>
    `).join('')}
  </div>

  <div style="margin-top:30px; padding-top:20px; border-top:2px solid #e2e8f0; text-align:center; color:#64748b; font-size:12px;">
    <p>GÃ©nÃ©rÃ© le ${new Date().toLocaleDateString('fr-FR')}</p>
  </div>
</div>`;

                    const container = document.createElement("div");
                    container.innerHTML = printHTML;
                    document.body.appendChild(container);

                    const element = container.querySelector("div");
                    const canvas = await html2canvas(element, { scale: 2 });
                    const imgData = canvas.toDataURL("image/png");

                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF("p", "mm", "a4");
                    const imgWidth = 210;
                    const pageHeight = 297;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save(`Liste_cadeaux_${user.babyName}_${new Date().toLocaleDateString('fr-FR')}.pdf`);
                    document.body.removeChild(container);
                } catch (error) {
                    console.error("Erreur export PDF:", error);
                    showCustomAlert("Erreur lors de l'export PDF");
                } finally {
                    setIsExporting(false);
                }
            };
            // Fonctions pour les stocks
            const saveMilkPowderDate = async () => {
                if (!milkDateInput) {
                    showCustomAlert('Veuillez entrer une date valide');
                    return;
                }

                try {
                    // Supprimer l'ancien s'il existe pour cette famille
                    const existingDocs = await db.collection('stocks')
                        .where('type', '==', 'milk-powder')
                        .where('familyCode', '==', user.code)
                        .get();
                    existingDocs.forEach(doc => doc.ref.delete());

                    await db.collection('stocks').add({
                        type: 'milk-powder',
                        date: milkDateInput,
                        timestamp: new Date().toISOString(),
                        familyCode: user.code
                    });

                    setMilkDateInput('');
                    setShowMilkStockModal(false);
                } catch (error) {
                    console.error('Erreur sauvegarde date lait:', error);
                    showCustomAlert('Erreur lors de la sauvegarde');
                }
            };

            const saveWaterBottleDateTime = async () => {
                if (!waterDateTimeInput) {
                    showCustomAlert('Veuillez entrer une date et heure valides');
                    return;
                }

                try {
                    // Supprimer l'ancien s'il existe pour cette famille
                    const existingDocs = await db.collection('stocks')
                        .where('type', '==', 'water-bottle')
                        .where('familyCode', '==', user.code)
                        .get();
                    existingDocs.forEach(doc => doc.ref.delete());

                    await db.collection('stocks').add({
                        type: 'water-bottle',
                        datetime: waterDateTimeInput,
                        timestamp: new Date().toISOString(),
                        familyCode: user.code
                    });

                    setWaterDateTimeInput('');
                    setShowWaterStockModal(false);
                } catch (error) {
                    console.error('Erreur sauvegarde datetime eau:', error);
                    showCustomAlert('Erreur lors de la sauvegarde');
                }
            };

            // Gestion du sommeil
            const startSleep = async () => {
                const now = new Date().toISOString();
                const sleepSession = {
                    familyCode: user.code,
                    startTime: now,
                    endTime: null,
                    duration: null,
                    timestamp: now,
                    status: 'ongoing'
                };

                try {
                    const docRef = await db.collection('sleep_sessions').add(sleepSession);
                    console.log('Session crÃ©Ã©e avec ID:', docRef.id);
                    console.log('DonnÃ©es envoyÃ©es:', sleepSession); // Debug
                    setCurrentSleep({ id: docRef.id, ...sleepSession });
                } catch (error) {
                    console.error('Erreur dÃ©marrage sommeil:', error);
                    showCustomAlert('Erreur lors du dÃ©marrage');
                }
            };
            const stopSleep = async () => {
                if (!currentSleep) return;

                const now = new Date().toISOString();
                const startTime = new Date(currentSleep.startTime);
                const endTime = new Date(now);
                const durationMs = endTime - startTime;
                const durationMinutes = Math.max(1, Math.floor(durationMs / (1000 * 60)));

                const updatedSession = {
                    endTime: now,
                    duration: durationMinutes,
                    status: 'completed',
                    timestamp: now // Mettre Ã  jour le timestamp
                };

                try {
                    await db.collection('sleep_sessions').doc(currentSleep.id).update(updatedSession);
                    console.log('Session terminÃ©e:', durationMinutes, 'minutes');
                    setCurrentSleep(null);
                } catch (error) {
                    console.error('Erreur arrÃªt sommeil:', error);
                    showCustomAlert('Erreur lors de l\'arrÃªt');
                }
            };
            const saveSleepEdit = async () => {
                const { startTime, endTime, date } = sleepData;

                if (!startTime || !endTime || !date) {
                    showCustomAlert('Veuillez remplir tous les champs');
                    return;
                }

                const start = new Date(`${date}T${startTime}:00`);
                let end = new Date(`${date}T${endTime}:00`);

                // Si l'heure de fin est antÃ©rieure Ã  l'heure de dÃ©but, 
                // on suppose que c'est le lendemain
                if (end <= start) {
                    end.setDate(end.getDate() + 1);
                }

                const durationMs = end - start;
                const durationMinutes = Math.floor(durationMs / (1000 * 60));

                // VÃ©rification que la durÃ©e reste raisonnable (max 15h)
                if (durationMinutes > 900) {
                    showCustomAlert('La durÃ©e de sommeil semble trop longue (plus de 15h). VÃ©rifiez les heures saisies.');
                    return;
                }

                const sleepSession = {
                    familyCode: user.code,
                    startTime: start.toISOString(),
                    endTime: end.toISOString(),
                    duration: durationMinutes,
                    timestamp: start.toISOString(),
                    status: 'completed'
                };

                try {
                    if (editingSleepId) {
                        await db.collection('sleep_sessions').doc(editingSleepId).update(sleepSession);
                    } else {
                        await db.collection('sleep_sessions').add(sleepSession);
                    }

                    setSleepData({ startTime: '', endTime: '', date: getCurrentDate() });
                    setEditingSleepId(null);
                } catch (error) {
                    console.error('Erreur sauvegarde sommeil:', error);
                    showCustomAlert('Erreur lors de la sauvegarde');
                }
            };
            const formatSleepDuration = (minutes) => {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return hours > 0 ? `${hours}h${mins.toString().padStart(2, '0')}` : `${mins}min`;
            };
            // Nouveau graphique croissance Ã  ajouter aprÃ¨s formatSleepDuration
            const GrowthChart = () => {
                const chartRef = useRef(null);
                const chartInstance = useRef(null);

                useEffect(() => {
                    if (!chartRef.current) return;

                    const ctx = chartRef.current.getContext('2d');

                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    // DonnÃ©es de croissance (exemple avec donnÃ©es actuelles)
                    const growthData = [];

                    // Poids de naissance
                    if (user?.birthDate && user?.birthWeight) {
                        growthData.push({
                            date: new Date(user.birthDate),
                            weight: user.birthWeight,
                            height: user.birthHeight || null
                        });
                    }

                    // Poids actuel si disponible
                    if (currentWeight && lastWeightUpdate) {
                        growthData.push({
                            date: new Date(lastWeightUpdate),
                            weight: currentWeight,
                            height: currentHeight || null
                        });
                    }

                    const labels = growthData.map(point =>
                        point.date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })
                    );

                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Poids (kg)',
                                    data: growthData.map(point => point.weight),
                                    borderColor: '#3B82F6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    tension: 0.4,
                                    pointRadius: 5,
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'Taille (cm)',
                                    data: growthData.map(point => point.height),
                                    borderColor: '#10B981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    tension: 0.4,
                                    pointRadius: 5,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: { display: true, text: 'Poids (kg)' },
                                    ticks: { callback: value => value + 'kg' }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: { display: true, text: 'Taille (cm)' },
                                    ticks: { callback: value => value + 'cm' },
                                    grid: { drawOnChartArea: false }
                                }
                            }
                        }
                    });

                    return () => {
                        if (chartInstance.current) {
                            chartInstance.current.destroy();
                        }
                    };
                }, [currentWeight, currentHeight, user]);

                // Mise Ã  jour du graphique analytics
                useEffect(() => {
                    if (currentView === 'analytics' && analyticsChartRef.current && analyticsFilter.length > 0) {
                        setTimeout(() => {
                            updateAnalyticsChart();
                        }, 100);
                    }
                }, [currentView, analyticsFilter, analyticsPeriod, entries, sleepSessions, breastfeedingEntries, breastPumpEntries]);

                // Timer pour l'essai gratuit
                useEffect(() => {
                    if (!user?.trialInfo?.isActive) return;

                    const timer = setInterval(() => {
                        const remaining = calculateTimeRemaining(user.trialInfo.endDate);
                        setTrialTimeRemaining(remaining);

                        if (!remaining) {
                            // Essai terminÃ©, passer en Freemium
                            switchToFreemium();
                            clearInterval(timer);
                        }
                    }, 60000); // VÃ©rifier chaque minute

                    // Calcul initial
                    const initial = calculateTimeRemaining(user.trialInfo.endDate);
                    setTrialTimeRemaining(initial);

                    if (!initial) {
                        switchToFreemium();
                    } else {
                        setShowTrialBanner(true);
                    }

                    return () => clearInterval(timer);
                }, [user?.trialInfo]);
                // Ajoutez cet useEffect aprÃ¨s les autres useEffect (vers ligne 600)
                useEffect(() => {
                    if (user) {
                        // Charger les donnÃ©es de croissance depuis Firebase
                        setCurrentWeight(user.currentWeight || null);
                        setCurrentHeight(user.currentHeight || null);
                        setLastWeightUpdate(user.lastWeightUpdate || null);
                        setLastHeightUpdate(user.lastHeightUpdate || null);
                    }
                }, [user]);
                // Recalcul de l'Ã¢ge quand la date de naissance change
                useEffect(() => {
                    if (user?.birthDate) {
                        const age = calculateAge();
                        console.log('Ã‚ge calculÃ©:', age, 'jours pour', user.babyName);
                    }
                }, [user?.birthDate]);

                // Fonction pour mettre Ã  jour le graphique principal
                const updateAnalyticsChart = () => {
                    if (!analyticsChartRef.current || analyticsFilter.length === 0) return;

                    const ctx = analyticsChartRef.current.getContext('2d');
                    if (analyticsChartInstance.current) {
                        analyticsChartInstance.current.destroy();
                    }

                    const now = new Date();
                    let startDate, endDate, labels = [];

                    // Configuration selon la pÃ©riode
                    switch (analyticsPeriod) {
                        case 'daily':
                            startDate = getDayStart(now);
                            endDate = getDayEnd(now);
                            for (let h = 0; h < 24; h++) {
                                labels.push(`${h}h`);
                            }
                            break;
                        case 'weekly':
                            startDate = new Date(now);
                            startDate.setDate(startDate.getDate() - 6);
                            startDate.setHours(0, 0, 0, 0);
                            endDate = getDayEnd(now);
                            for (let d = 0; d < 7; d++) {
                                const currentDay = new Date(startDate);
                                currentDay.setDate(startDate.getDate() + d);
                                labels.push(currentDay.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' }));
                            }
                            break;
                        case 'monthly':
                            startDate = new Date(now);
                            startDate.setDate(startDate.getDate() - 29);
                            startDate.setHours(0, 0, 0, 0);
                            endDate = getDayEnd(now);
                            for (let d = 0; d < 30; d += 3) {
                                const currentDay = new Date(startDate);
                                currentDay.setDate(startDate.getDate() + d);
                                labels.push(currentDay.getDate().toString());
                            }
                            break;
                    }

                    const datasets = [];

                    // Dataset Biberons
                    if (analyticsFilter.includes('feeding')) {
                        const feedingData = labels.map((_, index) => {
                            if (analyticsPeriod === 'daily') {
                                const hour = index;
                                const hourStart = new Date(startDate);
                                hourStart.setHours(hour, 0, 0, 0);
                                const hourEnd = new Date(startDate);
                                hourEnd.setHours(hour, 59, 59, 999);

                                return entries
                                    .filter(entry => {
                                        const entryDate = new Date(entry.timestamp);
                                        return entry.type === 'feeding' && entryDate >= hourStart && entryDate <= hourEnd;
                                    })
                                    .reduce((sum, entry) => sum + parseInt(entry.amount || 0), 0);
                            } else {
                                const dayIndex = index;
                                const dayStart = new Date(startDate);
                                dayStart.setDate(startDate.getDate() + dayIndex * (analyticsPeriod === 'weekly' ? 1 : 3));
                                const dayEnd = new Date(dayStart);
                                dayEnd.setHours(23, 59, 59, 999);

                                return entries
                                    .filter(entry => {
                                        const entryDate = new Date(entry.timestamp);
                                        return entry.type === 'feeding' && entryDate >= dayStart && entryDate <= dayEnd;
                                    })
                                    .reduce((sum, entry) => sum + parseInt(entry.amount || 0), 0);
                            }
                        });

                        datasets.push({
                            label: 'Biberons (ml)',
                            data: feedingData,
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            pointRadius: 4,
                        });
                    }

                    // Dataset Pipis
                    if (analyticsFilter.includes('diaper-pee')) {
                        const peeData = labels.map((_, index) => {
                            if (analyticsPeriod === 'daily') {
                                const hour = index;
                                const hourStart = new Date(startDate);
                                hourStart.setHours(hour, 0, 0, 0);
                                const hourEnd = new Date(startDate);
                                hourEnd.setHours(hour, 59, 59, 999);

                                return entries.filter(entry => {
                                    const entryDate = new Date(entry.timestamp);
                                    return entry.hasPee && entryDate >= hourStart && entryDate <= hourEnd;
                                }).length;
                            } else {
                                const dayIndex = index;
                                const dayStart = new Date(startDate);
                                dayStart.setDate(startDate.getDate() + dayIndex * (analyticsPeriod === 'weekly' ? 1 : 3));
                                const dayEnd = new Date(dayStart);
                                dayEnd.setHours(23, 59, 59, 999);

                                return entries.filter(entry => {
                                    const entryDate = new Date(entry.timestamp);
                                    return entry.hasPee && entryDate >= dayStart && entryDate <= dayEnd;
                                }).length;
                            }
                        });

                        datasets.push({
                            label: 'Pipis',
                            data: peeData,
                            borderColor: '#06B6D4',
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            tension: 0.4,
                            pointRadius: 4,
                        });
                    }

                    // Dataset Cacas
                    if (analyticsFilter.includes('diaper-poop')) {
                        const poopData = labels.map((_, index) => {
                            if (analyticsPeriod === 'daily') {
                                const hour = index;
                                const hourStart = new Date(startDate);
                                hourStart.setHours(hour, 0, 0, 0);
                                const hourEnd = new Date(startDate);
                                hourEnd.setHours(hour, 59, 59, 999);

                                return entries.filter(entry => {
                                    const entryDate = new Date(entry.timestamp);
                                    return entry.hasPoop && entryDate >= hourStart && entryDate <= hourEnd;
                                }).length;
                            } else {
                                const dayIndex = index;
                                const dayStart = new Date(startDate);
                                dayStart.setDate(startDate.getDate() + dayIndex * (analyticsPeriod === 'weekly' ? 1 : 3));
                                const dayEnd = new Date(dayStart);
                                dayEnd.setHours(23, 59, 59, 999);

                                return entries.filter(entry => {
                                    const entryDate = new Date(entry.timestamp);
                                    return entry.hasPoop && entryDate >= dayStart && entryDate <= dayEnd;
                                }).length;
                            }
                        });

                        datasets.push({
                            label: 'Cacas',
                            data: poopData,
                            borderColor: '#F59E0B',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4,
                            pointRadius: 4,
                        });
                    }

                    analyticsChartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: { labels, datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Valeurs' }
                                }
                            }
                        }
                    });
                };
                const updateAnalyticsCharts = () => {
                    if (analyticsFilter.includes('feeding')) updateFeedingChart();
                    if (analyticsFilter.includes('diaper')) updateDiaperChart();
                    if (analyticsFilter.includes('breastfeeding')) updateBreastfeedingChart();
                    if (analyticsFilter.includes('sleep')) updateSleepAnalyticsChart();
                    if (analyticsFilter.includes('food')) updateFoodChart();
                };
                return (
                    <div className="bg-white/90 rounded-2xl p-4 shadow-xl border border-white/50 mb-4">
                        <h3 className="font-bold text-gray-900 mb-3 flex items-center gap-2">
                            <div className="w-8 h-8 bg-indigo-100 rounded-xl flex items-center justify-center">
                                <i className="fas fa-chart-line text-indigo-600"></i>
                            </div>
                            Ã‰volution de la croissance
                        </h3>
                        <div className="h-48">
                            <canvas ref={chartRef} className="w-full h-full"></canvas>
                        </div>
                    </div>
                );
            };



            const editWardrobeItem = (itemId) => {
                const item = wardrobe.find(w => w.id === itemId);
                if (!item) return;

                setWardrobeData({
                    type: item.type,
                    size: item.size,
                    quantity: item.quantity,
                    notes: item.notes || ''
                });
                setEditingWardrobeId(itemId);
                setShowWardrobeModal(true);
            };
            const editSleepSession = (sessionId) => {
                const session = sleepSessions.find(s => s.id === sessionId);
                if (!session) return;

                const startDate = new Date(session.startTime);
                const endDate = new Date(session.endTime);

                setSleepData({
                    startTime: startDate.toTimeString().slice(0, 5),
                    endTime: endDate.toTimeString().slice(0, 5),
                    date: startDate.toISOString().slice(0, 10)
                });
                setEditingSleepId(sessionId);
                setCurrentView('sleep-manual');
            };

            const deleteSleepSession = async (sessionId) => {
                if (!confirm('Supprimer cette session de sommeil ?')) return;

                try {
                    await db.collection('sleep_sessions').doc(sessionId).delete();
                } catch (error) {
                    console.error('Erreur suppression session:', error);
                    showCustomAlert('Erreur lors de la suppression');
                }
            };



            // Graphique quotidien
            const updateChart = () => {
                if (!chartRef.current) return;

                const ctx = chartRef.current.getContext('2d');

                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                const now = new Date();
                let startDate, endDate, filteredFeedings, labels, data, labelFormat;

                // Configuration selon la pÃ©riode
                switch (periodView) {
                    case 'daily':
                        startDate = getDayStart(now);
                        endDate = getDayEnd(now);

                        filteredFeedings = entries.filter(entry => {
                            const entryDate = new Date(entry.timestamp);
                            return entry.type === 'feeding' && entryDate >= startDate && entryDate <= endDate;
                        });

                        // Labels par heure pour la vue quotidienne
                        labels = [];
                        data = [];
                        for (let h = 0; h < 24; h++) {
                            const hourStr = `${h}h`;
                            labels.push(hourStr);

                            let cumulativeMilk = 0;
                            const currentTime = new Date(startDate);
                            currentTime.setHours(h, 59, 59, 999);

                            filteredFeedings.forEach(feeding => {
                                const feedingTime = new Date(feeding.timestamp);
                                if (feedingTime <= currentTime) {
                                    cumulativeMilk += parseInt(feeding.amount || 0);
                                }
                            });

                            data.push(cumulativeMilk);
                        }
                        labelFormat = 'Lait cumulÃ© par heure';
                        break;

                    case 'weekly':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 6);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = getDayEnd(now);

                        filteredFeedings = entries.filter(entry => {
                            const entryDate = new Date(entry.timestamp);
                            return entry.type === 'feeding' && entryDate >= startDate && entryDate <= endDate;
                        });

                        // Labels par jour pour la vue hebdomadaire
                        labels = [];
                        data = [];
                        for (let d = 0; d < 7; d++) {
                            const currentDay = new Date(startDate);
                            currentDay.setDate(startDate.getDate() + d);

                            const dayStart = getDayStart(currentDay);
                            const dayEnd = getDayEnd(currentDay);

                            const dayLabel = currentDay.toLocaleDateString('fr-FR', {
                                weekday: 'short',
                                day: 'numeric'
                            });
                            labels.push(dayLabel);

                            const dayTotal = filteredFeedings
                                .filter(feeding => {
                                    const feedingTime = new Date(feeding.timestamp);
                                    return feedingTime >= dayStart && feedingTime <= dayEnd;
                                })
                                .reduce((sum, feeding) => sum + parseInt(feeding.amount || 0), 0);

                            data.push(dayTotal);
                        }
                        labelFormat = 'Lait total par jour';
                        break;

                    case 'monthly':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 29);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = getDayEnd(now);

                        filteredFeedings = entries.filter(entry => {
                            const entryDate = new Date(entry.timestamp);
                            return entry.type === 'feeding' && entryDate >= startDate && entryDate <= endDate;
                        });

                        // Labels par jour pour la vue mensuelle (plus dÃ©taillÃ©e)
                        labels = [];
                        data = [];
                        for (let d = 0; d < 30; d++) {
                            const currentDay = new Date(startDate);
                            currentDay.setDate(startDate.getDate() + d);

                            const dayStart = getDayStart(currentDay);
                            const dayEnd = getDayEnd(currentDay);

                            // Afficher que certains jours pour Ã©viter l'encombrement
                            const dayLabel = d % 5 === 0 ? currentDay.getDate().toString() : '';
                            labels.push(dayLabel);

                            const dayTotal = filteredFeedings
                                .filter(feeding => {
                                    const feedingTime = new Date(feeding.timestamp);
                                    return feedingTime >= dayStart && feedingTime <= dayEnd;
                                })
                                .reduce((sum, feeding) => sum + parseInt(feeding.amount || 0), 0);

                            data.push(dayTotal);
                        }
                        labelFormat = 'Lait total par jour';
                        break;

                    default:
                        return;
                }

                chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: labelFormat,
                            data: data,
                            borderColor: user?.gender === 'girl' ? '#ec4899' : '#3B82F6',
                            backgroundColor: user?.gender === 'girl' ? 'rgba(236, 72, 153, 0.1)' : 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: user?.gender === 'girl' ? '#ec4899' : '#3B82F6',
                            pointRadius: periodView === 'daily' ? 2 : periodView === 'monthly' ? 1 : 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    fontSize: 10,
                                    callback: function (value) {
                                        return value + 'ml';
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Volume (ml)'
                                }
                            },
                            x: {
                                ticks: { fontSize: periodView === 'monthly' ? 8 : 10 },
                                title: {
                                    display: true,
                                    text: periodView === 'daily' ? 'Heures' : 'Jours'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return `${context.parsed.y}ml`;
                                    }
                                }
                            }
                        }
                    }
                });
            };
            const updateSleepChart = () => {
                if (!sleepChartRef.current) return;

                const ctx = sleepChartRef.current.getContext('2d');

                if (sleepChartInstance.current) {
                    sleepChartInstance.current.destroy();
                }

                const now = new Date();
                let startDate, endDate, filteredSleep, labels, data;

                switch (sleepPeriodView) {
                    case 'week':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 6);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = getDayEnd(now);

                        filteredSleep = sleepSessions.filter(session => {
                            const sessionDate = new Date(session.startTime);
                            return session.status === 'completed' &&
                                sessionDate >= startDate && sessionDate <= endDate;
                        });

                        // Par jour
                        labels = [];
                        data = [];
                        for (let d = 0; d < 7; d++) {
                            const currentDay = new Date(startDate);
                            currentDay.setDate(startDate.getDate() + d);

                            const dayStart = getDayStart(currentDay);
                            const dayEnd = getDayEnd(currentDay);

                            const dayLabel = currentDay.toLocaleDateString('fr-FR', {
                                weekday: 'short',
                                day: 'numeric'
                            });
                            labels.push(dayLabel);

                            const dayTotal = filteredSleep
                                .filter(session => {
                                    const sessionTime = new Date(session.startTime);
                                    return sessionTime >= dayStart && sessionTime <= dayEnd;
                                })
                                .reduce((sum, session) => sum + (session.duration || 0), 0);

                            data.push(Math.round(dayTotal / 60 * 10) / 10); // Convertir en heures
                        }
                        break;

                    case 'month':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() - 29);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = getDayEnd(now);

                        filteredSleep = sleepSessions.filter(session => {
                            const sessionDate = new Date(session.startTime);
                            return session.status === 'completed' &&
                                sessionDate >= startDate && sessionDate <= endDate;
                        });

                        // Par semaine
                        labels = [];
                        data = [];
                        for (let w = 0; w < 4; w++) {
                            const weekStart = new Date(startDate);
                            weekStart.setDate(startDate.getDate() + (w * 7));
                            const weekEnd = new Date(weekStart);
                            weekEnd.setDate(weekStart.getDate() + 6);
                            weekEnd.setHours(23, 59, 59, 999);

                            labels.push(`S${w + 1}`);

                            const weekTotal = filteredSleep
                                .filter(session => {
                                    const sessionTime = new Date(session.startTime);
                                    return sessionTime >= weekStart && sessionTime <= weekEnd;
                                })
                                .reduce((sum, session) => sum + (session.duration || 0), 0);

                            data.push(Math.round(weekTotal / 60 * 10) / 10); // Convertir en heures
                        }
                        break;
                }

                sleepChartInstance.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Sommeil (heures)',
                            data: data,
                            backgroundColor: 'rgba(147, 51, 234, 0.6)',
                            borderColor: 'rgba(147, 51, 234, 1)',
                            borderWidth: 2,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    fontSize: 8,
                                    callback: function (value) {
                                        return value + 'h';
                                    }
                                }
                            },
                            x: {
                                ticks: { fontSize: 8 }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const hours = Math.floor(context.parsed.y);
                                        const minutes = Math.round((context.parsed.y - hours) * 60);
                                        return `${hours}h${minutes.toString().padStart(2, '0')}`;
                                    }
                                }
                            }
                        }
                    }
                });
            };
            // Fonctions d'information sur les selles
            const getPoopInfo = (quantity, consistency, color) => {
                const quantities = {
                    'peu': { label: 'Un peu', emoji: 'ðŸ¤' },
                    'moyen': { label: 'Moyen', emoji: 'ðŸ‘Œ' },
                    'beaucoup': { label: 'Beaucoup', emoji: 'ðŸ™Œ' }
                };

                const consistencies = {
                    'liquide': { label: 'Liquide', emoji: 'ðŸ’§' },
                    'molle': { label: 'Molle', emoji: 'ðŸŸ¡' },
                    'normale': { label: 'Normale', emoji: 'ðŸŸ¤' },
                    'dure': { label: 'Dure', emoji: 'ðŸ”´' }
                };

                const colors = {
                    'noir': { label: 'Noir', emoji: 'âš«', bgColor: 'bg-gray-800', textColor: 'text-white' },
                    'marron': { label: 'Marron', emoji: 'ðŸŸ¤', bgColor: 'bg-amber-700', textColor: 'text-white' },
                    'vert': { label: 'Vert', emoji: 'ðŸŸ¢', bgColor: 'bg-green-600', textColor: 'text-white' },
                    'jaune': { label: 'Jaune', emoji: 'ðŸŸ¡', bgColor: 'bg-yellow-400', textColor: 'text-gray-800' }
                };

                return {
                    quantity: quantities[quantity] || { label: '', emoji: '' },
                    consistency: consistencies[consistency] || { label: '', emoji: '' },
                    color: colors[color] || { label: '', emoji: '', bgColor: 'bg-orange-100', textColor: 'text-orange-800' }
                };
            };


            // Calculer les recommandations alimentaires
            const age = calculateAge();
            const themeColors = getThemeColors();
            // Composant d'onboarding avec le style de l'app
            const OnboardingFlow = () => {
                const themeColors = onboardingData.gender === 'girl' ? {
                    primary: 'from-pink-500 to-pink-600',
                    primaryBg: 'bg-pink-500',
                    primaryLight: 'bg-pink-100',
                    primaryText: 'text-pink-600',
                    primaryBorder: 'border-pink-200'
                } : {
                    primary: 'from-blue-500 to-blue-600',
                    primaryBg: 'bg-blue-500',
                    primaryLight: 'bg-blue-100',
                    primaryText: 'text-blue-600',
                    primaryBorder: 'border-blue-200'
                };

                const steps = [
                    // Ã‰tape 0: Bienvenue
                    {
                        component: (
                            <div className="text-center space-y-6 fade-in">
                                <div className="w-32 h-32 mx-auto mb-6 bg-white rounded-3xl shadow-2xl p-4 flex items-center justify-center">
                                    <img src="logo.PNG" alt="BabyTrack" className="w-full h-full rounded-2xl object-cover" />
                                </div>
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-900 mb-3">
                                        Bienvenue sur BabyTrack
                                    </h1>
                                    <p className="text-lg text-gray-600 mb-8 leading-relaxed">
                                        Votre compagnon intelligent pour suivre chaque moment prÃ©cieux avec bÃ©bÃ©
                                    </p>
                                </div>
                                <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl border border-white/50 mb-8">
                                    <div className="grid grid-cols-2 gap-4 text-center mb-4">
                                        <div>
                                            <div className="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                                                <i className="fas fa-bottle-water text-blue-600 text-xl"></i>
                                            </div>
                                            <div className="text-xs font-medium text-gray-700 leading-tight">Suivi alimentaire</div>
                                        </div>
                                        <div>
                                            <div className="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                                                <i className="fas fa-chart-line text-purple-600 text-xl"></i>
                                            </div>
                                            <div className="text-xs font-medium text-gray-700 leading-tight">Analytics avancÃ©es</div>
                                        </div>
                                        <div>
                                            <div className="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                                                <i className="fas fa-moon text-indigo-600 text-xl"></i>
                                            </div>
                                            <div className="text-xs font-medium text-gray-700 leading-tight">Suivi sommeil</div>
                                        </div>
                                        <div>
                                            <div className="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                                                <i className="fas fa-utensils text-orange-600 text-xl"></i>
                                            </div>
                                            <div className="text-xs font-medium text-gray-700 leading-tight">Diversification</div>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-3 gap-3 text-center">
                                        <div>
                                            <div className="w-10 h-10 bg-pink-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                                                <i className="fas fa-tshirt text-pink-600 text-lg"></i>
                                            </div>
                                            <div className="text-xs font-medium text-gray-700 leading-tight">Garde-robe</div>
                                        </div>
                                        <div>
                                            <div className="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                                                <i className="fas fa-boxes text-green-600 text-lg"></i>
                                            </div>
                                            <div className="text-xs font-medium text-gray-700 leading-tight">Stocks</div>
                                        </div>
                                        <div>
                                            <div className="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                                                <i className="fas fa-file-pdf text-red-600 text-lg"></i>
                                            </div>
                                            <div className="text-xs font-medium text-gray-700 leading-tight">Export PDF</div>
                                        </div>
                                    </div>
                                </div>
                                <button
                                    onClick={nextOnboardingStep}
                                    className="w-full logo-gradient text-white px-8 py-4 rounded-2xl font-bold shadow-xl active:scale-95 transition-transform"                                >
                                    Commencer l'aventure
                                </button>
                            </div>
                        )
                    },
                    // Ã‰tape 1: Nom du bÃ©bÃ©
                    {
                        component: (
                            <div className="text-center space-y-6 fade-in">
                                <div className={`w-20 h-20 mx-auto mb-6 ${themeColors.primaryLight} rounded-2xl flex items-center justify-center transition-all duration-500`}>
                                    <i className="fas fa-baby text-3xl text-gray-600"></i>
                                </div>
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-900 mb-3">
                                        Comment s'appelle votre bÃ©bÃ© ?
                                    </h2>
                                    <p className="text-gray-600 mb-8">
                                        Nous personnaliserons l'expÃ©rience avec ce petit nom
                                    </p>
                                    <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-4 shadow-xl border border-white/50 mb-6">
                                        <input
                                            type="text"
                                            className="w-full px-6 py-4 rounded-xl text-center text-xl font-bold border-2 border-gray-200 focus:border-blue-500 focus:outline-none transition-colors"
                                            placeholder="PrÃ©nom de bÃ©bÃ©"
                                            value={onboardingData.babyName}
                                            onChange={(e) => setOnboardingData(prev => ({ ...prev, babyName: e.target.value }))} autoFocus
                                        />
                                    </div>
                                    <button
                                        onClick={nextOnboardingStep}
                                        disabled={!onboardingData.babyName.trim()}
                                        className={`w-full ${themeColors.primaryBg} text-white px-8 py-4 rounded-2xl font-bold disabled:opacity-50 disabled:cursor-not-allowed shadow-xl active:scale-95 transition-transform`}
                                    >
                                        Continuer
                                    </button>
                                </div>
                            </div>
                        )
                    },
                    // Ã‰tape 2: Sexe
                    {
                        component: (
                            <div className="text-center space-y-6 fade-in theme-transition">
                                <div className={`w-20 h-20 mx-auto mb-6 ${themeColors.primaryLight} rounded-2xl flex items-center justify-center transition-all duration-500`}>
                                    <i className={`fas ${onboardingData.gender === 'girl' ? 'fa-venus text-pink-600' : 'fa-mars text-blue-600'} text-3xl transition-all duration-500`}></i>
                                </div>
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-900 mb-3">
                                        {onboardingData.babyName} est...
                                    </h2>
                                    <p className="text-gray-600 mb-8">
                                        Cela nous aide Ã  personnaliser les couleurs et conseils
                                    </p>
                                    <div className="grid grid-cols-2 gap-4 mb-8">
                                        <button
                                            onClick={() => setOnboardingData(prev => ({ ...prev, gender: 'boy' }))}
                                            className={`p-6 rounded-2xl border-2 transition-all duration-500 ${onboardingData.gender === 'boy'
                                                ? 'bg-blue-500 border-blue-300 text-white shadow-xl scale-105'
                                                : 'bg-white/90 border-gray-200 text-gray-700 hover:bg-blue-50 hover:border-blue-300'
                                                }`}
                                        >
                                            <div className="text-4xl mb-3">ðŸ‘¦</div>
                                            <div className="font-bold text-lg">Un garÃ§on</div>
                                        </button>
                                        <button
                                            onClick={() => setOnboardingData(prev => ({ ...prev, gender: 'girl' }))}
                                            className={`p-6 rounded-2xl border-2 transition-all duration-500 ${onboardingData.gender === 'girl'
                                                ? 'bg-pink-500 border-pink-300 text-white shadow-xl scale-105'
                                                : 'bg-white/90 border-gray-200 text-gray-700 hover:bg-pink-50 hover:border-pink-300'
                                                }`}
                                        >
                                            <div className="text-4xl mb-3">ðŸ‘§</div>
                                            <div className="font-bold text-lg">Une fille</div>
                                        </button>
                                    </div>
                                    <button
                                        onClick={nextOnboardingStep}
                                        className={`w-full ${themeColors.primaryBg} text-white px-8 py-4 rounded-2xl font-bold shadow-xl active:scale-95 transition-transform`}
                                    >
                                        Continuer
                                    </button>
                                </div>
                            </div>
                        )
                    },
                    // Ã‰tape 3: Date de naissance (nouvelle Ã©tape)
                    {
                        component: (
                            <div className="text-center space-y-6 fade-in theme-transition">
                                <div className={`w-20 h-20 mx-auto mb-6 ${themeColors.primaryLight} rounded-2xl flex items-center justify-center transition-all duration-500`}>
                                    <i className="fas fa-birthday-cake text-3xl text-gray-600"></i>
                                </div>
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-900 mb-3">
                                        Quand {onboardingData.babyName} est-{onboardingData.gender === 'girl' ? 'elle' : 'il'} nÃ©{onboardingData.gender === 'girl' ? 'e' : ''} ?
                                    </h2>
                                    <p className="text-gray-600 mb-8">
                                        Cette information nous permet de calculer l'Ã¢ge et personnaliser les conseils
                                    </p>
                                    <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-4 shadow-xl border border-white/50 mb-6">
                                        <input
                                            type="date"
                                            className="w-full px-6 py-4 rounded-xl text-center text-lg font-bold border-2 border-gray-200 focus:border-blue-500 focus:outline-none transition-colors"
                                            value={onboardingData.birthDate || ''}
                                            onChange={(e) => setOnboardingData(prev => ({ ...prev, birthDate: e.target.value }))} max={new Date().toISOString().split('T')[0]}
                                        />
                                    </div>
                                    <button
                                        onClick={nextOnboardingStep}
                                        disabled={!onboardingData.birthDate}
                                        className={`w-full ${themeColors.primaryBg} text-white px-8 py-4 rounded-2xl font-bold disabled:opacity-50 disabled:cursor-not-allowed shadow-xl active:scale-95 transition-transform`}
                                    >
                                        Continuer
                                    </button>
                                </div>
                            </div>
                        )
                    },
                    // Ã‰tape 4: Poids et taille de naissance (nouvelle Ã©tape)
                    {
                        component: (
                            <div className="text-center space-y-6 fade-in theme-transition">
                                <div className={`w-20 h-20 mx-auto mb-6 ${themeColors.primaryLight} rounded-2xl flex items-center justify-center transition-all duration-500`}>
                                    <i className="fas fa-weight text-3xl text-gray-600"></i>
                                </div>
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-900 mb-3">
                                        Mensurations de {onboardingData.babyName}
                                    </h2>
                                    <p className="text-gray-600 mb-8">
                                        Poids et taille Ã  la naissance pour suivre la croissance
                                    </p>

                                    <div className="space-y-4">
                                        <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-4 shadow-xl border border-white/50">
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                Poids actuel (kg) *
                                            </label>
                                            <div className="relative">
                                                <input
                                                    type="number"
                                                    step="0.001"
                                                    placeholder="3.500"
                                                    className="w-full px-4 py-3 pr-12 rounded-xl text-center text-lg font-bold border-2 border-gray-200 focus:border-blue-500 focus:outline-none transition-colors"
                                                    value={onboardingData.birthWeight || ''}
                                                    onChange={(e) => setOnboardingData(prev => ({ ...prev, birthWeight: e.target.value }))} />

                                                <span className="absolute right-4 top-4 text-gray-500 font-medium">kg</span>
                                            </div>
                                        </div>

                                        <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-4 shadow-xl border border-white/50">
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                Taille actuel (cm) *
                                            </label>
                                            <div className="relative">
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    placeholder="50"
                                                    className="w-full px-4 py-3 pr-12 rounded-xl text-center text-lg font-bold border-2 border-gray-200 focus:border-blue-500 focus:outline-none transition-colors"
                                                    value={onboardingData.birthHeight || ''}
                                                    onChange={(e) => setOnboardingData(prev => ({ ...prev, birthHeight: e.target.value }))} />
                                                <span className="absolute right-4 top-4 text-gray-500 font-medium">cm</span>
                                            </div>
                                        </div>
                                    </div>

                                    <button
                                        onClick={nextOnboardingStep}
                                        disabled={!onboardingData.birthWeight || !onboardingData.birthHeight}
                                        className={`w-full mt-6 ${themeColors.primaryBg} text-white px-8 py-4 rounded-2xl font-bold disabled:opacity-50 disabled:cursor-not-allowed shadow-xl active:scale-95 transition-transform`}
                                    >
                                        Continuer
                                    </button>
                                </div>
                            </div>
                        )
                    },
                    // Nouvelle Ã©tape 3: Mode d'alimentation
                    {
                        component: (
                            <div className="text-center space-y-6 fade-in">
                                <div className={`w-20 h-20 mx-auto mb-6 ${themeColors.primaryLight} rounded-2xl flex items-center justify-center transition-all duration-500`}>
                                    <i className="fas fa-utensils text-3xl text-gray-600"></i>
                                </div>
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-900 mb-3">
                                        Comment {onboardingData.babyName} est-{onboardingData.gender === 'girl' ? 'elle' : 'il'} nourri{onboardingData.gender === 'girl' ? 'e' : ''} ?
                                    </h2>
                                    <p className="text-gray-600 mb-8">
                                        Cela nous aide Ã  personnaliser les fonctionnalitÃ©s
                                    </p>
                                    <div className="space-y-3">
                                        <button
                                            onClick={() => setOnboardingData(prev => ({ ...prev, feedingMode: 'formula' }))}
                                            className={`w-full p-4 rounded-2xl border-2 transition-all duration-300 ${onboardingData.feedingMode === 'formula'
                                                ? 'bg-blue-500 border-blue-300 text-white shadow-xl'
                                                : 'bg-white/90 border-gray-200 text-gray-700 hover:bg-blue-50 hover:border-blue-300'
                                                }`}
                                        >
                                            <div className="text-2xl mb-2">ðŸ¼</div>
                                            <div className="font-bold">Lait artificiel uniquement</div>
                                            <div className="text-sm opacity-75">Biberons de lait infantile</div>
                                        </button>
                                        <button
                                            onClick={() => setOnboardingData(prev => ({ ...prev, feedingMode: 'breastfeeding' }))}
                                            className={`w-full p-4 rounded-2xl border-2 transition-all duration-300 ${onboardingData.feedingMode === 'breastfeeding'
                                                ? 'bg-pink-500 border-pink-300 text-white shadow-xl'
                                                : 'bg-white/90 border-gray-200 text-gray-700 hover:bg-pink-50 hover:border-pink-300'
                                                }`}
                                        >
                                            <div className="text-2xl mb-2">ðŸ¤±</div>
                                            <div className="font-bold">Allaitement uniquement</div>
                                            <div className="text-sm opacity-75">TÃ©tÃ©es au sein maternel</div>
                                        </button>
                                        <button
                                            onClick={() => setOnboardingData(prev => ({ ...prev, feedingMode: 'mixed' }))}
                                            className={`w-full p-4 rounded-2xl border-2 transition-all duration-300 ${onboardingData.feedingMode === 'mixed'
                                                ? 'bg-purple-500 border-purple-300 text-white shadow-xl'
                                                : 'bg-white/90 border-gray-200 text-gray-700 hover:bg-purple-50 hover:border-purple-300'
                                                }`}
                                        >
                                            <div className="text-2xl mb-2">ðŸ¼ðŸ¤±</div>
                                            <div className="font-bold">Allaitement mixte</div>
                                            <div className="text-sm opacity-75">Sein + biberons + tire-lait</div>
                                        </button>
                                    </div>
                                    <button
                                        onClick={nextOnboardingStep}
                                        disabled={!onboardingData.feedingMode}
                                        className={`w-full mt-6 ${themeColors.primaryBg} text-white px-8 py-4 rounded-2xl font-bold disabled:opacity-50 disabled:cursor-not-allowed shadow-xl active:scale-95 transition-transform`}
                                    >
                                        Continuer
                                    </button>
                                </div>
                            </div>
                        )
                    },
                    // Ã‰tape 3: Photo
                    {
                        component: (
                            <div className="text-center space-y-6 fade-in">
                                <div className={`w-20 h-20 mx-auto mb-6 ${themeColors.primaryLight} rounded-2xl flex items-center justify-center transition-all duration-500`}>
                                    <i className={`fas fa-camera text-3xl ${themeColors.primaryText}`}></i>
                                </div>
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-900 mb-3">
                                        Une photo de {onboardingData.babyName} ?
                                    </h2>
                                    <p className="text-gray-600 mb-8">
                                        Optionnel - vous pourrez toujours l'ajouter plus tard
                                    </p>
                                    <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl border border-white/50 mb-8">
                                        <input
                                            type="file"
                                            accept="image/*,.heic,.HEIC"
                                            onChange={(e) => {
                                                const file = e.target.files[0];
                                                if (file) {
                                                    const reader = new FileReader();
                                                    reader.onload = (e) => {
                                                        setOnboardingData(prev => ({ ...prev, photo: e.target.result }));
                                                    };
                                                    reader.readAsDataURL(file);
                                                }
                                            }}
                                            className="hidden"
                                            id="onboarding-photo-upload"
                                        />
                                        <label
                                            htmlFor="onboarding-photo-upload"
                                            className="block w-32 h-32 mx-auto rounded-2xl border-4 border-dashed border-gray-300 flex items-center justify-center cursor-pointer hover:border-blue-400 transition-all duration-300 overflow-hidden bg-gray-50"
                                        >
                                            {onboardingData.photo ? (
                                                <img src={onboardingData.photo} alt="BÃ©bÃ©" className="w-full h-full object-cover rounded-xl" />
                                            ) : (
                                                <div className="text-center">
                                                    <i className="fas fa-plus text-2xl text-gray-400 mb-2"></i>
                                                    <div className="text-sm text-gray-500 font-medium">Ajouter photo</div>
                                                </div>
                                            )}
                                        </label>
                                    </div>
                                    <div className="space-y-3">
                                        <button
                                            onClick={nextOnboardingStep}
                                            className={`w-full ${themeColors.primaryBg} text-white px-8 py-4 rounded-2xl font-bold shadow-xl active:scale-95 transition-transform`}
                                        >
                                            Continuer
                                        </button>
                                        <button
                                            onClick={nextOnboardingStep}
                                            className="w-full bg-gray-100 text-gray-700 px-8 py-3 rounded-2xl font-medium active:scale-95 transition-transform"
                                        >
                                            Passer pour l'instant
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )
                    },
                    // Ã‰tape 4: Choix du plan
                    {
                        component: (
                            <div className="text-center space-y-6 fade-in">
                                <div className="w-20 h-20 mx-auto mb-6 bg-blue-100 rounded-2xl flex items-center justify-center">
                                    <i className="fas fa-star text-3xl text-blue-600"></i>
                                </div>
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-900 mb-3">
                                        Choisissez votre formule
                                    </h2>
                                    <p className="text-gray-600 mb-8">
                                        Commencez votre expÃ©rience BabyTrack
                                    </p>

                                    {/* Plan DÃ©couverte (Freemium) */}
                                    <div className="bg-gray-100 rounded-2xl p-6 mb-4 shadow-lg">
                                        <div className="flex items-center justify-between mb-4">
                                            <div>
                                                <h3 className="text-lg font-bold">Plan DÃ©couverte</h3>
                                                <p className="text-sm text-gray-600">FonctionnalitÃ©s de base</p>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-2xl font-bold text-gray-800">Gratuit</div>
                                                <div className="text-xs text-gray-500">pour toujours</div>
                                            </div>
                                        </div>

                                        {/* FonctionnalitÃ©s incluses */}
                                        <div className="space-y-2 text-sm mb-4 text-gray-700">
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-green-500"></i>
                                                <span>Suivi biberons et changes</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-green-500"></i>
                                                <span>Allaitement et tire-lait</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-green-500"></i>
                                                <span>Statistiques de base</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-times text-red-500"></i>
                                                <span>Historique limitÃ© Ã  48h</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-times text-red-500"></i>
                                                <span>1 utilisateur uniquement</span>
                                            </div>
                                        </div>

                                        <button
                                            onClick={() => startFreemiumAccount()}
                                            className="w-full bg-gray-200 text-gray-800 px-6 py-3 rounded-xl font-medium"
                                        >
                                            Commencer gratuitement
                                        </button>
                                    </div>

                                    {/* Plan VIP Solo */}
                                    <div className="bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl p-6 mb-4 text-white shadow-xl">
                                        <div className="flex items-center justify-between mb-4">
                                            <div>
                                                <h3 className="text-lg font-bold">Plan VIP Solo</h3>
                                                <p className="text-sm opacity-90">1 compte utilisateur</p>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-2xl font-bold">3,99â‚¬</div>
                                                <div className="text-xs opacity-80">par mois</div>
                                            </div>
                                        </div>

                                        {/* FonctionnalitÃ©s incluses */}
                                        <div className="space-y-2 text-sm mb-4 opacity-95">
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-white"></i>
                                                <span>Tout du plan DÃ©couverte</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-white"></i>
                                                <span>Historique illimitÃ©</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-white"></i>
                                                <span>Analytics avancÃ©es</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-white"></i>
                                                <span>Export PDF pour pÃ©diatre</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-white"></i>
                                                <span>Suivi sommeil et croissance</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-white"></i>
                                                <span>Diversification alimentaire</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-white"></i>
                                                <span>Garde-robe et stocks</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-white"></i>
                                                <span>Accomplissements</span>
                                            </div>
                                        </div>

                                        <div className="text-xs opacity-90 mb-3">7 jours d'essai gratuit</div>
                                        <button
                                            onClick={() => startFreeTrial('Solo')}
                                            className="w-full bg-white text-blue-600 px-6 py-3 rounded-xl font-bold"
                                        >
                                            Essayer 7 jours gratuits
                                        </button>
                                    </div>

                                    {/* Plan VIP Parentale */}
                                    <div className="bg-gradient-to-r from-purple-500 to-purple-600 rounded-2xl p-6 mb-4 text-white shadow-xl">
                                        <div className="flex items-center justify-between mb-4">
                                            <div>
                                                <h3 className="text-lg font-bold">Plan VIP Parentale</h3>
                                                <p className="text-sm opacity-90">2 personnes sur le compte</p>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-2xl font-bold">4,99â‚¬</div>
                                                <div className="text-xs opacity-80">par mois</div>
                                            </div>
                                        </div>

                                        {/* FonctionnalitÃ©s incluses */}
                                        <div className="space-y-2 text-sm mb-4 opacity-95">
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-white"></i>
                                                <span>Tout du plan Solo</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-white"></i>
                                                <span>2 utilisateurs connectÃ©s</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-white"></i>
                                                <span>Synchronisation temps rÃ©el</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-white"></i>
                                                <span>Partage d'invitations</span>
                                            </div>
                                        </div>

                                        <div className="text-xs opacity-90 mb-3">7 jours d'essai gratuit</div>
                                        <button
                                            onClick={() => startFreeTrial('Parentale')}
                                            className="w-full bg-white text-purple-600 px-6 py-3 rounded-xl font-bold"
                                        >
                                            Essayer 7 jours gratuits
                                        </button>
                                    </div>

                                    {/* Plan VIP Familial */}
                                    <div className="bg-gradient-to-r from-green-500 to-green-600 rounded-2xl p-6 mb-4 text-white shadow-xl">
                                        <div className="flex items-center justify-between mb-4">
                                            <div>
                                                <h3 className="text-lg font-bold">Plan VIP Familial</h3>
                                                <p className="text-sm opacity-90">4 personnes sur le compte</p>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-2xl font-bold">5,99â‚¬</div>
                                                <div className="text-xs opacity-80">par mois</div>
                                            </div>
                                        </div>

                                        {/* FonctionnalitÃ©s incluses */}
                                        <div className="space-y-2 text-sm mb-4 opacity-95">
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-white"></i>
                                                <span>Tout du plan Parentale</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-white"></i>
                                                <span>4 utilisateurs connectÃ©s</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-white"></i>
                                                <span>IdÃ©al pour grands-parents</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-check text-white"></i>
                                                <span>Support prioritaire</span>
                                            </div>
                                        </div>

                                        <div className="text-xs opacity-90 mb-3">7 jours d'essai gratuit</div>
                                        <button
                                            onClick={() => startFreeTrial('Familial')}
                                            className="w-full bg-white text-green-600 px-6 py-3 rounded-xl font-bold"
                                        >
                                            Essayer 7 jours gratuits
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )
                    }
                ];

                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 flex items-center justify-center p-4">
                        <div className="max-w-md w-full">
                            {/* Indicateur de progression */}
                            <div className="mb-8">
                                <div className="flex justify-center space-x-2 mb-4">
                                    {steps.map((_, index) => (
                                        <div
                                            key={index}
                                            className={`w-3 h-3 rounded-full transition-all duration-300 ${index <= onboardingStep
                                                ? 'logo-gradient'
                                                : 'bg-gray-300'
                                                }`}
                                        />
                                    ))}
                                </div>
                                <div className="text-center text-gray-600 text-sm font-medium">
                                    Ã‰tape {onboardingStep + 1} sur {steps.length}
                                </div>
                            </div>

                            {/* Contenu de l'Ã©tape */}
                            <div className="bg-white/95 backdrop-blur-sm rounded-3xl p-8 shadow-2xl border border-white/50">
                                {steps[onboardingStep]?.component}
                            </div>

                            {/* Boutons de navigation */}
                            <div className="mt-6 flex items-center justify-between">
                                {/* Bouton retour principal - toujours visible */}
                                <div className="text-center mb-4">
                                    <button
                                        onClick={() => {
                                            setShowOnboarding(false);
                                            setShowAuth(true);
                                            setOnboardingStep(0);
                                            setOnboardingData({
                                                babyName: '',
                                                gender: 'boy',
                                                photo: null,
                                                trialStarted: false,
                                                feedingMode: ''
                                            });
                                        }}
                                        className="inline-flex items-center gap-2 text-gray-500 hover:text-gray-700 transition-all duration-300 font-medium bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-xl"
                                    >
                                        <i className="fas fa-arrow-left"></i>
                                        <span>Retour Ã  la connexion</span>
                                    </button>
                                </div>

                                {/* Bouton Ã©tape prÃ©cÃ©dente si applicable */}
                                {onboardingStep > 0 && (
                                    <div className="text-center">
                                        <button
                                            onClick={prevOnboardingStep}
                                            className="inline-flex items-center gap-2 logo-gradient-text hover:opacity-80 transition-opacity duration-300 font-medium text-sm"
                                        >
                                            <i className="fas fa-chevron-left"></i>
                                            <span>Ã‰tape prÃ©cÃ©dente</span>
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };
            // Rendu conditionnel avec onboarding
            if (showOnboarding) {
                return <OnboardingFlow />;
            }
            // Rendu conditionnel - Ã‰cran d'authentification
            if (showAuth) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl border border-white/50 backdrop-blur-sm">
                            <div className="text-center mb-8">
                                <div className="inline-block mb-6">
                                    <img src="logo.PNG" alt="BabyTrack Logo" className="w-32 h-32 mx-auto rounded-2xl shadow-lg" />
                                </div>
                                <p className="text-gray-600">Votre compagnon pour le suivi de bÃ©bÃ©</p>
                            </div>

                            {/* Mode de connexion avec design amÃ©liorÃ© */}
                            <div className="flex rounded-2xl bg-gray-50 p-2 mb-8 shadow-inner">
                                <button
                                    onClick={() => setAuthMode('login')}
                                    className={`flex-1 py-3 px-6 rounded-xl text-sm font-semibold transition-all duration-300 ${authMode === 'login'
                                        ? 'bg-white logo-gradient-text shadow-lg transform scale-105'
                                        : 'text-gray-600 hover:text-gray-800'
                                        }`}
                                >
                                    Mon compte
                                </button>
                                <button
                                    onClick={() => setAuthMode('invite')}
                                    className={`flex-1 py-3 px-6 rounded-xl text-sm font-semibold transition-all duration-300 ${authMode === 'invite'
                                        ? 'bg-white logo-gradient-text shadow-lg transform scale-105'
                                        : 'text-gray-600 hover:text-gray-800'
                                        }`}
                                >
                                    Code d'invitation
                                </button>
                            </div>

                            {authMode === 'login' ? (
                                // Connexion compte existant
                                <div className="space-y-6">
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-3">
                                            Code famille
                                        </label>
                                        <input
                                            type="text"
                                            placeholder="Votre code Ã  6 caractÃ¨res"
                                            className="w-full border-2 border-gray-200 rounded-2xl px-6 py-4 text-center uppercase focus:border-transparent focus:ring-4 focus:ring-blue-100 focus:outline-none transition-all duration-300 text-lg font-bold tracking-wider"
                                            style={{
                                                background: 'linear-gradient(white, white) padding-box, linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%) border-box',
                                                borderColor: 'transparent'
                                            }}
                                            maxLength="6"
                                            value={authData.code}
                                            onChange={(e) => setAuthData(prev => ({ ...prev, code: e.target.value.toUpperCase() }))}
                                        />
                                    </div>
                                    <button
                                        onClick={() => handleLogin()}
                                        disabled={authData.code.length !== 6}
                                        className="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 rounded-2xl font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transition-all duration-300 shadow-xl"
                                    >
                                        Se connecter
                                    </button>
                                    <div className="text-center">
                                        <button
                                            onClick={() => {
                                                setShowOnboarding(true);
                                                setShowAuth(false);
                                            }}
                                            className="text-sm logo-gradient-text hover:opacity-80 transition-opacity duration-300 font-medium"
                                        >
                                            Pas encore de compte ? CrÃ©er un compte
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                // Rejoindre avec invitation
                                <div className="space-y-6">
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-3">
                                            Code d'invitation reÃ§u
                                        </label>
                                        <input
                                            type="text"
                                            placeholder="CODE-123ABC"
                                            className="w-full border-2 border-gray-200 rounded-2xl px-6 py-4 text-center uppercase focus:border-transparent focus:ring-4 focus:ring-green-100 focus:outline-none transition-all duration-300 text-lg font-bold tracking-wider"
                                            style={{
                                                background: 'linear-gradient(white, white) padding-box, linear-gradient(135deg, #10b981 0%, #059669 100%) border-box',
                                                borderColor: 'transparent'
                                            }}
                                            maxLength="25"
                                            value={authData.inviteCode || ''}
                                            onChange={(e) => setAuthData(prev => ({ ...prev, inviteCode: e.target.value.toUpperCase() }))}
                                        />
                                        <div className="text-xs text-gray-500 mt-2 text-center">
                                            Saisissez le code reÃ§u de votre famille
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => joinWithInvite(authData.inviteCode)}
                                        disabled={!authData.inviteCode || authData.inviteCode.length < 6}
                                        className="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-2xl font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transition-all duration-300 shadow-xl"
                                    >
                                        Rejoindre la famille
                                    </button>
                                    <div className="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-2xl p-4">
                                        <div className="flex items-start gap-3">
                                            <div className="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                                <i className="fas fa-info-circle text-green-600"></i>
                                            </div>
                                            <div className="text-sm text-green-700">
                                                <div className="font-semibold mb-2">Avec un code d'invitation :</div>
                                                <ul className="text-xs space-y-1">
                                                    <li>â€¢ Pas besoin de crÃ©er de compte</li>
                                                    <li>â€¢ AccÃ¨s immÃ©diat aux donnÃ©es</li>
                                                    <li>â€¢ Partage en temps rÃ©el</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="text-center">
                                        <button
                                            onClick={() => {
                                                setShowOnboarding(true);
                                                setShowAuth(false);
                                            }}
                                            className="text-sm logo-gradient-text hover:opacity-80 transition-opacity duration-300 font-medium"
                                        >
                                            CrÃ©er votre propre compte famille
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }
            // Navigation tabs
            const TabButton = ({ id, label, icon, active, onClick }) => (
                <button
                    onClick={onClick}
                    className={`flex flex-col items-center justify-center p-2 rounded-lg text-xs font-medium transition-all ${active
                        ? `${themeColors.primaryBg} text-white shadow-md`
                        : 'text-gray-600 hover:text-gray-800'
                        }`}
                >
                    <i className={`${icon} text-lg mb-1`}></i>
                    <span>{label}</span>
                </button>
            );



            // Composant de notification personnalisÃ©e
            const CustomAlert = ({ message, type = 'info', onClose }) => {
                const icons = {
                    success: 'fa-check-circle text-green-600',
                    error: 'fa-exclamation-circle text-red-600',
                    warning: 'fa-exclamation-triangle text-yellow-600',
                    info: 'fa-info-circle text-blue-600'
                };

                const backgrounds = {
                    success: 'from-green-500 to-green-600',
                    error: 'from-red-500 to-red-600',
                    warning: 'from-yellow-500 to-yellow-600',
                    info: 'from-blue-500 to-blue-600'
                };

                return (
                    <div
                        className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[9999]"
                        style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            zIndex: 9999
                        }}
                    >
                        <div
                            className="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-100"
                            style={{
                                position: 'relative',
                                transform: 'scale(1)',
                                animation: 'fadeInScale 0.3s ease-out'
                            }}
                        >
                            <div className="text-center">
                                <div className={`w-16 h-16 mx-auto rounded-full bg-gradient-to-r ${backgrounds[type]} flex items-center justify-center mb-4`}>
                                    <i className={`fas ${icons[type].split(' ')[0]} text-white text-2xl`}></i>
                                </div>
                                <p className="text-gray-800 mb-6 leading-relaxed font-medium">{message}</p>
                                <button
                                    onClick={onClose}
                                    className={`w-full bg-gradient-to-r ${backgrounds[type]} text-white py-3 rounded-xl font-bold active:scale-95 transition-transform shadow-lg`}
                                >
                                    OK
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };
            return (

                <div className="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
                    <div className="max-w-md mx-auto p-4 pb-24">

                        {/* Header masquÃ© sur toutes les vues sauf daily */}
                        {currentView === 'daily' && (

                            <div className="relative mb-4">
                                <div className="bg-white/95 backdrop-blur-xl rounded-2xl shadow-lg border border-white/50 p-3">
                                    <div className="flex items-center justify-end mb-2">
                                        <button
                                            onClick={logout}
                                            className="w-6 h-6 rounded-lg bg-gray-50 flex items-center justify-center"
                                        >
                                            <i className="fas fa-sign-out-alt text-xs text-gray-400"></i>
                                        </button>

                                    </div>

                                    <div className="flex items-center gap-3 mb-2">
                                        {/* Photo/Avatar amÃ©liorÃ© avec support HEIC */}
                                        <div className="relative">
                                            <input
                                                type="file"
                                                accept="image/*,.heic,.HEIC"
                                                onChange={async (e) => {
                                                    const file = e.target.files[0];
                                                    if (file) {
                                                        try {
                                                            // Support HEIC avec heic2any
                                                            let processedFile = file;

                                                            if (file.type === 'image/heic' || file.name.toLowerCase().endsWith('.heic')) {
                                                                // Convertir HEIC en JPEG
                                                                if (window.heic2any) {
                                                                    processedFile = await heic2any({
                                                                        blob: file,
                                                                        toType: "image/jpeg",
                                                                        quality: 0.8
                                                                    });
                                                                }
                                                            }

                                                            const reader = new FileReader();
                                                            reader.onload = async (e) => {
                                                                const imageData = e.target.result;

                                                                // Sauvegarder la photo dans Firebase
                                                                try {
                                                                    await db.collection('families').doc(user.code).update({
                                                                        photo: imageData
                                                                    });
                                                                    setUser(prev => ({ ...prev, photo: imageData }));
                                                                } catch (error) {
                                                                    console.error('Erreur sauvegarde photo:', error);
                                                                    // Garder la photo localement mÃªme si Firebase Ã©choue
                                                                    setUser(prev => ({ ...prev, photo: imageData }));
                                                                }
                                                            };
                                                            reader.readAsDataURL(processedFile);
                                                        } catch (error) {
                                                            console.error('Erreur traitement photo:', error);
                                                            showCustomAlert('Erreur lors du traitement de la photo');
                                                        }
                                                    }
                                                }}
                                                className="hidden"
                                                id="photo-upload"
                                            />
                                            <label
                                                htmlFor="photo-upload"
                                                className="group block w-24 h-24 rounded-xl overflow-hidden cursor-pointer border-2 border-gray-200 hover:border-blue-400 transition-all duration-200 relative"
                                            >
                                                {user?.photo ? (
                                                    <>
                                                        <img
                                                            src={user.photo}
                                                            alt={user.babyName}
                                                            className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-200"
                                                        />
                                                        {/* Overlay pour indiquer qu'on peut changer */}
                                                        <div className="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center">
                                                            <i className="fas fa-camera text-white text-sm"></i>
                                                        </div>
                                                    </>
                                                ) : (
                                                    <div
                                                        className="w-full h-full flex items-center justify-center text-2xl group-hover:scale-105 transition-transform duration-200 relative"
                                                        style={{
                                                            background: `linear-gradient(135deg, ${user?.gender === 'girl' ? '#ec4899' : '#3b82f6'} 0%, ${user?.gender === 'girl' ? '#f472b6' : '#6366f1'} 100%)`
                                                        }}
                                                    >
                                                        <span className="text-white">
                                                            {user?.gender === 'girl' ? 'ðŸ‘§' : 'ðŸ‘¦'}
                                                        </span>
                                                        {/* Indicateur pour ajouter une photo */}
                                                        <div className="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center">
                                                            <i className="fas fa-plus text-white text-sm"></i>
                                                        </div>
                                                    </div>
                                                )}
                                            </label>
                                        </div>
                                        <div className="flex-1">
                                            <h1 className="text-lg font-bold text-gray-900 mb-1">{user?.babyName}</h1>
                                            <div className="text-sm font-semibold text-gray-600">
                                                {user?.birthDate ? formatAgeDisplay(calculateAge()) : 'Ã‚ge non dÃ©fini'}
                                            </div>
                                            {/* Prochain biberon avec dernier en petit */}
                                            {nextFeedingInfo && (
                                                <div className="mt-2">
                                                    {(() => {
                                                        const now = new Date();
                                                        const lastFeedingTime = new Date(nextFeedingInfo.lastFeeding);
                                                        const nextFeedingTime = new Date(nextFeedingInfo.nextTime);

                                                        const minutesSinceLastFeeding = Math.floor((now - lastFeedingTime) / (1000 * 60));
                                                        const minutesUntilNextFeeding = Math.ceil((nextFeedingTime - now) / (1000 * 60));

                                                        // Formatage du temps Ã©coulÃ©
                                                        const formatTime = (minutes) => {
                                                            if (minutes < 0) return "0 min";
                                                            if (minutes < 60) return `${minutes} min`;
                                                            const hours = Math.floor(minutes / 60);
                                                            const mins = minutes % 60;
                                                            return mins > 0 ? `${hours}h${mins.toString().padStart(2, '0')}` : `${hours}h`;
                                                        };

                                                        // Formatage de l'heure exacte
                                                        const formatExactTime = (date) => {
                                                            return date.toLocaleTimeString('fr-FR', {
                                                                hour: '2-digit',
                                                                minute: '2-digit'
                                                            });
                                                        };

                                                        let bgClass, textClass, emoji, mainMessage;

                                                        if (minutesUntilNextFeeding <= 0) {
                                                            // C'est l'heure ou en retard
                                                            bgClass = 'bg-gradient-to-r from-red-500 to-red-600';
                                                            textClass = 'text-white';
                                                            emoji = 'ðŸš¨';
                                                            mainMessage = 'C\'est l\'heure !';
                                                        } else if (minutesUntilNextFeeding <= 30) {
                                                            // BientÃ´t (dans moins de 30 min)
                                                            bgClass = 'bg-gradient-to-r from-orange-500 to-orange-600';
                                                            textClass = 'text-white';
                                                            emoji = 'â°';
                                                            mainMessage = `Prochain biberon Ã  ${formatExactTime(nextFeedingTime)}`;
                                                        } else if (minutesUntilNextFeeding <= 120) {
                                                            // Normal (30min - 2h)
                                                            bgClass = 'bg-gradient-to-r from-blue-500 to-blue-600';
                                                            textClass = 'text-white';
                                                            emoji = 'ðŸ¼';
                                                            mainMessage = `Prochain biberon Ã  ${formatExactTime(nextFeedingTime)}`;
                                                        } else {
                                                            // Loin (plus de 2h)
                                                            bgClass = 'bg-gradient-to-r from-green-500 to-green-600';
                                                            textClass = 'text-white';
                                                            emoji = 'ðŸ˜´';
                                                            mainMessage = `Prochain biberon Ã  ${formatExactTime(nextFeedingTime)}`;
                                                        }

                                                        return (
                                                            <div className={`${bgClass} ${textClass} px-3 py-2 rounded-xl text-xs font-medium shadow-lg`}>
                                                                <div className="flex items-center gap-2">
                                                                    <span className="text-sm">{emoji}</span>
                                                                    <div className="flex-1">
                                                                        <div className="font-bold">{mainMessage}</div>
                                                                        <div className="text-xs opacity-80">
                                                                            Dernier Ã  {formatExactTime(lastFeedingTime)}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })()}
                                                </div>
                                            )}
                                        </div>
                                    </div>



                                </div>
                            </div>
                        )}
                        {/* Banner essai gratuit */}

                        {/* Banner essai gratuit - UNIQUEMENT si essai actif */}
                        {currentPlan === 'Solo' && trialInfo?.isActive && trialTimeRemaining && (
                            <div className={`mb-4 bg-gradient-to-r ${user?.gender === 'girl' ? 'from-pink-500 to-pink-600' : 'from-blue-500 to-blue-600'} text-white rounded-2xl p-4 shadow-xl`}>
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                            <i className="fas fa-gift text-lg"></i>
                                        </div>
                                        <div>
                                            <div className="font-bold text-sm">Essai gratuit actif</div>
                                            <div className="text-xs opacity-90">
                                                {formatTimeRemaining(trialTimeRemaining)}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button
                                            onClick={() => setShowTrialBanner(false)}
                                            className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center active:scale-95 transition-transform"
                                        >
                                            <i className="fas fa-times text-sm"></i>
                                        </button>
                                        <button
                                            onClick={cancelTrial}
                                            className="bg-white/20 px-3 py-1 rounded-lg text-xs font-medium active:scale-95 transition-transform"
                                        >
                                            Annuler
                                        </button>
                                    </div>
                                </div>

                                <div className="mt-3 bg-white/20 rounded-full h-2">
                                    <div
                                        className="bg-white rounded-full h-2 transition-all duration-1000"
                                        style={{
                                            width: `${trialTimeRemaining ? Math.max(0, (trialTimeRemaining.total / (7 * 24 * 60 * 60 * 1000)) * 100) : 0}%`
                                        }}
                                    />
                                </div>
                            </div>
                        )}


                        {/* BanniÃ¨re promo lancement */}
                        {currentPlan === 'Freemium' && (() => {
                            const accountCreationDate = new Date(user?.createdAt);
                            const now = new Date();
                            const daysSinceCreation = Math.floor((now - accountCreationDate) / (1000 * 60 * 60 * 24));
                            const isPromoActive = daysSinceCreation <= 7;

                            return (
                                <div className={`mb-4 bg-gradient-to-r ${isPromoActive ? 'from-yellow-500 to-orange-600' : 'from-blue-500 to-purple-600'} text-white rounded-2xl p-4 shadow-xl`}>
                                    <div className="flex items-center justify-between">
                                        <div className="flex-1">
                                            {isPromoActive ? (
                                                <>
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <span className="text-2xl">ðŸŽ‰</span>
                                                        <div className="text-xs font-bold bg-white/20 px-2 py-1 rounded-full">
                                                            Offre de lancement
                                                        </div>
                                                    </div>
                                                    <div className="font-bold text-lg mb-1">
                                                        -50% sur ton 1er mois VIP
                                                    </div>
                                                    <div className="text-sm opacity-90">
                                                        Jusqu'au {(() => {
                                                            const promoEnd = new Date(accountCreationDate);
                                                            promoEnd.setDate(promoEnd.getDate() + 7);
                                                            return promoEnd.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
                                                        })()}
                                                    </div>
                                                </>
                                            ) : (
                                                <>
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <span className="text-2xl">âœ¨</span>
                                                    </div>
                                                    <div className="font-bold text-lg mb-1">
                                                        DÃ©couvrez les plans VIP
                                                    </div>
                                                    <div className="text-sm opacity-90">
                                                        DÃ©bloquez toutes les fonctionnalitÃ©s
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                        <button
                                            onClick={() => {
                                                setCurrentView('pricing');
                                                window.scrollTo({ top: 0, behavior: 'smooth' });
                                            }}
                                            className="bg-white/20 px-4 py-2 rounded-xl text-sm font-bold active:scale-95 transition-transform whitespace-nowrap"
                                        >
                                            {isPromoActive ? 'Profiter' : 'Voir les plans'}
                                        </button>
                                    </div>
                                    {isPromoActive && (
                                        <div className="mt-3 text-xs opacity-80">
                                            Plus que {7 - daysSinceCreation} jour{7 - daysSinceCreation > 1 ? 's' : ''} pour en profiter !
                                        </div>
                                    )}
                                </div>
                            );
                        })()}
                        {/* Menu dÃ©roulant simple */}
                        {showPlusMenu && (
                            <div className="absolute bottom-20 left-1/2 transform -translate-x-1/2 bg-white rounded-2xl shadow-2xl border border-gray-200 p-3 min-w-[200px] z-50" data-menu="plus">
                                <div className="grid grid-cols-2 gap-3">
                                    {/* Biberon - affichÃ© si formula ou mixed */}
                                    {(user?.feedingMode === 'formula' || user?.feedingMode === 'mixed') && (
                                        <button
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                openForm('feeding');
                                                setShowPlusMenu(false);
                                            }}
                                            className={`flex flex-col items-center p-3 rounded-xl bg-gradient-to-r ${themeColors.primary} text-white hover:opacity-90 transition-opacity`}
                                        >
                                            <i className="fas fa-bottle-water text-xl mb-1"></i>
                                            <span className="text-xs font-medium">Biberon</span>
                                        </button>
                                    )}

                                    {/* Couche - toujours affichÃ© */}
                                    <button
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            openForm('diaper');
                                            setShowPlusMenu(false);
                                        }}
                                        className="flex flex-col items-center p-3 rounded-xl bg-gradient-to-r from-green-500 to-green-600 text-white hover:opacity-90 transition-opacity"
                                    >
                                        <i className="fas fa-baby text-xl mb-1"></i>
                                        <span className="text-xs font-medium">Couche</span>
                                    </button>

                                    {/* Allaitement - affichÃ© si breastfeeding ou mixed */}
                                    {(user?.feedingMode === 'breastfeeding' || user?.feedingMode === 'mixed') && (
                                        <button
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                setShowBreastfeedingModal(true);
                                                setShowPlusMenu(false);
                                            }}
                                            className={`flex flex-col items-center p-3 rounded-xl bg-gradient-to-r from-pink-500 to-pink-600 text-white hover:opacity-90 transition-opacity ${isFeatureLocked('breastfeeding') ? 'opacity-50' : ''}`}
                                        >
                                            <i className="fas fa-heart text-xl mb-1"></i>
                                            <span className="text-xs font-medium">Allaitement</span>
                                            {isFeatureLocked('breastfeeding') && <i className="fas fa-lock text-xs mt-1"></i>}
                                        </button>
                                    )}

                                    {/* Tire-lait - affichÃ© si breastfeeding ou mixed */}
                                    {(user?.feedingMode === 'breastfeeding' || user?.feedingMode === 'mixed') && (
                                        <button
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                setShowBreastPumpModal(true);
                                                setShowPlusMenu(false);
                                            }}
                                            className={`flex flex-col items-center p-3 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 text-white hover:opacity-90 transition-opacity ${isFeatureLocked('breastpump') ? 'opacity-50' : ''}`}
                                        >
                                            <i className="fas fa-pump-soap text-xl mb-1"></i>
                                            <span className="text-xs font-medium">Tire-lait</span>
                                            {isFeatureLocked('breastpump') && <i className="fas fa-lock text-xs mt-1"></i>}
                                        </button>
                                    )}

                                    {/* Sommeil - toujours affichÃ© mais bloquÃ© si Freemium */}
                                    <button
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            if (isFeatureLocked('sleep-tracking')) {
                                                showUpgradeMessage('Suivi du sommeil');
                                                setShowPlusMenu(false);
                                                return;
                                            }
                                            setShowSleepModal(true);
                                            setShowPlusMenu(false);
                                        }}
                                        className={`flex flex-col items-center p-3 rounded-xl bg-gradient-to-r from-indigo-500 to-indigo-600 text-white hover:opacity-90 transition-opacity ${isFeatureLocked('sleep-tracking') ? 'opacity-50' : ''}`}
                                    >
                                        <i className="fas fa-moon text-xl mb-1"></i>
                                        <span className="text-xs font-medium">Sommeil</span>
                                        {isFeatureLocked('sleep-tracking') && <i className="fas fa-lock text-xs mt-1"></i>}
                                    </button>
                                </div>
                            </div>
                        )}
                        {/* Navigation fixe en bas */}
                        <div className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-lg border-t border-gray-200 shadow-xl z-50">
                            <div className="max-w-md mx-auto px-4 py-2">
                                <div className="flex items-center justify-around">
                                    {/* Accueil */}
                                    <button
                                        onClick={() => {
                                            setCurrentView('daily');
                                            window.scrollTo({ top: 0, behavior: 'smooth' });
                                        }}
                                        className={`flex flex-col items-center p-2 rounded-2xl transition-all ${currentView === 'daily'
                                            ? `text-${user?.gender === 'girl' ? 'pink' : 'blue'}-600`
                                            : 'text-gray-500'
                                            }`}
                                    >
                                        <i className="fas fa-home text-lg mb-1"></i>
                                        <span className="text-xs font-medium">Accueil</span>
                                    </button>

                                    {/* Profil */}
                                    <button
                                        onClick={() => {
                                            setCurrentView('profile');
                                            window.scrollTo({ top: 0, behavior: 'smooth' });
                                        }}
                                        className={`flex flex-col items-center p-2 rounded-2xl transition-all ${currentView === 'profile'
                                            ? `text-${user?.gender === 'girl' ? 'pink' : 'blue'}-600`
                                            : 'text-gray-500'
                                            }`}
                                    >
                                        <i className="fas fa-user text-lg mb-1"></i>
                                        <span className="text-xs font-medium">Profil</span>
                                    </button>

                                    {/* Bouton + central avec menu dÃ©roulant - RESTE IDENTIQUE */}
                                    <div className="relative -mt-6" data-menu="plus">
                                        <button
                                            onClick={() => setShowPlusMenu(!showPlusMenu)}
                                            className={`w-16 h-16 bg-gradient-to-r ${themeColors.primary} text-white rounded-full shadow-xl flex items-center justify-center transition-transform duration-300 ${showPlusMenu ? 'rotate-45' : ''}`}
                                        >
                                            <i className="fas fa-plus text-2xl"></i>
                                        </button>


                                    </div>

                                    {/* Historique */}
                                    {/* Historique ou VIP selon le plan */}
                                    {currentPlan === 'Freemium' ? (
                                        <button
                                            onClick={() => {
                                                setCurrentView('pricing');
                                                window.scrollTo({ top: 0, behavior: 'smooth' });
                                            }}
                                            className={`flex flex-col items-center p-2 rounded-2xl transition-all ${currentView === 'pricing'
                                                    ? 'text-yellow-600'
                                                    : 'text-gray-500'
                                                }`}
                                        >
                                            <i className="fas fa-crown text-lg mb-1"></i>
                                            <span className="text-xs font-medium">VIP</span>
                                        </button>
                                    ) : (
                                        <button
                                            onClick={() => {
                                                setCurrentView('analytics');
                                                window.scrollTo({ top: 0, behavior: 'smooth' });
                                            }}
                                            className={`flex flex-col items-center p-2 rounded-2xl transition-all ${currentView === 'analytics'
                                                    ? `text-${user?.gender === 'girl' ? 'pink' : 'blue'}-600`
                                                    : 'text-gray-500'
                                                }`}
                                        >
                                            <i className="fas fa-history text-lg mb-1"></i>
                                            <span className="text-xs font-medium">Historique</span>
                                        </button>
                                    )}
                                    {/* Plus - Menu dropdown */}
                                    <div className="relative" data-menu="more">
                                        <button
                                            onClick={() => setShowMoreMenu(!showMoreMenu)}
                                            className={`flex flex-col items-center p-2 rounded-2xl transition-all ${['supplies', 'food', 'wardrobe'].includes(currentView)
                                                ? 'text-purple-600'
                                                : 'text-gray-500'
                                                }`}
                                        >
                                            <i className="fas fa-ellipsis-h text-lg mb-1"></i>
                                            <span className="text-xs font-medium">Plus</span>
                                        </button>

                                        {/* Dropdown menu Plus */}
                                        {showMoreMenu && (
                                            <div className="absolute bottom-16 right-0 bg-white rounded-2xl shadow-2xl border border-gray-200 py-2 min-w-[140px] z-50">
                                                {/* Diversification */}
                                                <button
                                                    onClick={() => {
                                                        if (isFeatureLocked('diversification')) {
                                                            showUpgradeMessage('Diversification alimentaire');
                                                            setShowMoreMenu(false);
                                                            return;
                                                        }
                                                        setCurrentView('food');
                                                        setShowMoreMenu(false);
                                                        window.scrollTo({ top: 0, behavior: 'smooth' });
                                                    }}
                                                    className={`w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center gap-3 ${isFeatureLocked('diversification') ? 'opacity-50' : ''
                                                        }`}
                                                >
                                                    <i className="fas fa-utensils text-orange-500"></i>
                                                    <span className="text-sm font-medium">Diversification</span>
                                                    {isFeatureLocked('diversification') && (
                                                        <i className="fas fa-lock text-gray-400 ml-auto"></i>
                                                    )}
                                                </button>

                                                {/* Stocks */}
                                                <button
                                                    onClick={() => {
                                                        if (isFeatureLocked('stocks')) {
                                                            showUpgradeMessage('Gestion des stocks');
                                                            setShowMoreMenu(false);
                                                            return;
                                                        }
                                                        setCurrentView('supplies');
                                                        setShowMoreMenu(false);
                                                        window.scrollTo({ top: 0, behavior: 'smooth' });
                                                    }}
                                                    className={`w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center gap-3 ${isFeatureLocked('stocks') ? 'opacity-50' : ''
                                                        }`}
                                                >
                                                    <i className="fas fa-boxes text-blue-500"></i>
                                                    <span className="text-sm font-medium">Stocks</span>
                                                    {isFeatureLocked('stocks') && (
                                                        <i className="fas fa-lock text-gray-400 ml-auto"></i>
                                                    )}
                                                </button>

                                                {/* Garde-robe */}
                                                <button
                                                    onClick={() => {
                                                        if (isFeatureLocked('wardrobe')) {
                                                            showUpgradeMessage('Garde-robe');
                                                            setShowMoreMenu(false);
                                                            return;
                                                        }
                                                        setCurrentView('wardrobe');
                                                        setShowMoreMenu(false);
                                                        window.scrollTo({ top: 0, behavior: 'smooth' });
                                                    }}
                                                    className={`w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center gap-3 ${isFeatureLocked('wardrobe') ? 'opacity-50' : ''
                                                        }`}
                                                >
                                                    <i className="fas fa-tshirt text-pink-500"></i>
                                                    <span className="text-sm font-medium">Garde-robe</span>
                                                    {isFeatureLocked('wardrobe') && (
                                                        <i className="fas fa-lock text-gray-400 ml-auto"></i>
                                                    )}
                                                </button>

                                                {/* Liste de cadeaux */}
                                                <button
                                                    onClick={() => {
                                                        if (isFeatureLocked('gifts')) {
                                                            showUpgradeMessage('Liste de cadeaux');
                                                            setShowMoreMenu(false);
                                                            return;
                                                        }
                                                        setCurrentView('gifts');
                                                        setShowMoreMenu(false);
                                                        window.scrollTo({ top: 0, behavior: 'smooth' });
                                                    }}
                                                    className={`w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center gap-3 ${isFeatureLocked('gifts') ? 'opacity-50' : ''}`}
                                                >
                                                    <i className="fas fa-gift text-red-500"></i>
                                                    <span className="text-sm font-medium">Liste de cadeaux</span>
                                                    {isFeatureLocked('gifts') && (
                                                        <i className="fas fa-lock text-gray-400 ml-auto"></i>
                                                    )}
                                                </button>
                                                {/* Accomplissements */}
                                                <button
                                                    onClick={() => {
                                                        if (isFeatureLocked('accomplishments')) {
                                                            showUpgradeMessage('Accomplissements');
                                                            setShowMoreMenu(false);
                                                            return;
                                                        }
                                                        setCurrentView('accomplishments');
                                                        setShowMoreMenu(false);
                                                        window.scrollTo({ top: 0, behavior: 'smooth' });
                                                    }}
                                                    className={`w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center gap-3 ${isFeatureLocked('accomplishments') ? 'opacity-50' : ''
                                                        }`}
                                                >
                                                    <i className="fas fa-trophy text-yellow-500"></i>
                                                    <span className="text-sm font-medium">Accomplissements</span>
                                                    {isFeatureLocked('accomplishments') && (
                                                        <i className="fas fa-lock text-gray-400 ml-auto"></i>
                                                    )}
                                                </button>


                                            </div>
                                        )}                                   </div>
                                </div></div>
                        </div>
                        {/* Contenu selon la vue */}
                        {currentView === 'daily' && (
                            <>

                                {/* Statistiques du jour uniquement */}
                                {(() => {
                                    const todayStats = getStats('daily');

                                    // Stats allaitement aujourd'hui
                                    const todayBreastfeeding = breastfeedingEntries.filter(entry => {
                                        const entryDate = new Date(entry.timestamp);
                                        const today = getDayStart(new Date());
                                        const todayEnd = getDayEnd(new Date());
                                        return entry.status === 'completed' && entryDate >= today && entryDate <= todayEnd;
                                    });

                                    // Stats tire-lait aujourd'hui
                                    const todayBreastPump = breastPumpEntries.filter(entry => {
                                        const entryDate = new Date(entry.timestamp);
                                        const today = getDayStart(new Date());
                                        const todayEnd = getDayEnd(new Date());
                                        return entryDate >= today && entryDate <= todayEnd;
                                    });

                                    // Stats sommeil aujourd'hui
                                    const todaySleep = sleepSessions.filter(session => {
                                        const sessionDate = new Date(session.startTime);
                                        const today = getDayStart(new Date());
                                        const todayEnd = getDayEnd(new Date());
                                        return session.status === 'completed' && sessionDate >= today && sessionDate <= todayEnd;
                                    });

                                    const cards = [];

                                    // Biberon (toujours affichÃ©)
                                    cards.push(
                                        <div key="feeding" className="bg-white/90 backdrop-blur-sm rounded-2xl p-4 shadow-xl border border-white/30 relative overflow-hidden">
                                            <div className={`absolute top-0 right-0 w-12 h-12 ${themeColors.primary} opacity-5 rounded-full -translate-y-2 translate-x-2`} />
                                            <div className="relative">
                                                <div className="flex items-center justify-center mb-2">
                                                    <div className={`w-8 h-8 rounded-xl ${themeColors.primaryLight} flex items-center justify-center`}>
                                                        <i className={`fas fa-bottle-water ${themeColors.primaryText} text-sm`}></i>
                                                    </div>
                                                </div>
                                                <div className="text-center">
                                                    <div className="text-xl font-bold text-gray-900 mb-1">
                                                        {todayStats.totalMilk}
                                                        <span className="text-sm font-medium text-gray-600">ml</span>
                                                    </div>
                                                    <div className="text-xs font-medium text-gray-500">Biberons</div>
                                                    {todayStats.feedingCount > 0 && (
                                                        <div className="text-xs text-gray-400 mt-1">
                                                            ~{Math.round(todayStats.totalMilk / todayStats.feedingCount)}ml/bib
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    );

                                    // Pipi (toujours affichÃ©)
                                    cards.push(
                                        <div key="pee" className="bg-white/90 backdrop-blur-sm rounded-2xl p-4 shadow-xl border border-white/30 relative overflow-hidden">
                                            <div className="relative">
                                                <div className="flex items-center justify-center mb-2">
                                                    <div className="w-8 h-8 rounded-xl bg-blue-100 flex items-center justify-center">
                                                        <span className="text-sm">ðŸ’§</span>
                                                    </div>
                                                </div>
                                                <div className="text-center">
                                                    <div className="text-xl font-bold text-gray-900 mb-1">
                                                        {todayStats.totalPees}
                                                    </div>
                                                    <div className="text-xs font-medium text-gray-500">Pipis</div>
                                                </div>
                                            </div>
                                        </div>
                                    );

                                    // Caca (toujours affichÃ©)
                                    cards.push(
                                        <div key="poop" className="bg-white/90 backdrop-blur-sm rounded-2xl p-4 shadow-xl border border-white/30 relative overflow-hidden">
                                            <div className="relative">
                                                <div className="flex items-center justify-center mb-2">
                                                    <div className="w-8 h-8 rounded-xl bg-orange-100 flex items-center justify-center">
                                                        <span className="text-sm">ðŸ’©</span>
                                                    </div>
                                                </div>
                                                <div className="text-center">
                                                    <div className="text-xl font-bold text-gray-900 mb-1">
                                                        {todayStats.totalPoops}
                                                    </div>
                                                    <div className="text-xs font-medium text-gray-500">Cacas</div>
                                                </div>
                                            </div>
                                        </div>
                                    );

                                    // Allaitement (si il y en a eu aujourd'hui)
                                    if (todayBreastfeeding.length > 0) {
                                        const totalMinutes = todayBreastfeeding.reduce((sum, entry) => sum + (entry.duration || 0), 0);
                                        cards.push(
                                            <div key="breastfeeding" className="bg-white/90 backdrop-blur-sm rounded-2xl p-4 shadow-xl border border-white/30 relative overflow-hidden">
                                                <div className="relative">
                                                    <div className="flex items-center justify-center mb-2">
                                                        <div className="w-8 h-8 rounded-xl bg-pink-100 flex items-center justify-center">
                                                            <i className="fas fa-heart text-pink-600 text-sm"></i>
                                                        </div>
                                                    </div>
                                                    <div className="text-center">
                                                        <div className="text-xl font-bold text-gray-900 mb-1">
                                                            {todayBreastfeeding.length}
                                                        </div>
                                                        <div className="text-xs font-medium text-gray-500">TÃ©tÃ©es</div>
                                                        {totalMinutes > 0 && (
                                                            <div className="text-xs text-gray-400 mt-1">
                                                                {totalMinutes}min
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    }

                                    // Tire-lait (si il y en a eu aujourd'hui)
                                    if (todayBreastPump.length > 0) {
                                        const totalVolume = todayBreastPump.reduce((sum, entry) => sum + (entry.volume || 0), 0);
                                        cards.push(
                                            <div key="breastpump" className="bg-white/90 backdrop-blur-sm rounded-2xl p-4 shadow-xl border border-white/30 relative overflow-hidden">
                                                <div className="relative">
                                                    <div className="flex items-center justify-center mb-2">
                                                        <div className="w-8 h-8 rounded-xl bg-purple-100 flex items-center justify-center">
                                                            <i className="fas fa-pump-soap text-purple-600 text-sm"></i>
                                                        </div>
                                                    </div>
                                                    <div className="text-center">
                                                        <div className="text-xl font-bold text-gray-900 mb-1">
                                                            {totalVolume}
                                                            <span className="text-sm font-medium text-gray-600">ml</span>
                                                        </div>
                                                        <div className="text-xs font-medium text-gray-500">Tire-lait</div>
                                                        <div className="text-xs text-gray-400 mt-1">
                                                            {todayBreastPump.length} session{todayBreastPump.length > 1 ? 's' : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    }

                                    // Sommeil (si il y en a eu aujourd'hui)
                                    if (todaySleep.length > 0) {
                                        const totalMinutes = todaySleep.reduce((sum, session) => sum + (session.duration || 0), 0);
                                        const totalHours = Math.round(totalMinutes / 60 * 10) / 10;
                                        cards.push(
                                            <div key="sleep" className="bg-white/90 backdrop-blur-sm rounded-2xl p-4 shadow-xl border border-white/30 relative overflow-hidden">
                                                <div className="relative">
                                                    <div className="flex items-center justify-center mb-2">
                                                        <div className="w-8 h-8 rounded-xl bg-indigo-100 flex items-center justify-center">
                                                            <i className="fas fa-moon text-indigo-600 text-sm"></i>
                                                        </div>
                                                    </div>
                                                    <div className="text-center">
                                                        <div className="text-xl font-bold text-gray-900 mb-1">
                                                            {totalHours}
                                                            <span className="text-sm font-medium text-gray-600">h</span>
                                                        </div>
                                                        <div className="text-xs font-medium text-gray-500">Sommeil</div>
                                                        <div className="text-xs text-gray-400 mt-1">
                                                            {todaySleep.length} session{todaySleep.length > 1 ? 's' : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    }

                                    return (
                                        <div className="grid grid-cols-3 gap-3 mb-6">
                                            {cards}
                                        </div>
                                    );
                                })()}
                                {/* Panneau notifications */}
                                {notificationPermission !== 'granted' && (
                                    <div className="bg-blue-50 border border-blue-200 rounded-2xl p-4 mb-4">
                                        <div className="flex items-center gap-3">
                                            <div className="w-12 h-12 bg-blue-100 rounded-2xl flex items-center justify-center">
                                                <i className="fas fa-bell text-blue-600 text-xl"></i>
                                            </div>
                                            <div className="flex-1">
                                                <h3 className="font-bold text-blue-800">Activer les notifications</h3>
                                                <p className="text-sm text-blue-700">Recevez des rappels automatiques pour les biberons, mÃ©dicaments et RDV</p>
                                                {scheduledNotifications.size > 0 && (
                                                    <p className="text-xs text-blue-600 mt-1">{scheduledNotifications.size} notifications programmÃ©es</p>
                                                )}
                                            </div>
                                            <button
                                                onClick={requestNotificationPermission}
                                                className="bg-blue-500 text-white px-4 py-2 rounded-xl text-sm font-medium shadow-lg active:scale-95 transition-transform"
                                            >
                                                Activer
                                            </button>
                                        </div>
                                    </div>
                                )}
                                {/* Historique avec pagination */}
                                <div className="space-y-3">
                                    <div className="flex items-center justify-between">
                                        <h3 className="text-lg font-bold text-gray-800">Historique</h3>
                                        <select
                                            value={historyFilter}
                                            onChange={(e) => {
                                                if (currentPlan === 'Freemium' && !['today', 'yesterday'].includes(e.target.value)) {
                                                    showUpgradeMessage('Historique Ã©tendu');
                                                    return;
                                                }
                                                setHistoryFilter(e.target.value);
                                                setCurrentPage(0);
                                            }}
                                            className={`text-sm border rounded-lg px-2 py-1 ${currentPlan === 'Freemium' ? 'bg-gray-50' : ''
                                                }`}
                                        >
                                            <option value="today">Aujourd'hui</option>
                                            <option value="yesterday">Hier</option>
                                            <option value="week">7 derniers jours</option>
                                            <option value="all">Tout</option>
                                        </select>
                                    </div>

                                    <div className="space-y-3">
                                        {(() => {
                                            const combinedEntries = getFreemiumHistory();
                                            const itemsPerPage = 10;
                                            const startIndex = currentPage * itemsPerPage;
                                            const endIndex = startIndex + itemsPerPage;
                                            const currentEntries = combinedEntries.slice(startIndex, endIndex);
                                            const totalPages = Math.ceil(combinedEntries.length / itemsPerPage);

                                            return (
                                                <>
                                                    {currentEntries.length === 0 ? (
                                                        <p className="text-gray-500 text-center py-8">Aucune entrÃ©e pour cette pÃ©riode</p>
                                                    ) : (
                                                        <>
                                                            {currentEntries.map((entry, index) => (
                                                                <React.Fragment key={entry.id}>
                                                                    {/* Pub Freemium tous les 3 Ã©lÃ©ments */}
                                                                    {currentPlan === 'Freemium' && index > 0 && index % 3 === 0 && (
                                                                        <FreemiumAd />
                                                                    )}

                                                                    {/* Rendu spÃ©cial pour les sessions de sommeil */}
                                                                    {entry.type === 'sleep' ? (
                                                                        <div className="bg-white/95 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 overflow-hidden">
                                                                            <div className="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-purple-500 to-purple-600" />
                                                                            <div className="p-5 pl-6 relative">
                                                                                <div className="flex items-start justify-between mb-4">
                                                                                    <div className="flex items-center gap-4 flex-1">
                                                                                        <div className="w-14 h-14 rounded-2xl flex items-center justify-center bg-purple-100 border-2 border-purple-200">
                                                                                            <i className="fas fa-moon text-purple-600 text-xl"></i>
                                                                                        </div>
                                                                                        <div className="flex-1 min-w-0">
                                                                                            <div className="flex items-center gap-2 mb-1 flex-wrap">
                                                                                                <h4 className="font-bold text-gray-900 text-lg">Sommeil</h4>
                                                                                                <div className="px-2 py-0.5 rounded-full text-xs font-medium border bg-purple-50 text-purple-700 border-purple-200">
                                                                                                    Repos
                                                                                                </div>
                                                                                            </div>
                                                                                            <div className="flex items-center gap-2 flex-wrap">
                                                                                                <p className="text-sm font-medium text-gray-600">
                                                                                                    {formatDateTime(entry.startTime)}
                                                                                                </p>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div className="flex items-center gap-2 ml-2">
                                                                                        <button
                                                                                            onClick={() => editSleepSession(entry.id)}
                                                                                            className="w-9 h-9 rounded-2xl bg-blue-50 flex items-center justify-center active:scale-95 transition-transform"
                                                                                        >
                                                                                            <i className="fas fa-edit text-sm text-blue-600"></i>
                                                                                        </button>
                                                                                        <button
                                                                                            onClick={() => deleteSleepSession(entry.id)}
                                                                                            className="w-9 h-9 rounded-2xl bg-red-50 flex items-center justify-center active:scale-95 transition-transform"
                                                                                        >
                                                                                            <i className="fas fa-trash text-sm text-red-600"></i>
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                                <div className="h-px bg-gradient-to-r from-transparent via-gray-200 to-transparent mb-4 opacity-60"></div>
                                                                                <div className="space-y-3">
                                                                                    <div className="flex items-center gap-3 flex-wrap">
                                                                                        <div className="flex items-center gap-2 px-4 py-2 rounded-2xl bg-purple-100 border border-purple-200">
                                                                                            <i className="fas fa-clock text-sm opacity-70"></i>
                                                                                            <span className="font-bold text-base">{formatSleepDuration(entry.duration)}</span>
                                                                                        </div>
                                                                                        <div className="flex items-center gap-2 px-3 py-1 rounded-full bg-purple-50 border border-purple-200">
                                                                                            <span className="text-xs text-purple-700">
                                                                                                {formatTime(entry.startTime)} â†’ {formatTime(entry.endTime)}
                                                                                            </span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                                <div className="mt-4 pt-3 border-t border-gray-100">
                                                                                    <div className="flex items-center justify-between text-xs text-gray-500">
                                                                                        <span>#{entry.id.slice(-6)}</span>
                                                                                        <span>Session de {formatSleepDuration(entry.duration)}</span>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    ) : entry.type === 'breastfeeding' ? (
                                                                        <div className="bg-white/95 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 overflow-hidden">
                                                                            <div className="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-pink-500 to-pink-600" />
                                                                            <div className="p-5 pl-6 relative">
                                                                                <div className="flex items-start justify-between mb-4">
                                                                                    <div className="flex items-center gap-4 flex-1">
                                                                                        <div className="w-14 h-14 rounded-2xl flex items-center justify-center bg-pink-100 border-2 border-pink-200">
                                                                                            <i className="fas fa-heart text-pink-600 text-xl"></i>
                                                                                        </div>
                                                                                        <div className="flex-1 min-w-0">
                                                                                            <div className="flex items-center gap-2 mb-1 flex-wrap">
                                                                                                <h4 className="font-bold text-gray-900 text-lg">Allaitement</h4>
                                                                                                <div className="px-2 py-0.5 rounded-full text-xs font-medium border bg-pink-50 text-pink-700 border-pink-200">
                                                                                                    TÃ©tÃ©e
                                                                                                </div>
                                                                                            </div>
                                                                                            <div className="flex items-center gap-2 flex-wrap">
                                                                                                <p className="text-sm font-medium text-gray-600">
                                                                                                    {formatDateTime(entry.timestamp)}
                                                                                                </p>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div className="flex items-center gap-2 ml-2">
                                                                                        <button
                                                                                            onClick={() => deleteBreastfeedingEntry(entry.id)}
                                                                                            className="w-9 h-9 rounded-2xl bg-red-50 flex items-center justify-center active:scale-95 transition-transform"
                                                                                        >
                                                                                            <i className="fas fa-trash text-sm text-red-600"></i>
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                                <div className="h-px bg-gradient-to-r from-transparent via-gray-200 to-transparent mb-4 opacity-60"></div>
                                                                                <div className="space-y-3">
                                                                                    <div className="flex items-center gap-3 flex-wrap">
                                                                                        <div className="flex items-center gap-2 px-4 py-2 rounded-2xl bg-pink-100 border border-pink-200">
                                                                                            <i className="fas fa-heart text-sm opacity-70"></i>
                                                                                            <span className="font-bold text-base">
                                                                                                {entry.breast === 'left' ? 'Sein gauche' :
                                                                                                    entry.breast === 'right' ? 'Sein droit' : 'Les deux seins'}
                                                                                            </span>
                                                                                        </div>
                                                                                        {entry.duration && (
                                                                                            <div className="flex items-center gap-2 px-3 py-1 rounded-full bg-pink-50 border border-pink-200">
                                                                                                <span className="text-xs text-pink-700">{entry.duration} min</span>
                                                                                            </div>
                                                                                        )}
                                                                                    </div>
                                                                                </div>
                                                                                <div className="mt-4 pt-3 border-t border-gray-100">
                                                                                    <div className="flex items-center justify-between text-xs text-gray-500">
                                                                                        <span>#{entry.id.slice(-6)}</span>
                                                                                        <span>Allaitement {entry.duration ? `de ${entry.duration}min` : ''}</span>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    ) : entry.type === 'breast_pump' ? (
                                                                        <div className="bg-white/95 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 overflow-hidden">
                                                                            <div className="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-purple-500 to-purple-600" />
                                                                            <div className="p-5 pl-6 relative">
                                                                                <div className="flex items-start justify-between mb-4">
                                                                                    <div className="flex items-center gap-4 flex-1">
                                                                                        <div className="w-14 h-14 rounded-2xl flex items-center justify-center bg-purple-100 border-2 border-purple-200">
                                                                                            <i className="fas fa-pump-soap text-purple-600 text-xl"></i>
                                                                                        </div>
                                                                                        <div className="flex-1 min-w-0">
                                                                                            <div className="flex items-center gap-2 mb-1 flex-wrap">
                                                                                                <h4 className="font-bold text-gray-900 text-lg">Tire-lait</h4>
                                                                                                <div className="px-2 py-0.5 rounded-full text-xs font-medium border bg-purple-50 text-purple-700 border-purple-200">
                                                                                                    Pompage
                                                                                                </div>
                                                                                            </div>
                                                                                            <div className="flex items-center gap-2 flex-wrap">
                                                                                                <p className="text-sm font-medium text-gray-600">
                                                                                                    {formatDateTime(entry.timestamp)}
                                                                                                </p>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div className="flex items-center gap-2 ml-2">
                                                                                        <button
                                                                                            onClick={() => deleteBreastPumpEntry(entry.id)}
                                                                                            className="w-9 h-9 rounded-2xl bg-red-50 flex items-center justify-center active:scale-95 transition-transform"
                                                                                        >
                                                                                            <i className="fas fa-trash text-sm text-red-600"></i>
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                                <div className="h-px bg-gradient-to-r from-transparent via-gray-200 to-transparent mb-4 opacity-60"></div>
                                                                                <div className="space-y-3">
                                                                                    <div className="flex items-center gap-3 flex-wrap">
                                                                                        <div className="flex items-center gap-2 px-4 py-2 rounded-2xl bg-purple-100 border border-purple-200">
                                                                                            <i className="fas fa-tint text-sm opacity-70"></i>
                                                                                            <span className="font-bold text-base">{entry.volume}ml</span>
                                                                                        </div>
                                                                                        <div className="flex items-center gap-2 px-3 py-1 rounded-full bg-purple-50 border border-purple-200">
                                                                                            <span className="text-xs text-purple-700">{entry.duration} min</span>
                                                                                        </div>
                                                                                        <div className="flex items-center gap-2 px-3 py-1 rounded-full bg-gray-50 border border-gray-200">
                                                                                            <span className="text-xs text-gray-700">
                                                                                                {entry.storage === 'immediate' ? 'ImmÃ©diat' :
                                                                                                    entry.storage === 'fridge' ? 'Frigo' : 'CongÃ©lateur'}
                                                                                            </span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                                <div className="mt-4 pt-3 border-t border-gray-100">
                                                                                    <div className="flex items-center justify-between text-xs text-gray-500">
                                                                                        <span>#{entry.id.slice(-6)}</span>
                                                                                        <span>Session de {entry.duration}min</span>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    ) : (
                                                                        /* EntrÃ©es normales (biberon/couche) */
                                                                        (() => {
                                                                            let poopDisplay = '';
                                                                            if (entry.hasPoop) {
                                                                                const poopInfo = getPoopInfo(entry.poopQuantity, entry.poopConsistency, entry.poopColor);
                                                                                const parts = [];

                                                                                if (poopInfo.quantity.label) parts.push(`${poopInfo.quantity.emoji} ${poopInfo.quantity.label}`);
                                                                                if (poopInfo.consistency.label) parts.push(`${poopInfo.consistency.emoji} ${poopInfo.consistency.label}`);
                                                                                if (poopInfo.color.label) parts.push(`${poopInfo.color.emoji} ${poopInfo.color.label}`);

                                                                                const displayText = parts.length > 0 ? parts.join(' â€¢ ') : 'ðŸ’© Caca';
                                                                                poopDisplay = (
                                                                                    <span className={`${poopInfo.color.bgColor || 'bg-orange-100'} ${poopInfo.color.textColor || 'text-orange-800'} px-3 py-1 rounded-full text-xs font-medium`}>
                                                                                        {displayText}
                                                                                    </span>
                                                                                );
                                                                            }

                                                                            const timeElapsed = new Date() - new Date(entry.timestamp);
                                                                            const minutesAgo = Math.floor(timeElapsed / (1000 * 60));
                                                                            const hoursAgo = Math.floor(minutesAgo / 60);

                                                                            let timeDisplayClass = 'text-gray-500';
                                                                            if (minutesAgo < 30) timeDisplayClass = 'text-green-600 font-medium';
                                                                            else if (minutesAgo < 120) timeDisplayClass = 'text-blue-600';

                                                                            return (
                                                                                <div className="bg-white/95 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 overflow-hidden">
                                                                                    <div
                                                                                        className={`absolute left-0 top-0 bottom-0 w-1 ${entry.type === 'feeding'
                                                                                            ? `bg-gradient-to-b ${themeColors.primary}`
                                                                                            : 'bg-gradient-to-b from-emerald-500 to-emerald-600'
                                                                                            }`}
                                                                                    />
                                                                                    <div className="p-5 pl-6 relative">
                                                                                        <div className="flex items-start justify-between mb-4">
                                                                                            <div className="flex items-center gap-4 flex-1">
                                                                                                <div className={`w-14 h-14 rounded-2xl flex items-center justify-center ${entry.type === 'feeding'
                                                                                                    ? `${themeColors.primaryLight} ${themeColors.primaryBorder} border-2`
                                                                                                    : 'bg-emerald-100 border-2 border-emerald-200'
                                                                                                    }`}>
                                                                                                    {entry.type === 'feeding' ? (
                                                                                                        <i className={`fas fa-bottle-water ${themeColors.primaryText} text-xl`}></i>
                                                                                                    ) : (
                                                                                                        <i className="fas fa-baby text-emerald-600 text-xl"></i>
                                                                                                    )}


                                                                                                </div>

                                                                                                <div className="flex-1 min-w-0">
                                                                                                    <div className="flex items-center gap-2 mb-1 flex-wrap">
                                                                                                        <h4 className="font-bold text-gray-900 text-lg">
                                                                                                            {entry.type === 'feeding' ? 'Biberon' : 'Change'}
                                                                                                        </h4>

                                                                                                        <div className={`px-2 py-0.5 rounded-full text-xs font-medium border ${entry.type === 'feeding'
                                                                                                            ? `${themeColors.primaryLight} ${themeColors.primaryText} ${themeColors.primaryBorder}`
                                                                                                            : 'bg-emerald-50 text-emerald-700 border-emerald-200'
                                                                                                            }`}>
                                                                                                            {entry.type === 'feeding' ? 'Nutrition' : 'HygiÃ¨ne'}
                                                                                                        </div>
                                                                                                    </div>

                                                                                                    <div className="flex items-center gap-2 flex-wrap">
                                                                                                        <p className={`text-sm font-medium ${timeDisplayClass}`}>
                                                                                                            {formatDateTime(entry.timestamp)}
                                                                                                        </p>

                                                                                                        {minutesAgo < 30 && (
                                                                                                            <div className="flex items-center gap-1 bg-green-50 px-2 py-0.5 rounded-full">
                                                                                                                <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                                                                                                                <span className="text-xs text-green-700 font-medium">RÃ©cent</span>
                                                                                                            </div>
                                                                                                        )}
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>

                                                                                            <div className="flex items-center gap-2 ml-2">
                                                                                                <button
                                                                                                    onClick={() => editEntry(entry.id)}
                                                                                                    className="w-9 h-9 rounded-2xl bg-blue-50 flex items-center justify-center active:scale-95 transition-transform"
                                                                                                >
                                                                                                    <i className="fas fa-edit text-sm text-blue-600"></i>
                                                                                                </button>
                                                                                                <button
                                                                                                    onClick={() => deleteEntry(entry.id)}
                                                                                                    className="w-9 h-9 rounded-2xl bg-red-50 flex items-center justify-center active:scale-95 transition-transform"
                                                                                                >
                                                                                                    <i className="fas fa-trash text-sm text-red-600"></i>
                                                                                                </button>
                                                                                            </div>
                                                                                        </div>

                                                                                        <div className="h-px bg-gradient-to-r from-transparent via-gray-200 to-transparent mb-4 opacity-60"></div>

                                                                                        <div className="space-y-3">
                                                                                            {entry.type === 'feeding' && entry.amount && (
                                                                                                <div className="flex items-center gap-3 flex-wrap">
                                                                                                    <div className={`flex items-center gap-2 px-4 py-2 rounded-2xl ${themeColors.primaryLight} ${themeColors.primaryBorder} border`}>
                                                                                                        <i className="fas fa-tint text-sm opacity-70"></i>
                                                                                                        <span className="font-bold text-base">{entry.amount}ml</span>
                                                                                                    </div>
                                                                                                </div>
                                                                                            )}

                                                                                            {(entry.hasPee || entry.hasPoop) && (
                                                                                                <div className="flex items-center gap-3 flex-wrap">
                                                                                                    {entry.hasPee && (
                                                                                                        <div className="flex items-center gap-2 px-4 py-2 rounded-2xl bg-blue-100 border border-blue-200">
                                                                                                            <span className="text-base">ðŸ’§</span>
                                                                                                            <span className="font-medium text-blue-800 text-sm">Pipi</span>
                                                                                                        </div>
                                                                                                    )}
                                                                                                    {entry.hasPoop && (
                                                                                                        <div className="flex items-center gap-2 px-4 py-2 rounded-2xl bg-amber-100 border border-amber-200">
                                                                                                            {poopDisplay}
                                                                                                        </div>
                                                                                                    )}
                                                                                                </div>
                                                                                            )}
                                                                                        </div>

                                                                                        <div className="mt-4 pt-3 border-t border-gray-100">
                                                                                            <div className="flex items-center justify-between text-xs text-gray-500">
                                                                                                <span>#{entry.id.slice(-6)}</span>
                                                                                                <span>
                                                                                                    {minutesAgo < 60
                                                                                                        ? `Il y a ${minutesAgo} min`
                                                                                                        : `Il y a ${Math.floor(minutesAgo / 60)}h${minutesAgo % 60 > 0 ? `${minutesAgo % 60}min` : ''}`
                                                                                                    }
                                                                                                </span>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            );
                                                                        })()
                                                                    )}
                                                                </React.Fragment>
                                                            ))}
                                                        </>
                                                    )}

                                                    {/* Pagination */}
                                                    {totalPages > 1 && (
                                                        <div className="flex items-center justify-center gap-2 mt-4">
                                                            <button
                                                                onClick={() => setCurrentPage(Math.max(0, currentPage - 1))}
                                                                disabled={currentPage === 0}
                                                                className="px-3 py-1 rounded-lg border disabled:opacity-50"
                                                            >
                                                                â†
                                                            </button>
                                                            <span className="text-sm text-gray-600">
                                                                Page {currentPage + 1} sur {totalPages}
                                                            </span>
                                                            <button
                                                                onClick={() => setCurrentPage(Math.min(totalPages - 1, currentPage + 1))}
                                                                disabled={currentPage === totalPages - 1}
                                                                className="px-3 py-1 rounded-lg border disabled:opacity-50"
                                                            >
                                                                â†’
                                                            </button>
                                                        </div>
                                                    )}
                                                </>
                                            );
                                        })()}
                                    </div>
                                </div>

                            </>

                        )}
                        {/* Vue Profil */}
                        {currentView === 'profile' && (
                            <div className="space-y-6">
                                {/* Header Profil */}
                                <div className="bg-white/90 rounded-2xl p-6 shadow-xl border border-white/50">
                                    <div className="text-center">
                                        {/* Photo de profil */}
                                        <div className="relative mb-4">
                                            <input
                                                type="file"
                                                accept="image/*,.heic,.HEIC"
                                                onChange={async (e) => {
                                                    // UTILISER LE MÃŠME CODE QUE DANS LE HEADER POUR LA PHOTO
                                                    const file = e.target.files[0];
                                                    if (file) {
                                                        try {
                                                            let processedFile = file;
                                                            if (file.type === 'image/heic' || file.name.toLowerCase().endsWith('.heic')) {
                                                                if (window.heic2any) {
                                                                    processedFile = await heic2any({
                                                                        blob: file,
                                                                        toType: "image/jpeg",
                                                                        quality: 0.8
                                                                    });
                                                                }
                                                            }
                                                            const reader = new FileReader();
                                                            reader.onload = async (e) => {
                                                                const imageData = e.target.result;
                                                                try {
                                                                    await db.collection('families').doc(user.code).update({
                                                                        photo: imageData
                                                                    });
                                                                    setUser(prev => ({ ...prev, photo: imageData }));
                                                                } catch (error) {
                                                                    console.error('Erreur sauvegarde photo:', error);
                                                                    setUser(prev => ({ ...prev, photo: imageData }));
                                                                }
                                                            };
                                                            reader.readAsDataURL(processedFile);
                                                        } catch (error) {
                                                            console.error('Erreur traitement photo:', error);
                                                            showCustomAlert('Erreur lors du traitement de la photo');
                                                        }
                                                    }
                                                }}
                                                className="hidden"
                                                id="profile-photo-upload"
                                            />
                                            <label
                                                htmlFor="profile-photo-upload"
                                                className="group block w-32 h-32 rounded-full overflow-hidden cursor-pointer border-4 border-white shadow-xl mx-auto relative"
                                            >
                                                {user?.photo ? (
                                                    <>
                                                        <img
                                                            src={user.photo}
                                                            alt={user.babyName}
                                                            className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-200"
                                                        />
                                                        <div className="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center">
                                                            <i className="fas fa-camera text-white text-lg"></i>
                                                        </div>
                                                    </>
                                                ) : (
                                                    <div
                                                        className="w-full h-full flex items-center justify-center text-4xl group-hover:scale-105 transition-transform duration-200 relative"
                                                        style={{
                                                            background: `linear-gradient(135deg, ${user?.gender === 'girl' ? '#ec4899' : '#3b82f6'} 0%, ${user?.gender === 'girl' ? '#f472b6' : '#6366f1'} 100%)`
                                                        }}
                                                    >
                                                        <span className="text-white">
                                                            {user?.gender === 'girl' ? 'ðŸ‘§' : 'ðŸ‘¦'}
                                                        </span>
                                                        <div className="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center">
                                                            <i className="fas fa-plus text-white text-lg"></i>
                                                        </div>
                                                    </div>
                                                )}
                                            </label>
                                        </div>

                                        {/* Informations bÃ©bÃ© */}
                                        <h1 className="text-2xl font-bold text-gray-900 mb-2">{user?.babyName}</h1>
                                        <div className="flex items-center justify-center gap-4 text-sm text-gray-600 mb-4">
                                            <div className="flex items-center gap-2">
                                                <i className={`fas ${user?.gender === 'girl' ? 'fa-venus' : 'fa-mars'} ${user?.gender === 'girl' ? 'text-pink-500' : 'text-blue-500'}`}></i>
                                                <span className="capitalize">{user?.gender === 'girl' ? 'Fille' : 'GarÃ§on'}</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <i className="fas fa-birthday-cake text-yellow-500"></i>
                                                <span>
                                                    {user?.birthDate ? formatAgeDisplay(calculateAge()) : 'Date de naissance non dÃ©finie'}
                                                </span>
                                            </div>
                                        </div>

                                        {/* Stats rapides cliquables */}
                                        <div className="grid grid-cols-3 gap-4 mb-4">
                                            <button
                                                onClick={() => {
                                                    setWeightInput(currentWeight ? currentWeight.toString() : user?.birthWeight?.toString() || '');
                                                    setShowWeightModal(true);
                                                }}
                                                className="text-center p-3 rounded-xl bg-gray-50 hover:bg-gray-100 transition-colors active:scale-95"
                                            >
                                                <div className={`text-lg font-bold ${themeColors.primaryText}`}>
                                                    {user?.currentWeight ? `${user.currentWeight}kg` : `${user?.birthWeight}kg`}
                                                </div>
                                                <div className="text-xs text-gray-500">Poids actuel</div>
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setHeightInput(currentHeight ? currentHeight.toString() : user?.birthHeight?.toString() || '');
                                                    setShowHeightModal(true);
                                                }}
                                                className="text-center p-3 rounded-xl bg-gray-50 hover:bg-gray-100 transition-colors active:scale-95"
                                            >
                                                <div className={`text-lg font-bold ${themeColors.primaryText}`}>
                                                    {user?.currentHeight || user?.birthHeight}cm
                                                </div>
                                                <div className="text-xs text-gray-500">Taille actuelle</div>
                                            </button>
                                            <div className="text-center p-3 rounded-xl bg-gray-50">
                                                <div className={`text-lg font-bold ${themeColors.primaryText}`}>
                                                    {entries.filter(e => e.type === 'feeding').length}
                                                </div>
                                                <div className="text-xs text-gray-500">Biberons total</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* ParamÃ¨tres de l'application */}
                                <div className="bg-white/90 rounded-2xl p-6 shadow-xl border border-white/50">
                                    <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                        <i className="fas fa-cog text-gray-600"></i>
                                        ParamÃ¨tres de l'application
                                    </h3>

                                    <div className="space-y-4">
                                        {/* Notifications */}
                                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                            <div>
                                                <div className="font-medium text-gray-800">Notifications</div>
                                                <div className="text-sm text-gray-600">Rappels biberons</div>
                                            </div>
                                            <button
                                                onClick={() => {
                                                    if (notificationPermission !== 'granted') {
                                                        requestNotificationPermission();
                                                    } else {
                                                        setAppSettings(prev => ({ ...prev, notifications: !prev.notifications }));
                                                    }
                                                }}
                                                className={`w-12 h-6 rounded-full transition-colors relative ${appSettings.notifications ? 'bg-green-500' : 'bg-gray-300'}`}
                                            >
                                                <div className={`w-5 h-5 bg-white rounded-full absolute top-0.5 transition-transform ${appSettings.notifications ? 'translate-x-6' : 'translate-x-0.5'}`} />
                                            </button>
                                        </div>

                                        {/* Intervalle biberons */}
                                        <div className="p-3 bg-gray-50 rounded-xl">
                                            <div className="flex items-center justify-between mb-2">
                                                <div>
                                                    <div className="font-medium text-gray-800">Intervalle biberons</div>
                                                    <div className="text-sm text-gray-600">Temps entre chaque biberon</div>
                                                </div>
                                                <div className="text-lg font-bold text-blue-600">{feedingInterval}h</div>
                                            </div>
                                            <button
                                                onClick={() => {
                                                    const newInterval = prompt('Intervalle entre biberons (heures):', feedingInterval);
                                                    if (newInterval && !isNaN(newInterval)) {
                                                        setFeedingInterval(parseFloat(newInterval));
                                                        if (user) {
                                                            db.collection('families').doc(user.code).update({
                                                                feedingInterval: parseFloat(newInterval)
                                                            }).catch(console.error);
                                                        }
                                                    }
                                                }}
                                                className="w-full bg-blue-100 text-blue-700 py-2 rounded-lg text-sm font-medium"
                                            >
                                                Modifier
                                            </button>
                                        </div>

                                        {/* Export donnÃ©es */}
                                        <button
                                            onClick={() => {
                                                if (isFeatureLocked('export-pdf')) {
                                                    showUpgradeMessage('Export PDF');
                                                    return;
                                                }
                                                setShowExportMenu(true);
                                            }}
                                            className={`w-full p-3 bg-gray-50 rounded-xl flex items-center justify-between hover:bg-gray-100 transition-colors ${isFeatureLocked('export-pdf') ? 'opacity-50' : ''
                                                }`}
                                        >
                                            <div className="text-left">
                                                <div className="font-medium text-gray-800">Exporter les donnÃ©es</div>
                                                <div className="text-sm text-gray-600">PDF pour le pÃ©diatre</div>
                                            </div>
                                            <i className="fas fa-download text-gray-500"></i>
                                        </button>
                                    </div>
                                </div>

                                {/* Informations famille */}
                                <div className="bg-white/90 rounded-2xl p-6 shadow-xl border border-white/50">
                                    <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                        <i className="fas fa-users text-gray-600"></i>
                                        Informations famille
                                    </h3>

                                    <div className="space-y-3">
                                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                            <span className="text-sm font-medium text-gray-700">Code famille</span>
                                            <span className="font-mono text-sm bg-gray-200 px-2 py-1 rounded">{user?.code}</span>
                                        </div>
                                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                            <span className="text-sm font-medium text-gray-700">Parents</span>
                                            <span className="text-sm text-gray-600">{user?.parents}</span>
                                        </div>
                                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                            <span className="text-sm font-medium text-gray-700">Date de naissance</span>
                                            <span className="text-sm text-gray-600">
                                                {user?.birthDate ? new Date(user.birthDate).toLocaleDateString('fr-FR') : 'Non dÃ©finie'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Gestion des invitations */}
                                {currentPlan === 'Freemium' ? (
                                    // Message pour Freemium
                                    <div className="bg-white/90 rounded-2xl p-6 shadow-xl border border-white/50">
                                        <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                            <i className="fas fa-user-plus text-gray-600"></i>
                                            Invitations famille
                                        </h3>
                                        <div className="bg-gray-50 rounded-xl p-4 text-center">
                                            <div className="w-16 h-16 bg-gray-200 rounded-xl flex items-center justify-center mx-auto mb-4">
                                                <i className="fas fa-lock text-gray-500 text-xl"></i>
                                            </div>
                                            <h4 className="font-bold text-gray-800 mb-2">FonctionnalitÃ© VIP</h4>
                                            <p className="text-gray-600 mb-4">
                                                Invitez votre conjoint, famille ou proches Ã  rejoindre le suivi de {user?.babyName} avec un plan VIP.
                                            </p>
                                            <button
                                                onClick={() => showUpgradeMessage('Invitations famille')}
                                                className="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-xl font-bold active:scale-95 transition-transform"
                                            >
                                                Voir les plans VIP
                                            </button>
                                        </div>

                                        {/* Option pour rejoindre un autre compte */}
                                        <div className="border-t mt-6 pt-4">
                                            <h4 className="font-medium text-gray-800 mb-3">Ou rejoindre un autre compte</h4>
                                            <div className="flex gap-2">
                                                <input
                                                    type="text"
                                                    placeholder="Code d'invitation reÃ§u"
                                                    className="flex-1 px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none text-center uppercase"
                                                    maxLength="25"
                                                    onChange={(e) => setInviteCodeInput(e.target.value.toUpperCase())}
                                                    value={inviteCodeInput}
                                                />
                                                <button
                                                    onClick={() => joinWithInvite(inviteCodeInput)}
                                                    disabled={!inviteCodeInput || inviteCodeInput.length < 6}
                                                    className="px-4 py-3 bg-blue-500 text-white rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transition-transform"
                                                >
                                                    <i className="fas fa-sign-in-alt"></i>
                                                </button>
                                            </div>
                                            <div className="text-xs text-gray-500 mt-2">
                                                Saisissez un code reÃ§u pour rejoindre le compte d'une autre famille
                                            </div>
                                        </div>
                                    </div>
                                ) : currentPlan === 'Solo' ? (
                                    // Message pour Solo
                                    <div className="bg-white/90 rounded-2xl p-6 shadow-xl border border-white/50">
                                        <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                            <i className="fas fa-user text-gray-600"></i>
                                            Plan Solo
                                        </h3>
                                        <div className="bg-blue-50 rounded-xl p-4 text-center">
                                            <div className="w-16 h-16 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-4">
                                                <i className="fas fa-user text-blue-600 text-xl"></i>
                                            </div>
                                            <h4 className="font-bold text-blue-800 mb-2">Compte personnel</h4>
                                            <p className="text-blue-700 mb-4">
                                                Votre plan Solo est conÃ§u pour un utilisateur unique. Passez Ã  un plan VIP pour inviter votre famille.
                                            </p>
                                            <button
                                                onClick={() => showUpgradeMessage('Plan famille')}
                                                className="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-3 rounded-xl font-bold active:scale-95 transition-transform"
                                            >
                                                Passer au plan famille
                                            </button>
                                        </div>

                                        {/* Option pour rejoindre un autre compte */}
                                        <div className="border-t mt-6 pt-4">
                                            <h4 className="font-medium text-gray-800 mb-3">Rejoindre un autre compte</h4>
                                            <div className="flex gap-2">
                                                <input
                                                    type="text"
                                                    placeholder="Code d'invitation reÃ§u"
                                                    className="flex-1 px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none text-center uppercase"
                                                    maxLength="25"
                                                    onChange={(e) => setInviteCodeInput(e.target.value.toUpperCase())}
                                                    value={inviteCodeInput}
                                                />
                                                <button
                                                    onClick={() => joinWithInvite(inviteCodeInput)}
                                                    disabled={!inviteCodeInput || inviteCodeInput.length < 6}
                                                    className="px-4 py-3 bg-blue-500 text-white rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transition-transform"
                                                >
                                                    <i className="fas fa-sign-in-alt"></i>
                                                </button>
                                            </div>
                                            <div className="text-xs text-gray-500 mt-2">
                                                Vous quitterez votre compte Solo pour rejoindre l'autre famille
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    // Interface complÃ¨te pour Parentale et Familial
                                    <div className="bg-white/90 rounded-2xl p-6 shadow-xl border border-white/50">
                                        <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                            <i className="fas fa-user-plus text-gray-600"></i>
                                            Gestion des invitations
                                        </h3>

                                        {/* Informations sur le plan */}
                                        <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <div className="font-bold text-blue-800">Plan {currentPlan}</div>
                                                    <div className="text-sm text-blue-600">
                                                        {user?.connectedUsers?.length || 1} / {user?.maxUsers || 1} utilisateurs connectÃ©s
                                                    </div>
                                                </div>
                                                <div className="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                                    <i className="fas fa-users text-blue-600"></i>
                                                </div>
                                            </div>

                                            {/* Barre de progression des utilisateurs */}
                                            <div className="mt-3">
                                                <div className="w-full bg-blue-200 rounded-full h-2">
                                                    <div
                                                        className="bg-blue-500 rounded-full h-2 transition-all duration-500"
                                                        style={{
                                                            width: `${Math.round(((user?.connectedUsers?.length || 1) / (user?.maxUsers || 1)) * 100)}%`
                                                        }}
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        {/* Actions d'invitation */}
                                        <div className="space-y-4">
                                            {/* GÃ©nÃ©rer un code d'invitation */}
                                            {(user?.connectedUsers?.length || 1) < (user?.maxUsers || 1) ? (
                                                <div className="space-y-3">
                                                    <button
                                                        onClick={() => {
                                                            console.log('Bouton inviter cliquÃ©');
                                                            console.log('User actuel:', user);
                                                            console.log('Plan actuel:', currentPlan);
                                                            generateInviteCode();
                                                        }}
                                                        className="w-full p-4 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl flex items-center justify-center gap-3 hover:opacity-90 transition-opacity active:scale-95"
                                                    >
                                                        <i className="fas fa-plus-circle text-xl"></i>
                                                        <div className="text-left">
                                                            <div className="font-bold">Inviter quelqu'un</div>
                                                            <div className="text-sm opacity-90">GÃ©nÃ©rer un code d'invitation</div>
                                                        </div>
                                                    </button>

                                                    {/* Afficher le dernier code gÃ©nÃ©rÃ© */}
                                                    {generatedInviteCode && (
                                                        <div className="bg-green-50 border border-green-200 rounded-xl p-4">
                                                            <div className="flex items-center gap-3 mb-2">
                                                                <i className="fas fa-ticket-alt text-green-600"></i>
                                                                <span className="font-medium text-green-800">Code gÃ©nÃ©rÃ© :</span>
                                                            </div>
                                                            <div className="bg-white rounded-lg p-3 border border-green-200 mb-3">
                                                                <div className="font-mono text-lg font-bold text-center text-green-800">
                                                                    {generatedInviteCode}
                                                                </div>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                <button
                                                                    onClick={() => copyToClipboard(generatedInviteCode)}
                                                                    className="flex-1 bg-green-100 text-green-700 py-2 px-4 rounded-lg text-sm font-medium active:scale-95 transition-transform"
                                                                >
                                                                    <i className="fas fa-copy mr-2"></i>
                                                                    Copier
                                                                </button>
                                                                <button
                                                                    onClick={() => {
                                                                        const shareText = `Rejoins-moi sur BabyTrack pour suivre ${user.babyName} !\n\nCode d'invitation: ${generatedInviteCode}\n\nValable 7 jours.`;
                                                                        if (navigator.share) {
                                                                            navigator.share({
                                                                                title: 'Invitation BabyTrack',
                                                                                text: shareText,
                                                                            });
                                                                        } else {
                                                                            copyToClipboard(shareText);
                                                                        }
                                                                    }}
                                                                    className="flex-1 bg-green-100 text-green-700 py-2 px-4 rounded-lg text-sm font-medium active:scale-95 transition-transform"
                                                                >
                                                                    <i className="fas fa-share mr-2"></i>
                                                                    Partager
                                                                </button>
                                                            </div>
                                                            <div className="text-xs text-green-600 mt-2 text-center">
                                                                Valable 7 jours
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            ) : (
                                                <div className="w-full p-4 bg-gray-100 text-gray-600 rounded-xl text-center">
                                                    <i className="fas fa-users text-xl mb-2"></i>
                                                    <div className="font-medium">Limite d'utilisateurs atteinte</div>
                                                    <div className="text-sm">Votre plan {currentPlan} est complet</div>
                                                </div>
                                            )}

                                            {/* Saisie manuelle d'un code d'invitation */}
                                            <div className="border-t pt-4">
                                                <h4 className="font-medium text-gray-800 mb-3">Rejoindre un autre compte</h4>
                                                <div className="flex gap-2">
                                                    <input
                                                        type="text"
                                                        placeholder="Code d'invitation"
                                                        className="flex-1 px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none text-center uppercase"
                                                        maxLength="25"
                                                        onChange={(e) => setInviteCodeInput(e.target.value.toUpperCase())}
                                                        value={inviteCodeInput}
                                                    />
                                                    <button
                                                        onClick={() => joinWithInvite(inviteCodeInput)}
                                                        disabled={!inviteCodeInput || inviteCodeInput.length < 6}
                                                        className="px-4 py-3 bg-blue-500 text-white rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transition-transform"
                                                    >
                                                        <i className="fas fa-sign-in-alt"></i>
                                                    </button>
                                                </div>
                                                <div className="text-xs text-gray-500 mt-2">
                                                    Utilisez un code reÃ§u pour rejoindre le compte d'une autre famille
                                                </div>
                                            </div>

                                            {/* Liste des utilisateurs connectÃ©s */}
                                            {user?.connectedUsers && user.connectedUsers.length > 1 && (
                                                <div className="border-t pt-4">
                                                    <h4 className="font-medium text-gray-800 mb-3">Utilisateurs connectÃ©s</h4>
                                                    <div className="space-y-2">
                                                        {user.connectedUsers.map((connectedUser, index) => (
                                                            <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                                                <div className="flex items-center gap-3">
                                                                    <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                                                        <i className="fas fa-user text-blue-600 text-sm"></i>
                                                                    </div>
                                                                    <div>
                                                                        <div className="font-medium text-gray-800">
                                                                            {index === 0 ? 'PropriÃ©taire' : `Utilisateur ${index + 1}`}
                                                                        </div>
                                                                        <div className="text-xs text-gray-500">
                                                                            Rejoint le {new Date(connectedUser.joinedAt).toLocaleDateString('fr-FR')}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div className="flex items-center gap-2">
                                                                    {index === 0 && (
                                                                        <div className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium">
                                                                            Principal
                                                                        </div>
                                                                    )}
                                                                    {index > 0 && (
                                                                        <button
                                                                            onClick={() => {
                                                                                if (confirm('Retirer cet utilisateur du compte ?')) {
                                                                                    // Logique pour retirer un utilisateur
                                                                                    const updatedUsers = user.connectedUsers.filter((_, i) => i !== index);
                                                                                    db.collection('families').doc(user.code).update({
                                                                                        connectedUsers: updatedUsers
                                                                                    }).then(() => {
                                                                                        setUser(prev => ({ ...prev, connectedUsers: updatedUsers }));
                                                                                    });
                                                                                }
                                                                            }}
                                                                            className="text-red-500 hover:text-red-700 p-1"
                                                                        >
                                                                            <i className="fas fa-times text-xs"></i>
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                                {/* Bouton dÃ©connexion */}
                                <button
                                    onClick={logout}
                                    className="w-full bg-red-500 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-transform"
                                >
                                    Se dÃ©connecter
                                </button>
                                {/* Indicateur de plan */}
                                <div className={`p-4 rounded-xl border-2 ${currentPlan === 'Solo' ? 'bg-green-50 border-green-200' :
                                    currentPlan === 'Freemium' ? 'bg-blue-50 border-blue-200' :
                                        'bg-purple-50 border-purple-200'
                                    }`}>
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <div className="font-bold text-gray-800">Plan {currentPlan}</div>
                                            <div className="text-sm text-gray-600">
                                                {currentPlan === 'Solo' && trialInfo?.isActive && 'Essai gratuit en cours'}
                                                {currentPlan === 'Freemium' && 'FonctionnalitÃ©s de base'}
                                                {currentPlan === 'Premium' && 'AccÃ¨s complet'}
                                            </div>
                                        </div>
                                        <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${currentPlan === 'Solo' ? 'bg-green-100' :
                                            currentPlan === 'Freemium' ? 'bg-blue-100' :
                                                'bg-purple-100'
                                            }`}>
                                            <i className={`fas ${currentPlan === 'Solo' ? 'fa-gift text-green-600' :
                                                currentPlan === 'Freemium' ? 'fa-user text-blue-600' :
                                                    'fa-crown text-purple-600'
                                                }`}></i>
                                        </div>
                                    </div>

                                    {trialInfo?.isActive && trialTimeRemaining && (
                                        <div className="mt-3">
                                            <div className="text-xs font-medium text-gray-600 mb-1">
                                                Temps restant : {formatTimeRemaining(trialTimeRemaining)}
                                            </div>
                                            <div className="bg-gray-200 rounded-full h-1.5">
                                                <div
                                                    className={`${user?.gender === 'girl' ? 'bg-pink-500' : 'bg-blue-500'} rounded-full h-1.5 transition-all duration-1000`}
                                                    style={{
                                                        width: `${Math.max(0, (trialTimeRemaining.total / (7 * 24 * 60 * 60 * 1000)) * 100)}%`
                                                    }}
                                                />
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        {/* Vue Analytics/Graphiques */}
                        {currentView === 'analytics' && (
                            <div className="space-y-6">
                                <div className="flex items-center justify-between">
                                    <h2 className="text-xl font-bold text-gray-800">Historique</h2>
                                    <button
                                        onClick={() => {
                                            if (isFeatureLocked('export-pdf')) {
                                                alert('FonctionnalitÃ© VIP - Export PDF disponible avec un plan payant');
                                                return;
                                            }
                                            setShowExportMenu(true);
                                        }}
                                        className="bg-blue-500 text-white px-4 py-2 rounded-xl text-sm font-medium shadow-lg flex items-center gap-2"
                                    >
                                        <i className="fas fa-download"></i>
                                        Export PDF
                                    </button>

                                </div>
                                {/* PÃ©riode d'analyse */}
                                <div className="bg-white/90 rounded-2xl p-4 shadow-xl border border-white/50">
                                    <div className="grid grid-cols-2 gap-2">
                                        {[
                                            { value: 'daily', label: 'Aujourd\'hui' },
                                            { value: 'yesterday', label: 'Hier' },
                                            { value: 'weekly', label: '7 jours' },
                                            { value: 'monthly', label: '30 jours' }
                                        ].map(period => (
                                            <button
                                                key={period.value}
                                                onClick={() => setAnalyticsPeriod(period.value)}
                                                className={`py-2 px-3 rounded-xl text-sm font-medium ${analyticsPeriod === period.value
                                                    ? `${themeColors.primaryBg} text-white`
                                                    : 'bg-gray-100 text-gray-600'
                                                    }`}
                                            >
                                                {period.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>


                                {/* Filtres de donnÃ©es - sous le graphique */}
                                <div className="bg-white/90 rounded-2xl p-4 shadow-xl border border-white/50">
                                    <h3 className="font-bold text-gray-900 mb-3 text-sm">DonnÃ©es Ã  afficher</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {[
                                            { key: 'feeding', label: 'Biberons', color: 'blue' },
                                            { key: 'diaper', label: 'Changes', color: 'green' },
                                            { key: 'breastfeeding', label: 'TÃ©tÃ©es', color: 'pink' },
                                            { key: 'breastpump', label: 'Tire-lait', color: 'purple' },
                                            { key: 'sleep', label: 'Sommeil', color: 'indigo' }
                                        ].map(filter => (
                                            <button
                                                key={filter.key}
                                                onClick={() => {
                                                    setAnalyticsFilter(prev =>
                                                        prev.includes(filter.key)
                                                            ? prev.filter(f => f !== filter.key)
                                                            : [...prev, filter.key]
                                                    );
                                                }}
                                                className={`px-3 py-1 rounded-full text-xs font-medium border transition-all ${analyticsFilter.includes(filter.key)
                                                    ? `bg-${filter.color}-100 border-${filter.color}-300 text-${filter.color}-800`
                                                    : 'bg-gray-100 border-gray-200 text-gray-600'
                                                    }`}
                                            >
                                                {filter.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Statistiques rÃ©sumÃ©es */}
                                <div className="grid grid-cols-2 gap-3">
                                    {analyticsFilter.includes('feeding') && (
                                        <div className="bg-white/90 rounded-2xl p-4 shadow-xl border border-white/50">
                                            <div className="flex items-center gap-3 mb-2">
                                                <div className="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                                    <i className="fas fa-bottle-water text-blue-600"></i>
                                                </div>
                                                <div>
                                                    <div className="text-lg font-bold text-blue-600">{getFeedingStats().total}ml</div>
                                                    <div className="text-xs text-gray-500">Lait total</div>
                                                </div>
                                            </div>
                                            <div className="text-sm text-gray-600">
                                                {getFeedingStats().count} biberons â€¢ Moy: {getFeedingStats().average}ml
                                            </div>
                                        </div>
                                    )}

                                    {analyticsFilter.includes('diaper') && (<div className="bg-white/90 rounded-2xl p-4 shadow-xl border border-white/50">
                                        <div className="flex items-center gap-3 mb-2">
                                            <div className="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                                                <i className="fas fa-baby text-green-600"></i>
                                            </div>
                                            <div>
                                                <div className="text-lg font-bold text-green-600">{getDiaperStats().total}</div>
                                                <div className="text-xs text-gray-500">Changes total</div>
                                            </div>
                                        </div>
                                        <div className="text-sm text-gray-600">
                                            {getDiaperStats().pees} pipis â€¢ {getDiaperStats().poops} cacas
                                        </div>
                                    </div>
                                    )}

                                    {analyticsFilter.includes('breastfeeding') && getBreastfeedingStatsForAnalytics().sessions > 0 && (
                                        <div className="bg-white/90 rounded-2xl p-4 shadow-xl border border-white/50">
                                            <div className="flex items-center gap-3 mb-2">
                                                <div className="w-10 h-10 bg-pink-100 rounded-xl flex items-center justify-center">
                                                    <i className="fas fa-heart text-pink-600"></i>
                                                </div>
                                                <div>
                                                    <div className="text-lg font-bold text-pink-600">{getBreastfeedingStatsForAnalytics().totalMinutes}min</div>
                                                    <div className="text-xs text-gray-500">Allaitement total</div>
                                                </div>
                                            </div>
                                            <div className="text-sm text-gray-600">
                                                {getBreastfeedingStatsForAnalytics().sessions} tÃ©tÃ©es â€¢ Moy: {getBreastfeedingStatsForAnalytics().averageMinutes}min
                                            </div>
                                        </div>
                                    )}

                                    {analyticsFilter.includes('breastpump') && getBreastPumpStatsForAnalytics().sessions > 0 && (
                                        <div className="bg-white/90 rounded-2xl p-4 shadow-xl border border-white/50">
                                            <div className="flex items-center gap-3 mb-2">
                                                <div className="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                                                    <i className="fas fa-pump-soap text-purple-600"></i>
                                                </div>
                                                <div>
                                                    <div className="text-lg font-bold text-purple-600">{getBreastPumpStatsForAnalytics().totalVolume}ml</div>
                                                    <div className="text-xs text-gray-500">Lait tirÃ© total</div>
                                                </div>
                                            </div>
                                            <div className="text-sm text-gray-600">
                                                {getBreastPumpStatsForAnalytics().sessions} sessions â€¢ Moy: {getBreastPumpStatsForAnalytics().averageVolume}ml
                                            </div>
                                        </div>
                                    )}

                                    {analyticsFilter.includes('sleep') && (
                                        <div className="bg-white/90 rounded-2xl p-4 shadow-xl border border-white/50 col-span-2">
                                            <div className="flex items-center gap-3 mb-2">
                                                <div className="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                                                    <i className="fas fa-moon text-purple-600"></i>
                                                </div>
                                                <div>
                                                    <div className="text-lg font-bold text-purple-600">{getSleepStats().totalHours}h</div>
                                                    <div className="text-xs text-gray-500">Sommeil total</div>
                                                </div>
                                            </div>
                                            <div className="text-sm text-gray-600">
                                                {getSleepStats().sessions} sessions â€¢ Moy: {getSleepStats().averageHours}h/session
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {analyticsFilter.length === 0 && (
                                    <div className="bg-white/90 rounded-2xl p-8 shadow-xl border border-white/50 text-center">
                                        <div className="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                            <i className="fas fa-chart-bar text-gray-400 text-2xl"></i>
                                        </div>
                                        <p className="text-gray-500 font-medium">SÃ©lectionnez des donnÃ©es Ã  afficher</p>
                                        <p className="text-gray-400 text-sm">Choisissez les types de donnÃ©es dans les filtres ci-dessus</p>
                                    </div>
                                )}
                            </div>
                        )}
                        {showBreastfeedingModal && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4 z-50">
                                <div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl relative">
                                    {/* Header */}
                                    <div className="sticky top-0 bg-gradient-to-r from-pink-500 to-pink-600 text-white p-6 rounded-t-3xl z-10">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                                                    <i className="fas fa-heart text-xl"></i>
                                                </div>
                                                <div>
                                                    <h3 className="text-xl font-bold">Allaitement</h3>
                                                    <p className="text-sm opacity-80">Suivi des tÃ©tÃ©es</p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => setShowBreastfeedingModal(false)}
                                                className="w-10 h-10 rounded-2xl bg-white/20 flex items-center justify-center"
                                            >
                                                <i className="fas fa-times text-lg"></i>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Contenu */}
                                    <div className="p-4 space-y-4">
                                        {breastfeedingSession ? (
                                            // Session en cours
                                            <div className="text-center">
                                                <div className="w-20 h-20 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                                    <i className="fas fa-heart text-pink-600 text-2xl pulse-gentle"></i>
                                                </div>
                                                <h3 className="text-lg font-bold text-gray-900 mb-2">Allaitement en cours</h3>
                                                <p className="text-sm text-gray-600 mb-1">
                                                    {breastfeedingSession.breast === 'left' ? 'Sein gauche' :
                                                        breastfeedingSession.breast === 'right' ? 'Sein droit' : 'Les deux seins'}
                                                </p>
                                                <p className="text-sm text-gray-600 mb-4">
                                                    DÃ©marrÃ© Ã  {formatTime(breastfeedingSession.startTime)}
                                                </p>
                                                <button
                                                    onClick={stopBreastfeeding}
                                                    className="w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-4 rounded-2xl font-bold active:scale-95 transition-transform"
                                                >
                                                    ArrÃªter l'allaitement
                                                </button>
                                            </div>
                                        ) : (
                                            // DÃ©marrer nouvelle session
                                            <div className="space-y-4">
                                                <div className="text-center mb-6">
                                                    <div className="w-16 h-16 bg-pink-100 rounded-2xl flex items-center justify-center mx-auto mb-3">
                                                        <i className="fas fa-heart text-pink-600 text-2xl"></i>
                                                    </div>
                                                    <h3 className="text-lg font-bold text-gray-900 mb-2">Nouvelle tÃ©tÃ©e</h3>
                                                    <p className="text-sm text-gray-600">Choisissez le sein pour commencer</p>
                                                </div>

                                                {/* Choix du sein */}
                                                <div className="grid grid-cols-2 gap-3 mb-6">
                                                    <button
                                                        onClick={() => startBreastfeeding('left')}
                                                        className="p-4 rounded-2xl border-2 border-pink-200 bg-pink-50 hover:bg-pink-100 transition-all active:scale-95"
                                                    >
                                                        <div className="text-2xl mb-2">ðŸ¤±</div>
                                                        <div className="font-semibold text-pink-800">Sein gauche</div>
                                                    </button>
                                                    <button
                                                        onClick={() => startBreastfeeding('right')}
                                                        className="p-4 rounded-2xl border-2 border-pink-200 bg-pink-50 hover:bg-pink-100 transition-all active:scale-95"
                                                    >
                                                        <div className="text-2xl mb-2">ðŸ¤±</div>
                                                        <div className="font-semibold text-pink-800">Sein droit</div>
                                                    </button>
                                                </div>

                                                {/* Saisie manuelle */}
                                                <div className="border-t pt-6">
                                                    <h4 className="font-semibold text-gray-800 mb-4">Ou saisie manuelle</h4>

                                                    <div className="space-y-4">
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700 mb-2">Sein utilisÃ©</label>
                                                            <div className="grid grid-cols-3 gap-2">
                                                                {[
                                                                    { value: 'left', label: 'Gauche', emoji: 'ðŸ‘ˆ' },
                                                                    { value: 'right', label: 'Droit', emoji: 'ðŸ‘‰' },
                                                                    { value: 'both', label: 'Les deux', emoji: 'ðŸ¤²' }
                                                                ].map(option => (
                                                                    <button
                                                                        key={option.value}
                                                                        type="button"
                                                                        onClick={() => setBreastfeedingData(prev => ({ ...prev, breast: option.value }))}
                                                                        className={`p-3 rounded-xl border-2 transition-all text-center ${breastfeedingData.breast === option.value
                                                                            ? 'bg-pink-100 border-pink-300 text-pink-800'
                                                                            : 'bg-gray-50 border-gray-200 text-gray-600'
                                                                            }`}
                                                                    >
                                                                        <div className="text-lg mb-1">{option.emoji}</div>
                                                                        <div className="text-xs font-medium">{option.label}</div>
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        </div>

                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700 mb-2">DurÃ©e (minutes)</label>
                                                            <input
                                                                type="number"
                                                                placeholder="15"
                                                                className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-pink-500 focus:outline-none"
                                                                value={breastfeedingData.duration}
                                                                onChange={(e) => setBreastfeedingData(prev => ({ ...prev, duration: e.target.value }))}
                                                            />
                                                        </div>

                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700 mb-2">Notes (optionnel)</label>
                                                            <textarea
                                                                className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-pink-500 focus:outline-none"
                                                                rows="2"
                                                                placeholder="Observations..."
                                                                value={breastfeedingData.notes}
                                                                onChange={(e) => setBreastfeedingData(prev => ({ ...prev, notes: e.target.value }))}
                                                            />
                                                        </div>

                                                        <button
                                                            onClick={saveBreastfeedingManual}
                                                            className="w-full bg-gradient-to-r from-pink-500 to-pink-600 text-white py-4 rounded-2xl font-bold active:scale-95 transition-transform"
                                                        >
                                                            Enregistrer la tÃ©tÃ©e
                                                        </button>
                                                    </div>
                                                </div>

                                                {/* DerniÃ¨res tÃ©tÃ©es */}
                                                {breastfeedingEntries.length > 0 && (
                                                    <div className="border-t pt-6">
                                                        <h4 className="font-semibold text-gray-800 mb-3">DerniÃ¨res tÃ©tÃ©es</h4>
                                                        <div className="space-y-2 max-h-32 overflow-y-auto">
                                                            {breastfeedingEntries.slice(0, 3).map(entry => (
                                                                <div key={entry.id} className="bg-pink-50 rounded-xl p-3 border border-pink-200">
                                                                    <div className="flex items-center justify-between">
                                                                        <div>
                                                                            <div className="font-medium text-pink-800">
                                                                                {entry.breast === 'left' ? 'Sein gauche' :
                                                                                    entry.breast === 'right' ? 'Sein droit' : 'Les deux seins'}
                                                                                {entry.duration && ` - ${entry.duration}min`}
                                                                            </div>
                                                                            <div className="text-xs text-pink-600">
                                                                                {formatDateTime(entry.timestamp)}
                                                                            </div>
                                                                        </div>
                                                                        <button
                                                                            onClick={() => deleteBreastfeedingEntry(entry.id)}
                                                                            className="text-red-500 hover:text-red-700 p-1"
                                                                        >
                                                                            <i className="fas fa-trash text-xs"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* Modal Tire-lait */}
                        {showBreastPumpModal && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4 z-50">
                                <div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl max-h-[90vh] overflow-y-auto relative">
                                    {/* Header */}
                                    <div className="sticky top-0 bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-t-3xl z-10">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                                                    <i className="fas fa-pump-soap text-xl"></i>
                                                </div>
                                                <div>
                                                    <h3 className="text-xl font-bold">Tire-lait</h3>
                                                    <p className="text-sm opacity-80">Suivi du pompage</p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => setShowBreastPumpModal(false)}
                                                className="w-10 h-10 rounded-2xl bg-white/20 flex items-center justify-center"
                                            >
                                                <i className="fas fa-times text-lg"></i>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Contenu */}
                                    <div className="p-6 space-y-6">
                                        <div className="text-center mb-6">
                                            <div className="w-16 h-16 bg-purple-100 rounded-2xl flex items-center justify-center mx-auto mb-3">
                                                <i className="fas fa-pump-soap text-purple-600 text-2xl"></i>
                                            </div>
                                            <h3 className="text-lg font-bold text-gray-900 mb-2">Session de tire-lait</h3>
                                            <p className="text-sm text-gray-600">Enregistrez votre session</p>
                                        </div>

                                        <div className="space-y-4">
                                            {/* Volume */}
                                            <div>
                                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                    Volume extrait (ml) *
                                                </label>
                                                <div className="relative">
                                                    <input
                                                        type="number"
                                                        placeholder="120"
                                                        className="w-full px-4 py-3 pr-12 rounded-2xl border-2 border-gray-200 focus:border-purple-500 focus:outline-none text-lg font-bold text-center"
                                                        value={breastPumpData.volume}
                                                        onChange={(e) => setBreastPumpData(prev => ({ ...prev, volume: e.target.value }))}
                                                    />
                                                    <span className="absolute right-4 top-4 text-gray-500 font-medium">ml</span>
                                                </div>
                                            </div>

                                            {/* DurÃ©e */}
                                            <div>
                                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                    DurÃ©e de pompage (minutes) *
                                                </label>
                                                <div className="relative">
                                                    <input
                                                        type="number"
                                                        placeholder="20"
                                                        className="w-full px-4 py-3 pr-16 rounded-2xl border-2 border-gray-200 focus:border-purple-500 focus:outline-none text-lg font-bold text-center"
                                                        value={breastPumpData.duration}
                                                        onChange={(e) => setBreastPumpData(prev => ({ ...prev, duration: e.target.value }))}
                                                    />
                                                    <span className="absolute right-4 top-4 text-gray-500 font-medium">min</span>
                                                </div>
                                            </div>

                                            {/* Conservation */}
                                            <div>
                                                <label className="block text-sm font-semibold text-gray-700 mb-2">Conservation</label>
                                                <div className="grid grid-cols-3 gap-2">
                                                    {[
                                                        { value: 'immediate', label: 'ImmÃ©diat', emoji: 'ðŸ¼' },
                                                        { value: 'fridge', label: 'Frigo', emoji: 'â„ï¸' },
                                                        { value: 'freezer', label: 'CongÃ©lateur', emoji: 'ðŸ§Š' }
                                                    ].map(option => (
                                                        <button
                                                            key={option.value}
                                                            type="button"
                                                            onClick={() => setBreastPumpData(prev => ({ ...prev, storage: option.value }))}
                                                            className={`p-3 rounded-xl border-2 transition-all text-center ${breastPumpData.storage === option.value
                                                                ? 'bg-purple-100 border-purple-300 text-purple-800'
                                                                : 'bg-gray-50 border-gray-200 text-gray-600'
                                                                }`}
                                                        >
                                                            <div className="text-lg mb-1">{option.emoji}</div>
                                                            <div className="text-xs font-medium mb-1">{option.label}</div>
                                                            <div className="text-xs text-gray-500">{option.desc}</div>
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>

                                            {/* Notes */}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Notes (optionnel)</label>
                                                <textarea
                                                    className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-purple-500 focus:outline-none"
                                                    rows="2"
                                                    placeholder="Observations, conditions..."
                                                    value={breastPumpData.notes}
                                                    onChange={(e) => setBreastPumpData(prev => ({ ...prev, notes: e.target.value }))}
                                                />
                                            </div>

                                            <button
                                                onClick={saveBreastPumpEntry}
                                                className="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white py-4 rounded-2xl font-bold active:scale-95 transition-transform"
                                            >
                                                Enregistrer la session
                                            </button>
                                        </div>

                                        {/* DerniÃ¨res sessions */}
                                        {breastPumpEntries.length > 0 && (
                                            <div className="border-t pt-6">
                                                <h4 className="font-semibold text-gray-800 mb-3">DerniÃ¨res sessions</h4>
                                                <div className="space-y-2 max-h-40 overflow-y-auto">
                                                    {breastPumpEntries.slice(0, 3).map(entry => (
                                                        <div key={entry.id} className="bg-purple-50 rounded-xl p-3 border border-purple-200">
                                                            <div className="flex items-center justify-between">
                                                                <div>
                                                                    <div className="font-medium text-purple-800">
                                                                        {entry.volume}ml en {entry.duration}min
                                                                    </div>
                                                                    <div className="text-xs text-purple-600 flex items-center gap-2">
                                                                        <span>{formatDateTime(entry.timestamp)}</span>
                                                                        <span className="w-1 h-1 bg-purple-400 rounded-full"></span>
                                                                        <span className="capitalize">
                                                                            {entry.storage === 'immediate' ? 'ImmÃ©diat' :
                                                                                entry.storage === 'fridge' ? 'Frigo' : 'CongÃ©lateur'}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                                <button
                                                                    onClick={() => deleteBreastPumpEntry(entry.id)}
                                                                    className="text-red-500 hover:text-red-700 p-1"
                                                                >
                                                                    <i className="fas fa-trash text-xs"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* Modal Poids */}
                        {showWeightModal && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4 z-50">
                                <div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl max-h-[90vh] overflow-y-auto relative">
                                    <div className="sticky top-0 bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-t-3xl z-10">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                                                    <i className="fas fa-weight text-xl"></i>
                                                </div>
                                                <div>
                                                    <h3 className="text-xl font-bold">Mise Ã  jour du poids</h3>
                                                    <p className="text-sm opacity-80">Poids actuel de {user?.babyName}</p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => setShowWeightModal(false)}
                                                className="w-10 h-10 rounded-2xl bg-white/20 flex items-center justify-center"
                                            >
                                                <i className="fas fa-times text-lg"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div className="p-6 space-y-6">
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                Poids actuel (kg) *
                                            </label>
                                            <div className="relative">
                                                <input
                                                    type="number"
                                                    step="0.001"
                                                    placeholder="3.500"
                                                    className="w-full px-4 py-3 pr-12 rounded-2xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none text-lg font-bold text-center"
                                                    value={weightInput}
                                                    onChange={(e) => setWeightInput(e.target.value)}
                                                />
                                                <span className="absolute right-4 top-4 text-gray-500 font-medium">kg</span>
                                            </div>
                                        </div>

                                        <button
                                            onClick={saveWeight}
                                            className="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 rounded-2xl font-bold active:scale-95 transition-transform"
                                        >
                                            Mettre Ã  jour le poids
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Modal Taille */}
                        {showHeightModal && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4 z-50">
                                <div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl max-h-[90vh] overflow-y-auto relative">
                                    <div className="sticky top-0 bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-t-3xl z-10">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                                                    <i className="fas fa-ruler text-xl"></i>
                                                </div>
                                                <div>
                                                    <h3 className="text-xl font-bold">Mise Ã  jour de la taille</h3>
                                                    <p className="text-sm opacity-80">Taille actuelle de {user?.babyName}</p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => setShowHeightModal(false)}
                                                className="w-10 h-10 rounded-2xl bg-white/20 flex items-center justify-center"
                                            >
                                                <i className="fas fa-times text-lg"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div className="p-6 space-y-6">
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                Taille actuelle (cm) *
                                            </label>
                                            <div className="relative">
                                                <input
                                                    type="number"
                                                    step="0.1"
                                                    placeholder="52.5"
                                                    className="w-full px-4 py-3 pr-12 rounded-2xl border-2 border-gray-200 focus:border-green-500 focus:outline-none text-lg font-bold text-center"
                                                    value={heightInput}
                                                    onChange={(e) => setHeightInput(e.target.value)}
                                                />
                                                <span className="absolute right-4 top-4 text-gray-500 font-medium">cm</span>
                                            </div>
                                        </div>

                                        <button
                                            onClick={saveHeight}
                                            className="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-2xl font-bold active:scale-95 transition-transform"
                                        >
                                            Mettre Ã  jour la taille
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* Modal Sommeil */}
                        {showSleepModal && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4 z-50">
                                <div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl max-h-[90vh] overflow-y-auto relative">
                                    {/* Header */}
                                    <div className="sticky top-0 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white p-6 rounded-t-3xl z-10">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                                                    <i className="fas fa-moon text-xl"></i>
                                                </div>
                                                <div>
                                                    <h3 className="text-xl font-bold">Suivi du sommeil</h3>
                                                    <p className="text-sm opacity-80">Gestion des sessions</p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => setShowSleepModal(false)}
                                                className="w-10 h-10 rounded-2xl bg-white/20 flex items-center justify-center"
                                            >
                                                <i className="fas fa-times text-lg"></i>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Contenu */}
                                    <div className="p-6 space-y-6">
                                        {currentSleep ? (
                                            // Session en cours
                                            <div className="text-center">
                                                <div className="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                                    <i className="fas fa-moon text-indigo-600 text-2xl pulse-gentle"></i>
                                                </div>
                                                <h3 className="text-lg font-bold text-gray-900 mb-2">Sommeil en cours</h3>
                                                <p className="text-sm text-gray-600 mb-4">
                                                    DÃ©marrÃ© Ã  {formatTime(currentSleep.startTime)}
                                                </p>
                                                <button
                                                    onClick={() => {
                                                        stopSleep();
                                                        setShowSleepModal(false);
                                                    }}
                                                    className="w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-4 rounded-2xl font-bold active:scale-95 transition-transform"
                                                >
                                                    ArrÃªter le sommeil
                                                </button>
                                            </div>
                                        ) : (
                                            // DÃ©marrer nouvelle session
                                            <div className="space-y-6">
                                                <div className="text-center">
                                                    <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                                        <i className="fas fa-play text-green-600 text-2xl"></i>
                                                    </div>
                                                    <h3 className="text-lg font-bold text-gray-900 mb-2">DÃ©marrer une session</h3>
                                                    <p className="text-sm text-gray-600 mb-6">
                                                        Lancez le suivi quand {user?.babyName} s'endort
                                                    </p>

                                                    <button
                                                        onClick={() => {
                                                            startSleep();
                                                            setShowSleepModal(false);
                                                        }}
                                                        className="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-2xl font-bold mb-4 active:scale-95 transition-transform"
                                                    >
                                                        Commencer le sommeil
                                                    </button>
                                                </div>

                                                {/* Saisie manuelle */}
                                                <div className="border-t pt-6">
                                                    <h4 className="font-semibold text-gray-800 mb-4">Ou saisie manuelle</h4>

                                                    <div className="space-y-4">
                                                        {/* Date */}
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                                            <input
                                                                type="date"
                                                                className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-indigo-500 focus:outline-none"
                                                                value={sleepData.date}
                                                                onChange={(e) => setSleepData(prev => ({ ...prev, date: e.target.value }))}
                                                            />
                                                        </div>

                                                        {/* Heures */}
                                                        <div className="grid grid-cols-2 gap-3">
                                                            <div>
                                                                <label className="block text-sm font-medium text-gray-700 mb-2">DÃ©but</label>
                                                                <input
                                                                    type="time"
                                                                    className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-indigo-500 focus:outline-none"
                                                                    value={sleepData.startTime}
                                                                    onChange={(e) => setSleepData(prev => ({ ...prev, startTime: e.target.value }))}
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="block text-sm font-medium text-gray-700 mb-2">Fin</label>
                                                                <input
                                                                    type="time"
                                                                    className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-indigo-500 focus:outline-none"
                                                                    value={sleepData.endTime}
                                                                    onChange={(e) => setSleepData(prev => ({ ...prev, endTime: e.target.value }))}
                                                                />
                                                            </div>
                                                        </div>

                                                        <button
                                                            onClick={() => {
                                                                saveSleepEdit();
                                                                setShowSleepModal(false);
                                                            }}
                                                            className="w-full bg-gradient-to-r from-indigo-500 to-indigo-600 text-white py-4 rounded-2xl font-bold active:scale-95 transition-transform"
                                                        >
                                                            Enregistrer la session
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* DerniÃ¨res sessions */}
                                        {sleepSessions.filter(s => s.status === 'completed').length > 0 && (
                                            <div className="border-t pt-6">
                                                <h4 className="font-semibold text-gray-800 mb-3">DerniÃ¨res sessions</h4>
                                                <div className="space-y-2 max-h-40 overflow-y-auto">
                                                    {sleepSessions.filter(s => s.status === 'completed').slice(0, 3).map(session => (
                                                        <div key={session.id} className="bg-indigo-50 rounded-xl p-3 border border-indigo-200">
                                                            <div className="flex items-center justify-between">
                                                                <div>
                                                                    <div className="font-medium text-indigo-800">
                                                                        {formatSleepDuration(session.duration)}
                                                                    </div>
                                                                    <div className="text-xs text-indigo-600">
                                                                        {formatDateTime(session.startTime)}
                                                                    </div>
                                                                </div>
                                                                <button
                                                                    onClick={() => deleteSleepSession(session.id)}
                                                                    className="text-red-500 hover:text-red-700 p-1"
                                                                >
                                                                    <i className="fas fa-trash text-xs"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* Modal Diversification */}
                        {showFoodModal && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4 z-50">
                                <div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl max-h-[90vh] overflow-y-auto relative">
                                    {/* Header */}
                                    <div className="sticky top-0 bg-gradient-to-r from-orange-500 to-orange-600 text-white p-6 rounded-t-3xl z-10">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                                                    <i className="fas fa-utensils text-xl"></i>
                                                </div>
                                                <div>
                                                    <h3 className="text-xl font-bold">Nouvel aliment</h3>
                                                    <p className="text-sm opacity-80">Diversification alimentaire</p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => setShowFoodModal(false)}
                                                className="w-10 h-10 rounded-2xl bg-white/20 flex items-center justify-center"
                                            >
                                                <i className="fas fa-times text-lg"></i>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Contenu */}
                                    <div className="p-6 space-y-6">
                                        {/* CatÃ©gorie */}
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-3">CatÃ©gorie *</label>
                                            <div className="grid grid-cols-2 gap-3">
                                                {[
                                                    { id: 'legumes', label: 'LÃ©gumes', icon: 'fa-carrot', color: 'green' },
                                                    { id: 'fruits', label: 'Fruits', icon: 'fa-apple-alt', color: 'red' },
                                                    { id: 'viande', label: 'Viande/Poisson', icon: 'fa-drumstick-bite', color: 'purple' },
                                                    { id: 'cereales', label: 'CÃ©rÃ©ales', icon: 'fa-bread-slice', color: 'yellow' }
                                                ].map(cat => (
                                                    <button
                                                        key={cat.id}
                                                        type="button"
                                                        onClick={() => setDiversificationData(prev => ({ ...prev, category: cat.id }))}
                                                        className={`p-3 rounded-2xl border-2 transition-all ${diversificationData.category === cat.id
                                                            ? `border-${cat.color}-400 bg-${cat.color}-100`
                                                            : 'border-gray-200 bg-gray-50'
                                                            }`}
                                                    >
                                                        <div className={`text-2xl mb-2 text-${cat.color}-600`}>
                                                            <i className={`fas ${cat.icon}`}></i>
                                                        </div>
                                                        <div className="font-medium text-gray-800 text-sm">{cat.label}</div>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Nom de l'aliment */}
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">Aliment testÃ© *</label>
                                            <input
                                                type="text"
                                                className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-orange-500 focus:outline-none"
                                                placeholder="Ex: Carotte, Pomme, Courgette..."
                                                value={diversificationData.food}
                                                onChange={(e) => setDiversificationData(prev => ({ ...prev, food: e.target.value }))}
                                            />
                                        </div>

                                        {/* QuantitÃ© */}
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-3">QuantitÃ© consommÃ©e *</label>
                                            <div className="grid grid-cols-3 gap-3">
                                                {[
                                                    { id: 'petit', label: 'Petit', icon: 'ðŸ¤', desc: 'Quelques cuillÃ¨res' },
                                                    { id: 'moyen', label: 'Moyen', icon: 'ðŸ¥„', desc: 'Plusieurs cuillÃ¨res' },
                                                    { id: 'grand', label: 'Grand', icon: 'ðŸ½ï¸', desc: 'Bon appÃ©tit' }
                                                ].map(qty => (
                                                    <button
                                                        key={qty.id}
                                                        type="button"
                                                        onClick={() => setDiversificationData(prev => ({ ...prev, quantity: qty.id }))}
                                                        className={`p-3 rounded-2xl border-2 transition-all text-center ${diversificationData.quantity === qty.id
                                                            ? 'border-orange-400 bg-orange-100'
                                                            : 'border-gray-200 bg-gray-50'
                                                            }`}
                                                    >
                                                        <div className="text-2xl mb-1">{qty.icon}</div>
                                                        <div className="font-medium text-gray-800 text-sm">{qty.label}</div>
                                                        <div className="text-xs text-gray-500">{qty.desc}</div>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Remarques */}
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">Remarques (optionnel)</label>
                                            <textarea
                                                className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-orange-500 focus:outline-none"
                                                rows="3"
                                                placeholder="RÃ©action, texture donnÃ©e, commentaires..."
                                                value={diversificationData.notes}
                                                onChange={(e) => setDiversificationData(prev => ({ ...prev, notes: e.target.value }))}
                                            />
                                        </div>

                                        <button
                                            onClick={() => {
                                                if (!diversificationData.category || !diversificationData.food || !diversificationData.quantity) {
                                                    showCustomAlert('Veuillez remplir tous les champs obligatoires');
                                                    return;
                                                }
                                                saveDiversificationEntry();
                                                setShowFoodModal(false);
                                            }}
                                            className="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white py-4 rounded-2xl font-bold active:scale-95 transition-transform"
                                        >
                                            Enregistrer l'aliment
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* Modal Garde-robe */}
                        {showWardrobeModal && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4 z-50">
                                <div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl max-h-[90vh] overflow-y-auto relative">
                                    {/* Header */}
                                    <div className="sticky top-0 bg-gradient-to-r from-pink-500 to-pink-600 text-white p-6 rounded-t-3xl z-10">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                                                    <i className="fas fa-tshirt text-xl"></i>
                                                </div>
                                                <div>
                                                    <h3 className="text-xl font-bold">{editingWardrobeId ? 'Modifier l\'article' : 'Nouvel article'}</h3>
                                                    <p className="text-sm opacity-80">Garde-robe de {user?.babyName}</p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => {
                                                    setShowWardrobeModal(false);
                                                    setEditingWardrobeId(null);
                                                    setWardrobeData({ type: '', size: '', quantity: 1, notes: '' });
                                                }}
                                                className="w-10 h-10 rounded-2xl bg-white/20 flex items-center justify-center"
                                            >
                                                <i className="fas fa-times text-lg"></i>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Contenu */}
                                    <div className="p-6 space-y-6">
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">Type de vÃªtement *</label>
                                            <select
                                                className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-pink-500 focus:outline-none"
                                                value={wardrobeData.type}
                                                onChange={(e) => setWardrobeData(prev => ({ ...prev, type: e.target.value }))}
                                            >
                                                <option value="">Choisir...</option>
                                                <option value="Body manche courte">Body manche courte</option>
                                                <option value="Body manche longue">Body manche longue</option>
                                                <option value="Bonnet">Bonnet</option>
                                                <option value="Chaussettes">Chaussettes</option>
                                                <option value="Gigoteuse">Gigoteuse</option>
                                                <option value="Gilet">Gilet</option>
                                                <option value="Pantalon">Pantalon</option>
                                                <option value="Pull">Pull</option>
                                                <option value="Pyjama">Pyjama</option>
                                                <option value="Robe">Robe</option>
                                                <option value="T-shirt manche courte">T-shirt manche courte</option>
                                                <option value="T-shirt manche longue">T-shirt manche longue</option>
                                                <option value="Autre">Autre</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">Taille *</label>
                                            <select
                                                className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-pink-500 focus:outline-none"
                                                value={wardrobeData.size}
                                                onChange={(e) => setWardrobeData(prev => ({ ...prev, size: e.target.value }))}
                                            >
                                                <option value="">Choisir...</option>
                                                <option value="Naissance">Naissance</option>
                                                <option value="1 mois">1 mois</option>
                                                <option value="3 mois">3 mois</option>
                                                <option value="6 mois">6 mois</option>
                                                <option value="9 mois">9 mois</option>
                                                <option value="12 mois">12 mois</option>
                                                <option value="18 mois">18 mois</option>
                                                <option value="2 ans">2 ans</option>
                                                <option value="3 ans">3 ans</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">QuantitÃ©</label>
                                            <input
                                                type="number"
                                                min="1"
                                                className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-pink-500 focus:outline-none"
                                                value={wardrobeData.quantity}
                                                onChange={(e) => setWardrobeData(prev => ({ ...prev, quantity: e.target.value }))}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">Notes</label>
                                            <textarea
                                                className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-pink-500 focus:outline-none"
                                                rows="3"
                                                placeholder="Couleur, marque, Ã©tat..."
                                                value={wardrobeData.notes}
                                                onChange={(e) => setWardrobeData(prev => ({ ...prev, notes: e.target.value }))}
                                            />
                                        </div>

                                        <button
                                            onClick={() => {
                                                saveWardrobeItem();
                                                setShowWardrobeModal(false);
                                            }}
                                            className="w-full bg-gradient-to-r from-pink-500 to-pink-600 text-white py-4 rounded-2xl font-bold active:scale-95 transition-transform"
                                        >
                                            {editingWardrobeId ? 'Mettre Ã  jour' : 'Ajouter Ã  la garde-robe'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* Modal Liste de cadeaux - Version simplifiÃ©e */}
                        {showGiftModal && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4 z-50">
                                <div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl max-h-[90vh] overflow-y-auto relative">
                                    <div className="sticky top-0 bg-gradient-to-r from-red-500 to-red-600 text-white p-6 rounded-t-3xl z-10">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                                                    <i className="fas fa-gift text-xl"></i>
                                                </div>
                                                <div>
                                                    <h3 className="text-xl font-bold">Nouveau cadeau</h3>
                                                    <p className="text-sm opacity-80">Remplissez les informations</p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => {
                                                    setShowGiftModal(false);
                                                    setEditingGiftId(null);
                                                    setGiftData({ url: '', name: '', price: '', image: '', reserved: false, notes: '' });
                                                }}
                                                className="w-10 h-10 rounded-2xl bg-white/20 flex items-center justify-center"
                                            >
                                                <i className="fas fa-times text-lg"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div className="p-6 space-y-4">
                                        {/* Instructions */}
                                        <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
                                            <div className="flex items-start gap-3">
                                                <i className="fas fa-info-circle text-blue-600 mt-0.5"></i>
                                                <div className="text-sm text-blue-800">
                                                    <p className="font-semibold mb-1">Comment ajouter un cadeau :</p>
                                                    <ol className="list-decimal ml-4 space-y-1 text-xs">
                                                        <li>Trouvez le produit sur le site marchand</li>
                                                        <li>Copiez l'URL de la page</li>
                                                        <li>Clic droit sur l'image â†’ "Copier l'adresse de l'image"</li>
                                                        <li>Collez dans le champ "URL de l'image"</li>
                                                    </ol>
                                                </div>
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                Nom du produit *
                                            </label>
                                            <input
                                                type="text"
                                                className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-red-500 focus:outline-none"
                                                placeholder="Ex: Peluche lapin blanc"
                                                value={giftData.name}
                                                onChange={(e) => setGiftData(prev => ({ ...prev, name: e.target.value }))}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                Prix *
                                            </label>
                                            <input
                                                type="text"
                                                className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-red-500 focus:outline-none"
                                                placeholder="Ex: 29,99â‚¬"
                                                value={giftData.price}
                                                onChange={(e) => setGiftData(prev => ({ ...prev, price: e.target.value }))}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                Lien du produit *
                                            </label>
                                            <input
                                                type="url"
                                                className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-red-500 focus:outline-none text-sm"
                                                placeholder="https://www.amazon.fr/..."
                                                value={giftData.url}
                                                onChange={(e) => setGiftData(prev => ({ ...prev, url: e.target.value }))}
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                URL de l'image du produit
                                            </label>
                                            <input
                                                type="url"
                                                className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-red-500 focus:outline-none text-sm"
                                                placeholder="https://...image.jpg"
                                                value={giftData.image}
                                                onChange={(e) => setGiftData(prev => ({ ...prev, image: e.target.value }))}
                                            />
                                            {giftData.image && (
                                                <div className="mt-2 rounded-xl overflow-hidden border-2 border-gray-200">
                                                    <img
                                                        src={giftData.image}
                                                        alt="AperÃ§u"
                                                        className="w-full h-32 object-cover"
                                                        onError={(e) => {
                                                            e.target.style.display = 'none';
                                                        }}
                                                    />
                                                </div>
                                            )}
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                Notes (optionnel)
                                            </label>
                                            <textarea
                                                className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-red-500 focus:outline-none"
                                                rows="2"
                                                placeholder="Taille, couleur, remarques..."
                                                value={giftData.notes}
                                                onChange={(e) => setGiftData(prev => ({ ...prev, notes: e.target.value }))}
                                            />
                                        </div>

                                        <button
                                            onClick={saveGift}
                                            disabled={!giftData.name || !giftData.price || !giftData.url}
                                            className="w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-4 rounded-2xl font-bold active:scale-95 transition-transform disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            Ajouter Ã  la liste
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* Modal Lait en poudre */}
                        {showMilkStockModal && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4 z-50">
                                <div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl max-h-[90vh] overflow-y-auto relative">
                                    {/* Header */}
                                    <div className="sticky top-0 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white p-6 rounded-t-3xl z-10">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                                                    <i className="fas fa-baby text-xl"></i>
                                                </div>
                                                <div>
                                                    <h3 className="text-xl font-bold">Lait en poudre</h3>
                                                    <p className="text-sm opacity-80">Date d'ouverture</p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => setShowMilkStockModal(false)}
                                                className="w-10 h-10 rounded-2xl bg-white/20 flex items-center justify-center"
                                            >
                                                <i className="fas fa-times text-lg"></i>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Contenu */}
                                    <div className="p-6 space-y-6">
                                        <div className="text-center mb-6">
                                            <div className="w-16 h-16 bg-yellow-100 rounded-2xl flex items-center justify-center mx-auto mb-3">
                                                <i className="fas fa-baby text-yellow-600 text-2xl"></i>
                                            </div>
                                            <h3 className="text-lg font-bold text-gray-900 mb-2">Date d'ouverture</h3>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                Date d'ouverture *
                                            </label>
                                            <input
                                                type="date"
                                                className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-yellow-500 focus:outline-none text-lg font-bold text-center"
                                                value={milkDateInput}
                                                onChange={(e) => setMilkDateInput(e.target.value)}
                                            />
                                        </div>



                                        <button
                                            onClick={saveMilkPowderDate}
                                            className="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-white py-4 rounded-2xl font-bold active:scale-95 transition-transform"
                                        >
                                            Enregistrer la date
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* Modal Bouteille d'eau */}
                        {showWaterStockModal && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4 z-50">
                                <div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl max-h-[90vh] overflow-y-auto relative">
                                    {/* Header */}
                                    <div className="sticky top-0 bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-t-3xl z-10">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                                                    <i className="fas fa-tint text-xl"></i>
                                                </div>
                                                <div>
                                                    <h3 className="text-xl font-bold">Bouteille d'eau</h3>
                                                    <p className="text-sm opacity-80">Date et heure d'ouverture</p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => setShowWaterStockModal(false)}
                                                className="w-10 h-10 rounded-2xl bg-white/20 flex items-center justify-center"
                                            >
                                                <i className="fas fa-times text-lg"></i>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Contenu */}
                                    <div className="p-6 space-y-6">
                                        <div className="text-center mb-6">
                                            <div className="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-3">
                                                <i className="fas fa-tint text-blue-600 text-2xl"></i>
                                            </div>
                                            <h3 className="text-lg font-bold text-gray-900 mb-2">Ouverture de la bouteille</h3>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                Date et heure d'ouverture *
                                            </label>
                                            <input
                                                type="datetime-local"
                                                className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none text-lg font-bold text-center"
                                                value={waterDateTimeInput}
                                                onChange={(e) => setWaterDateTimeInput(e.target.value)}
                                            />
                                        </div>


                                        <button
                                            onClick={saveWaterBottleDateTime}
                                            className="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 rounded-2xl font-bold active:scale-95 transition-transform"
                                        >
                                            Enregistrer la date
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {currentView === 'supplies' && (
                            <div className="space-y-4">
                                {isFeatureLocked('stocks') ? (
                                    <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-8 shadow-xl border border-white/50 text-center">
                                        <div className="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                            <i className="fas fa-lock text-blue-600 text-2xl"></i>
                                        </div>
                                        <h3 className="text-lg font-bold text-gray-900 mb-2">FonctionnalitÃ© VIP</h3>
                                        <p className="text-gray-600 mb-4">
                                            La gestion des stocks est disponible avec un plan payant.
                                        </p>
                                        <div className="space-y-3">
                                            <button
                                                onClick={() => {
                                                    setCurrentView('pricing');
                                                    window.scrollTo({ top: 0, behavior: 'smooth' });
                                                }}
                                                className="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-3 rounded-xl font-bold active:scale-95 transition-transform shadow-lg"
                                            >
                                                <i className="fas fa-crown mr-2"></i>
                                                DÃ©couvrir les offres VIP
                                            </button>
                                            <button
                                                onClick={() => showUpgradeMessage('Gestion des stocks')}
                                                className="w-full bg-gray-100 text-gray-700 px-6 py-2 rounded-xl font-medium active:scale-95 transition-transform"
                                            >
                                                En savoir plus
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {/* Lait en poudre */}
                                        <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-4 shadow-xl border border-white/30">
                                            <div className="flex items-center justify-between mb-3">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-12 h-12 bg-yellow-100 rounded-2xl flex items-center justify-center">
                                                        <i className="fas fa-baby text-yellow-600 text-xl"></i>
                                                    </div>
                                                    <div>
                                                        <h3 className="font-bold text-gray-900">Lait en poudre</h3>
                                                        <p className="text-sm text-gray-600">Suivi de la date d'ouverture</p>
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={() => {
                                                        setMilkDateInput(stocks['milk-powder']?.date || '');
                                                        setShowMilkStockModal(true);
                                                    }}
                                                    className="bg-blue-500 text-white px-4 py-2 rounded-xl text-sm font-medium shadow-lg active:scale-95 transition-transform"
                                                >
                                                    DÃ©finir date
                                                </button>
                                            </div>

                                            <div className="bg-gray-50 rounded-xl p-3">
                                                <div className="flex items-center gap-2 mb-2">
                                                    <i className="fas fa-calendar-alt text-gray-500"></i>
                                                    <span className="text-sm font-medium text-gray-700">Date d'ouverture</span>
                                                </div>
                                                <p className="text-lg font-bold text-gray-900 mb-2">
                                                    {formatStockDate(stocks['milk-powder']?.date)}
                                                </p>
                                            </div>
                                        </div>

                                        {/* Bouteille d'eau */}
                                        <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-4 shadow-xl border border-white/30">
                                            <div className="flex items-center justify-between mb-3">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-12 h-12 bg-blue-100 rounded-2xl flex items-center justify-center">
                                                        <i className="fas fa-tint text-blue-600 text-xl"></i>
                                                    </div>
                                                    <div>
                                                        <h3 className="font-bold text-gray-900">Bouteille d'eau</h3>
                                                        <p className="text-sm text-gray-600">Suivi de l'ouverture</p>
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={() => {
                                                        setWaterDateTimeInput(stocks['water-bottle']?.datetime || '');
                                                        setShowWaterStockModal(true);
                                                    }}
                                                    className="bg-blue-500 text-white px-4 py-2 rounded-xl text-sm font-medium shadow-lg active:scale-95 transition-transform"
                                                >
                                                    DÃ©finir date
                                                </button>
                                            </div>

                                            <div className="bg-gray-50 rounded-xl p-3">
                                                <div className="flex items-center gap-2 mb-2">
                                                    <i className="fas fa-clock text-gray-500"></i>
                                                    <span className="text-sm font-medium text-gray-700">Ouverture</span>
                                                </div>
                                                <p className="text-lg font-bold text-gray-900 mb-2">
                                                    {formatStockDateTime(stocks['water-bottle']?.datetime)}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        {currentView === 'food' && (
                            <div className="space-y-4">
                                {isFeatureLocked('diversification') ? (
                                    <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-8 shadow-xl border border-white/50 text-center">
                                        <div className="w-16 h-16 bg-orange-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                            <i className="fas fa-lock text-orange-600 text-2xl"></i>
                                        </div>
                                        <h3 className="text-lg font-bold text-gray-900 mb-2">FonctionnalitÃ© VIP</h3>
                                        <p className="text-gray-600 mb-4">
                                            La diversification alimentaire est disponible avec un plan payant.
                                        </p>
                                        <div className="space-y-3">
                                            <button
                                                onClick={() => {
                                                    setCurrentView('pricing');
                                                    window.scrollTo({ top: 0, behavior: 'smooth' });
                                                }}
                                                className="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-3 rounded-xl font-bold active:scale-95 transition-transform shadow-lg"
                                            >
                                                <i className="fas fa-crown mr-2"></i>
                                                DÃ©couvrir les offres VIP
                                            </button>
                                            <button
                                                onClick={() => showUpgradeMessage('Diversification alimentaire')}
                                                className="w-full bg-gray-100 text-gray-700 px-6 py-2 rounded-xl font-medium active:scale-95 transition-transform"
                                            >
                                                En savoir plus
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <>
                                        {/* Header */}
                                        <div className="flex justify-between items-center">
                                            <h2 className="text-xl font-bold text-gray-800">Diversification</h2>
                                            <button
                                                onClick={() => setShowFoodModal(true)}
                                                className="bg-orange-500 text-white px-4 py-2 rounded-xl text-sm font-medium shadow-lg"
                                            >
                                                + Aliment
                                            </button>
                                        </div>

                                        {/* Liste des aliments testÃ©s */}
                                        <div className="space-y-3">
                                            {diversificationEntries.length === 0 ? (
                                                <div className="bg-white/90 rounded-2xl p-6 shadow-xl border border-white/30 text-center">
                                                    <div className="w-16 h-16 bg-orange-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                                        <i className="fas fa-utensils text-orange-600 text-2xl"></i>
                                                    </div>
                                                    <p className="text-gray-500 font-medium">Aucun aliment testÃ©</p>
                                                    <p className="text-gray-400 text-sm">Commencez Ã  enregistrer les tests</p>
                                                </div>
                                            ) : (
                                                diversificationEntries.map(entry => (
                                                    <div key={entry.id} className="bg-white/90 rounded-2xl p-4 shadow-xl border border-white/30">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <div className="flex items-center gap-3">
                                                                <div className="w-12 h-12 bg-orange-100 rounded-2xl flex items-center justify-center">
                                                                    {entry.category === 'legumes' && <i className="fas fa-carrot text-orange-600"></i>}
                                                                    {entry.category === 'fruits' && <i className="fas fa-apple-alt text-orange-600"></i>}
                                                                    {entry.category === 'viande' && <i className="fas fa-drumstick-bite text-orange-600"></i>}
                                                                    {entry.category === 'cereales' && <i className="fas fa-bread-slice text-orange-600"></i>}
                                                                </div>
                                                                <div>
                                                                    <h5 className="font-semibold text-gray-800">{entry.food}</h5>
                                                                    <div className="flex items-center gap-2 text-sm">
                                                                        <span className="text-gray-600 capitalize">{entry.category}</span>
                                                                        <span className="w-1 h-1 bg-gray-400 rounded-full"></span>
                                                                        <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs">
                                                                            {entry.quantity}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <button
                                                                onClick={() => deleteDiversificationEntry(entry.id)}
                                                                className="text-red-500 hover:text-red-700 p-2"
                                                            >
                                                                <i className="fas fa-trash text-sm"></i>
                                                            </button>
                                                        </div>
                                                        {entry.notes && (
                                                            <div className="bg-gray-50 rounded-lg p-2 mt-2">
                                                                <p className="text-sm text-gray-600">{entry.notes}</p>
                                                            </div>
                                                        )}
                                                        <div className="text-xs text-gray-400 mt-2">
                                                            {formatDate(entry.timestamp)}
                                                        </div>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </>
                                )}
                            </div>
                        )}
                        {/* Vue Garde-robe */}
                        {currentView === 'wardrobe' && (
                            <div className="space-y-4">
                                {isFeatureLocked('wardrobe') ? (
                                    <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-8 shadow-xl border border-white/50 text-center">
                                        <div className="w-16 h-16 bg-pink-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                            <i className="fas fa-lock text-pink-600 text-2xl"></i>
                                        </div>
                                        <h3 className="text-lg font-bold text-gray-900 mb-2">FonctionnalitÃ© VIP</h3>
                                        <p className="text-gray-600 mb-4">
                                            La garde-robe est disponible avec un plan payant.
                                        </p>
                                        <div className="space-y-3">
                                            <button
                                                onClick={() => {
                                                    setCurrentView('pricing');
                                                    window.scrollTo({ top: 0, behavior: 'smooth' });
                                                }}
                                                className="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-3 rounded-xl font-bold active:scale-95 transition-transform shadow-lg"
                                            >
                                                <i className="fas fa-crown mr-2"></i>
                                                DÃ©couvrir les offres VIP
                                            </button>
                                            <button
                                                onClick={() => showUpgradeMessage('Garde-robe')}
                                                className="w-full bg-gray-100 text-gray-700 px-6 py-2 rounded-xl font-medium active:scale-95 transition-transform"
                                            >
                                                En savoir plus
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {/* Header avec style unifiÃ© */}
                                        <div className="flex justify-between items-center">
                                            <button
                                                onClick={() => exportWardrobeToPDF()}
                                                className="bg-blue-500 text-white px-4 py-2 rounded-xl text-sm font-medium shadow-lg active:scale-95 transition-transform"
                                            >
                                                <i className="fas fa-file-pdf mr-2"></i>PDF
                                            </button>
                                            <button
                                                onClick={() => setShowWardrobeModal(true)}
                                                className="bg-pink-500 text-white px-4 py-2 rounded-xl text-sm font-medium shadow-lg active:scale-95 transition-transform"
                                            >
                                                + Article
                                            </button>
                                        </div>

                                        {/* Tri par taille */}
                                        {(() => {
                                            const groupedBySize = {};
                                            wardrobe.forEach(item => {
                                                if (!groupedBySize[item.size]) {
                                                    groupedBySize[item.size] = [];
                                                }
                                                groupedBySize[item.size].push(item);
                                            });

                                            const sizes = Object.keys(groupedBySize).sort((a, b) => {
                                                const sizeOrder = ['Naissance', '1 mois', '3 mois', '6 mois', '9 mois', '12 mois', '18 mois', '2 ans', '3 ans'];
                                                return sizeOrder.indexOf(a) - sizeOrder.indexOf(b);
                                            });

                                            return sizes.length === 0 ? (
                                                <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl border border-white/30 text-center">
                                                    <div className="w-16 h-16 bg-pink-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                                        <i className="fas fa-tshirt text-pink-600 text-2xl"></i>
                                                    </div>
                                                    <p className="text-gray-500 font-medium">Aucun vÃªtement enregistrÃ©</p>
                                                    <p className="text-gray-400 text-sm">Commencez Ã  crÃ©er votre inventaire</p>
                                                </div>
                                            ) : (
                                                sizes.map(size => (
                                                    <div key={size} className="bg-white/90 backdrop-blur-sm rounded-2xl p-4 shadow-xl border border-white/30">
                                                        <h3 className="font-bold text-gray-900 mb-3 flex items-center gap-2">
                                                            <div className="w-8 h-8 bg-blue-100 rounded-xl flex items-center justify-center">
                                                                <i className="fas fa-ruler text-blue-600"></i>
                                                            </div>
                                                            Taille {size}
                                                            <span className="text-sm bg-gray-100 text-gray-600 px-2 py-1 rounded-full font-medium ml-auto">
                                                                {groupedBySize[size].length} article{groupedBySize[size].length > 1 ? 's' : ''}
                                                            </span>
                                                        </h3>
                                                        <div className="space-y-2">
                                                            {groupedBySize[size].map(item => (
                                                                <div key={item.id} className="bg-white/80 rounded-xl p-3 shadow-sm border border-white/50">
                                                                    <div className="flex items-center justify-between mb-2">
                                                                        <div className="flex items-center gap-3">
                                                                            <div className="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                                                                                <i className={`text-lg text-purple-600 ${item.type === 'Body manche courte' ? 'fas fa-tshirt' :
                                                                                    item.type === 'Body manche longue' ? 'fas fa-tshirt' :
                                                                                        item.type === 'T-shirt manche courte' ? 'fas fa-tshirt' :
                                                                                            item.type === 'T-shirt manche longue' ? 'fas fa-tshirt' :
                                                                                                item.type === 'Pull' ? 'fas fa-user-tie' :
                                                                                                    item.type === 'Pyjama' ? 'fas fa-bed' :
                                                                                                        item.type === 'Pantalon' ? 'fas fa-child' :
                                                                                                            item.type === 'Robe' ? 'fas fa-female' :
                                                                                                                item.type === 'Gigoteuse' ? 'fas fa-baby' :
                                                                                                                    item.type === 'Chaussettes' ? 'fas fa-socks' :
                                                                                                                        item.type === 'Bonnet' ? 'fas fa-hat-wizard' :
                                                                                                                            item.type === 'Gilet' ? 'fas fa-vest' :
                                                                                                                                'fas fa-question'
                                                                                    }`}></i>
                                                                            </div>
                                                                            <div>
                                                                                <span className="font-semibold text-gray-800">{item.type}</span>
                                                                                <div className="flex items-center gap-2 mt-1">
                                                                                    <span className="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full font-medium">
                                                                                        QuantitÃ©: {item.quantity}
                                                                                    </span>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div className="flex items-center gap-2">
                                                                            <button
                                                                                onClick={() => editWardrobeItem(item.id)}
                                                                                className="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center active:scale-95 transition-transform"
                                                                            >
                                                                                <i className="fas fa-edit text-blue-600 text-sm"></i>
                                                                            </button>
                                                                            <button
                                                                                onClick={() => deleteWardrobeItem(item.id)}
                                                                                className="w-8 h-8 rounded-lg bg-red-50 flex items-center justify-center active:scale-95 transition-transform"
                                                                            >
                                                                                <i className="fas fa-trash text-red-600 text-sm"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    {item.notes && (
                                                                        <div className="bg-gray-50 rounded-lg p-2 mt-2">
                                                                            <p className="text-sm text-gray-600 flex items-start gap-2">
                                                                                <i className="fas fa-sticky-note text-gray-400 mt-0.5"></i>
                                                                                {item.notes}
                                                                            </p>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))
                                            );
                                        })()}
                                    </div>
                                )}
                            </div>
                        )}
                        {/* Vue Liste de cadeaux */}
                        {currentView === 'gifts' && (
                            <div className="space-y-4">
                                {/* Header */}
                                <div className="flex justify-between items-center">
                                    <h2 className="text-xl font-bold text-gray-800">Liste de cadeaux</h2>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => exportGiftListToPDF()}
                                            className="bg-blue-500 text-white px-4 py-2 rounded-xl text-sm font-medium shadow-lg"
                                        >
                                            <i className="fas fa-file-pdf mr-2"></i>PDF
                                        </button>
                                        <button
                                            onClick={() => setShowGiftModal(true)}
                                            className="bg-red-500 text-white px-4 py-2 rounded-xl text-sm font-medium shadow-lg"
                                        >
                                            + Cadeau
                                        </button>
                                    </div>
                                </div>

                                {/* Liste des cadeaux */}
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    {giftList.length === 0 ? (
                                        <div className="col-span-full bg-white/90 rounded-2xl p-8 shadow-xl border border-white/30 text-center">
                                            <div className="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                                <i className="fas fa-gift text-red-600 text-2xl"></i>
                                            </div>
                                            <p className="text-gray-500 font-medium">Aucun cadeau dans la liste</p>
                                            <p className="text-gray-400 text-sm">Ajoutez des idÃ©es pour {user?.babyName}</p>
                                        </div>
                                    ) : (
                                        giftList.map(gift => (
                                            <div
                                                key={gift.id}
                                                className={`bg-white/90 rounded-2xl overflow-hidden shadow-xl border border-white/30 ${gift.reserved ? 'opacity-60' : ''}`}
                                            >
                                                {gift.image && (
                                                    <div className="h-48 bg-gray-100 relative">
                                                        <img
                                                            src={gift.image}
                                                            alt={gift.name}
                                                            className="w-full h-full object-cover"
                                                            onError={(e) => {
                                                                e.target.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23ddd" width="200" height="200"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" text-anchor="middle" dy=".3em"%3EImage%3C/text%3E%3C/svg%3E';
                                                            }}
                                                        />
                                                        {gift.reserved && (
                                                            <div className="absolute inset-0 bg-black/50 flex items-center justify-center">
                                                                <div className="bg-white px-4 py-2 rounded-xl font-bold text-gray-800">
                                                                    âœ“ RÃ©servÃ©
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                                <div className="p-4">
                                                    <h3 className="font-bold text-gray-900 mb-2 line-clamp-2">{gift.name}</h3>
                                                    <p className="text-2xl font-bold text-red-600 mb-3">{gift.price}</p>
                                                    {gift.notes && (
                                                        <p className="text-sm text-gray-600 mb-3 line-clamp-2">{gift.notes}</p>
                                                    )}
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => window.open(gift.url, '_blank')}
                                                            className="flex-1 bg-blue-50 text-blue-600 py-2 rounded-xl text-sm font-medium"
                                                        >
                                                            <i className="fas fa-external-link-alt mr-2"></i>Voir
                                                        </button>
                                                        <button
                                                            onClick={() => toggleGiftReserved(gift.id)}
                                                            className={`flex-1 py-2 rounded-xl text-sm font-medium ${gift.reserved
                                                                ? 'bg-gray-50 text-gray-600'
                                                                : 'bg-green-50 text-green-600'
                                                                }`}
                                                        >
                                                            {gift.reserved ? 'Annuler' : 'RÃ©server'}
                                                        </button>
                                                        <button
                                                            onClick={() => deleteGift(gift.id)}
                                                            className="px-3 py-2 bg-red-50 text-red-600 rounded-xl"
                                                        >
                                                            <i className="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Formulaire principal biberon/couche */}
                        {showForm && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4 z-50">
                                <div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl max-h-[90vh] overflow-y-auto relative">
                                    {/* Header du formulaire */}
                                    <div className={`sticky top-0 bg-gradient-to-r ${themeColors.primary} text-white p-6 rounded-t-3xl z-10`}>
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                                                    {formType === 'feeding' ? (
                                                        <i className="fas fa-bottle-water text-xl"></i>
                                                    ) : (
                                                        <i className="fas fa-baby text-xl"></i>
                                                    )}
                                                </div>
                                                <div>
                                                    <h3 className="text-xl font-bold">
                                                        {formType === 'feeding' ? 'Nouveau biberon' : 'Nouveau change'}
                                                    </h3>
                                                    <p className="text-sm opacity-80">
                                                        {editingId ? 'Modifier l\'entrÃ©e' : 'Ajouter une nouvelle entrÃ©e'}
                                                    </p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={closeForm}
                                                className="w-10 h-10 rounded-2xl bg-white/20 flex items-center justify-center active:scale-95 transition-transform"
                                            >
                                                <i className="fas fa-times text-lg"></i>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Contenu du formulaire */}
                                    <div className="p-6 space-y-6">
                                        {/* Date et heure */}
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                    Date *
                                                </label>
                                                <div className="relative">
                                                    <input
                                                        type="date"
                                                        className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none transition-colors"
                                                        value={formData.date}
                                                        onChange={(e) => setFormData(prev => ({ ...prev, date: e.target.value }))}
                                                    />
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                    Heure *
                                                </label>
                                                <div className="relative">
                                                    <input
                                                        type="time"
                                                        className="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none transition-colors"
                                                        value={formData.time}
                                                        onChange={(e) => setFormData(prev => ({ ...prev, time: e.target.value }))}
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        {/* Formulaire biberon */}
                                        {formType === 'feeding' && (
                                            <div className="space-y-4">
                                                <div>
                                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                        QuantitÃ© (ml) *
                                                    </label>
                                                    <div className="relative">
                                                        <input
                                                            type="number"
                                                            placeholder="120"
                                                            className="w-full px-4 py-3 pr-12 rounded-2xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none text-lg font-bold text-center transition-colors"
                                                            value={formData.amount}
                                                            onChange={(e) => setFormData(prev => ({ ...prev, amount: e.target.value }))}
                                                        />
                                                        <span className="absolute right-4 top-4 text-gray-500 font-medium">ml</span>
                                                    </div>
                                                </div>

                                            </div>
                                        )}

                                        {/* Formulaire couche */}
                                        {formType === 'diaper' && (
                                            <div className="space-y-6">
                                                {/* Type de change */}
                                                <div>
                                                    <label className="block text-sm font-semibold text-gray-700 mb-3">
                                                        Type de change *
                                                    </label>
                                                    <div className="grid grid-cols-2 gap-3">
                                                        <button
                                                            type="button"
                                                            onClick={() => setFormData(prev => ({ ...prev, hasPee: !prev.hasPee }))}
                                                            className={`p-4 rounded-2xl border-2 transition-all ${formData.hasPee
                                                                ? 'bg-blue-100 border-blue-300 text-blue-800'
                                                                : 'bg-gray-50 border-gray-200 text-gray-600'
                                                                }`}
                                                        >
                                                            <div className="text-2xl mb-2">ðŸ’§</div>
                                                            <div className="font-semibold">Pipi</div>
                                                        </button>
                                                        <button
                                                            type="button"
                                                            onClick={() => setFormData(prev => ({ ...prev, hasPoop: !prev.hasPoop }))}
                                                            className={`p-4 rounded-2xl border-2 transition-all ${formData.hasPoop
                                                                ? 'bg-orange-100 border-orange-300 text-orange-800'
                                                                : 'bg-gray-50 border-gray-200 text-gray-600'
                                                                }`}
                                                        >
                                                            <div className="text-2xl mb-2">ðŸ’©</div>
                                                            <div className="font-semibold">Caca</div>
                                                        </button>
                                                    </div>
                                                </div>

                                                {/* DÃ©tails caca si sÃ©lectionnÃ© */}
                                                {formData.hasPoop && (
                                                    <div className="space-y-4 bg-orange-50 rounded-2xl p-4 border border-orange-200">
                                                        <h4 className="font-semibold text-orange-800 mb-3">DÃ©tails du caca</h4>

                                                        {/* QuantitÃ© */}
                                                        <div>
                                                            <label className="block text-sm font-medium text-orange-700 mb-2">QuantitÃ©</label>
                                                            <div className="grid grid-cols-3 gap-2">
                                                                {['peu', 'moyen', 'beaucoup'].map(qty => (
                                                                    <button
                                                                        key={qty}
                                                                        type="button"
                                                                        onClick={() => setFormData(prev => ({ ...prev, poopQuantity: qty }))}
                                                                        className={`p-2 rounded-xl text-sm font-medium border-2 transition-all ${formData.poopQuantity === qty
                                                                            ? 'bg-orange-200 border-orange-400 text-orange-800'
                                                                            : 'bg-white border-orange-200 text-orange-600'
                                                                            }`}
                                                                    >
                                                                        {qty === 'peu' && 'ðŸ¤'} {qty === 'moyen' && 'ðŸ‘Œ'} {qty === 'beaucoup' && 'ðŸ™Œ'}
                                                                        <div className="capitalize">{qty}</div>
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        </div>

                                                        {/* Consistance */}
                                                        <div>
                                                            <label className="block text-sm font-medium text-orange-700 mb-2">Consistance</label>
                                                            <div className="grid grid-cols-2 gap-2">
                                                                {[
                                                                    { value: 'liquide', emoji: 'ðŸ’§', label: 'Liquide' },
                                                                    { value: 'molle', emoji: 'ðŸŸ¡', label: 'Molle' },
                                                                    { value: 'normale', emoji: 'ðŸŸ¤', label: 'Normale' },
                                                                    { value: 'dure', emoji: 'ðŸ”´', label: 'Dure' }
                                                                ].map(consistency => (
                                                                    <button
                                                                        key={consistency.value}
                                                                        type="button"
                                                                        onClick={() => setFormData(prev => ({ ...prev, poopConsistency: consistency.value }))}
                                                                        className={`p-2 rounded-xl text-sm font-medium border-2 transition-all ${formData.poopConsistency === consistency.value
                                                                            ? 'bg-orange-200 border-orange-400 text-orange-800'
                                                                            : 'bg-white border-orange-200 text-orange-600'
                                                                            }`}
                                                                    >
                                                                        <div className="text-lg mb-1">{consistency.emoji}</div>
                                                                        <div>{consistency.label}</div>
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        </div>

                                                        {/* Couleur */}
                                                        <div>
                                                            <label className="block text-sm font-medium text-orange-700 mb-2">Couleur</label>
                                                            <div className="grid grid-cols-2 gap-2">
                                                                {[
                                                                    { value: 'jaune', emoji: 'ðŸŸ¡', label: 'Jaune' },
                                                                    { value: 'marron', emoji: 'ðŸŸ¤', label: 'Marron' },
                                                                    { value: 'vert', emoji: 'ðŸŸ¢', label: 'Vert' },
                                                                    { value: 'noir', emoji: 'âš«', label: 'Noir' }
                                                                ].map(color => (
                                                                    <button
                                                                        key={color.value}
                                                                        type="button"
                                                                        onClick={() => setFormData(prev => ({ ...prev, poopColor: color.value }))}
                                                                        className={`p-2 rounded-xl text-sm font-medium border-2 transition-all ${formData.poopColor === color.value
                                                                            ? 'bg-orange-200 border-orange-400 text-orange-800'
                                                                            : 'bg-white border-orange-200 text-orange-600'
                                                                            }`}
                                                                    >
                                                                        <div className="text-lg mb-1">{color.emoji}</div>
                                                                        <div>{color.label}</div>
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>

                                    {/* Footer avec boutons */}
                                    <div className="sticky bottom-0 bg-white border-t border-gray-100 p-6 space-y-3">
                                        <button
                                            onClick={saveEntry}
                                            className={`w-full bg-gradient-to-r ${themeColors.primary} text-white py-4 rounded-2xl font-bold text-lg active:scale-95 transition-transform shadow-lg`}
                                        >
                                            {editingId ? 'Mettre Ã  jour' : 'Enregistrer'}
                                        </button>
                                        <button
                                            onClick={closeForm}
                                            className="w-full bg-gray-100 text-gray-700 py-3 rounded-2xl font-medium active:scale-95 transition-transform"
                                        >
                                            Annuler
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* Vue Accomplissements */}
                        {currentView === 'accomplishments' && (
                            <div className="space-y-4">
                                {isFeatureLocked('accomplishments') ? (
                                    <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-8 shadow-xl border border-white/50 text-center">
                                        <div className="w-16 h-16 bg-yellow-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                            <i className="fas fa-lock text-yellow-600 text-2xl"></i>
                                        </div>
                                        <h3 className="text-lg font-bold text-gray-900 mb-2">FonctionnalitÃ© VIP</h3>
                                        <p className="text-gray-600 mb-4">
                                            Les accomplissements sont disponibles avec un plan payant.
                                        </p>
                                        <div className="space-y-3">
                                            <button
                                                onClick={() => {
                                                    setCurrentView('pricing');
                                                    window.scrollTo({ top: 0, behavior: 'smooth' });
                                                }}
                                                className="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-3 rounded-xl font-bold active:scale-95 transition-transform shadow-lg"
                                            >
                                                <i className="fas fa-crown mr-2"></i>
                                                DÃ©couvrir les offres VIP
                                            </button>
                                            <button
                                                onClick={() => showUpgradeMessage('Accomplissements')}
                                                className="w-full bg-gray-100 text-gray-700 px-6 py-2 rounded-xl font-medium active:scale-95 transition-transform"
                                            >
                                                En savoir plus
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <>
                                        {/* Header avec trophÃ©e */}
                                        <div className="text-center mb-6">
                                            <div className="w-20 h-20 mx-auto bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center mb-3 shadow-xl">
                                                <i className="fas fa-trophy text-white text-2xl"></i>
                                            </div>
                                            <h2 className="text-xl font-bold text-gray-800">Accomplissements de {user?.babyName}</h2>
                                            <p className="text-sm text-gray-600">Suivez les Ã©tapes de dÃ©veloppement</p>
                                        </div>

                                        {/* Cartes par Ã¢ge avec barre de progression */}
                                        <div className="space-y-4">
                                            {Object.entries(accomplishmentData).map(([ageKey, categories]) => {
                                                const ageLabels = {
                                                    '2months': '2 mois',
                                                    '4months': '4 mois',
                                                    '6months': '6 mois',
                                                    '9months': '9 mois'
                                                };

                                                // Calculer le pourcentage de completion
                                                const totalAccomplishments = Object.values(categories).flat().length;
                                                const completedCount = Object.values(categories).flat().filter(item =>
                                                    accomplishments[ageKey]?.[item] === 'complete'
                                                ).length;
                                                const progressPercent = totalAccomplishments > 0 ? Math.round((completedCount / totalAccomplishments) * 100) : 0;

                                                const isUnlocked = calculateAge() >= parseInt(ageKey.replace('months', '')) * 30;

                                                return (
                                                    <div
                                                        key={ageKey}
                                                        className={`bg-white/90 rounded-2xl p-4 shadow-xl border border-white/50 ${!isUnlocked ? 'opacity-50' : 'cursor-pointer hover:scale-105'
                                                            } transition-all duration-200`}
                                                        onClick={() => {
                                                            if (isUnlocked) {
                                                                setCurrentMilestoneAge(ageKey);
                                                                setShowAccomplishments(true);
                                                            }
                                                        }}
                                                    >
                                                        <div className="flex items-center justify-between mb-3">
                                                            <div className="flex items-center gap-3">
                                                                <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${progressPercent === 100 ? 'bg-gradient-to-br from-yellow-400 to-yellow-600' :
                                                                    progressPercent > 0 ? 'bg-gradient-to-br from-blue-400 to-blue-600' :
                                                                        'bg-gray-200'
                                                                    }`}>
                                                                    {!isUnlocked ? (
                                                                        <i className="fas fa-lock text-gray-500"></i>
                                                                    ) : progressPercent === 100 ? (
                                                                        <i className="fas fa-trophy text-white"></i>
                                                                    ) : (
                                                                        <i className="fas fa-medal text-white"></i>
                                                                    )}
                                                                </div>
                                                                <div>
                                                                    <h3 className="font-bold text-gray-900">{ageLabels[ageKey]}</h3>
                                                                    <p className="text-sm text-gray-600">
                                                                        {isUnlocked ? `${completedCount}/${totalAccomplishments} accomplis` : 'BientÃ´t dÃ©bloquÃ©'}
                                                                    </p>
                                                                </div>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className="text-2xl font-bold text-gray-800">{progressPercent}%</div>
                                                                {progressPercent === 100 && (
                                                                    <div className="text-xs text-yellow-600 font-medium">TERMINÃ‰!</div>
                                                                )}
                                                            </div>
                                                        </div>

                                                        {/* Barre de progression */}
                                                        <div className="w-full bg-gray-200 rounded-full h-3 mb-2">
                                                            <div
                                                                className={`h-3 rounded-full transition-all duration-500 ${progressPercent === 100 ? 'bg-gradient-to-r from-yellow-400 to-yellow-600' :
                                                                    'bg-gradient-to-r from-blue-400 to-blue-600'
                                                                    }`}
                                                                style={{ width: `${progressPercent}%` }}
                                                            ></div>
                                                        </div>

                                                        {!isUnlocked && (
                                                            <div className="text-xs text-gray-500 mt-2">
                                                                DÃ©bloquÃ© Ã  {parseInt(ageKey.replace('months', ''))} mois ({parseInt(ageKey.replace('months', '')) * 30} jours)
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </>
                                )}
                            </div>
                        )}
                        {/* Modal dÃ©tail des accomplissements */}
                        {showAccomplishments && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-4 z-50">
                                <div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl max-h-[90vh] overflow-y-auto relative">
                                    {/* Header */}
                                    <div className="sticky top-0 bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-t-3xl z-10">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                                                    <i className="fas fa-trophy text-xl"></i>
                                                </div>
                                                <div>
                                                    <h3 className="text-xl font-bold">Accomplissements</h3>
                                                    <p className="text-sm opacity-80">
                                                        {currentMilestoneAge === '2months' ? '2 mois' :
                                                            currentMilestoneAge === '4months' ? '4 mois' :
                                                                currentMilestoneAge === '6months' ? '6 mois' : '9 mois'}
                                                    </p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => setShowAccomplishments(false)}
                                                className="w-10 h-10 rounded-2xl bg-white/20 flex items-center justify-center"
                                            >
                                                <i className="fas fa-times text-lg"></i>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Onglets catÃ©gories */}
                                    <div className="p-4">
                                        <div className="grid grid-cols-2 gap-2 mb-4">
                                            {[
                                                { id: 'movement', label: 'Mouvement', icon: 'fa-running' },
                                                { id: 'cognitive', label: 'Cognitif', icon: 'fa-brain' },
                                                { id: 'language', label: 'Langage', icon: 'fa-comments' },
                                                { id: 'social', label: 'Social', icon: 'fa-users' }
                                            ].map(cat => {
                                                // Calculer si la catÃ©gorie est complÃ¨tement validÃ©e
                                                const categoryAccomplishments = accomplishmentData[currentMilestoneAge]?.[cat.id] || [];
                                                const completedInCategory = categoryAccomplishments.filter(item =>
                                                    accomplishments[currentMilestoneAge]?.[item] === 'complete'
                                                ).length;
                                                const isFullyCompleted = completedInCategory === categoryAccomplishments.length && categoryAccomplishments.length > 0;
                                                const hasProgress = completedInCategory > 0;



                                                // Composant de notification personnalisÃ©e
                                                const CustomAlert = ({ message, type = 'info', onClose }) => {
                                                    const icons = {
                                                        success: 'fa-check-circle text-green-600',
                                                        error: 'fa-exclamation-circle text-red-600',
                                                        warning: 'fa-exclamation-triangle text-yellow-600',
                                                        info: 'fa-info-circle text-blue-600'
                                                    };

                                                    const backgrounds = {
                                                        success: 'from-green-500 to-green-600',
                                                        error: 'from-red-500 to-red-600',
                                                        warning: 'from-yellow-500 to-yellow-600',
                                                        info: 'from-blue-500 to-blue-600'
                                                    };

                                                    return (
                                                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[100]">
                                                            <div className="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl animate-in">
                                                                <div className="text-center">
                                                                    <div className={`w-16 h-16 mx-auto rounded-full bg-gradient-to-r ${backgrounds[type]} flex items-center justify-center mb-4`}>
                                                                        <i className={`fas ${icons[type]} text-white text-2xl`}></i>
                                                                    </div>
                                                                    <p className="text-gray-800 mb-6 leading-relaxed">{message}</p>
                                                                    <button
                                                                        onClick={onClose}
                                                                        className={`w-full bg-gradient-to-r ${backgrounds[type]} text-white py-3 rounded-xl font-bold active:scale-95 transition-transform`}
                                                                    >
                                                                        OK
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    );
                                                };


                                                return (
                                                    <button
                                                        key={cat.id}
                                                        onClick={() => setSelectedCategory(cat.id)}
                                                        className={`relative flex flex-col items-center gap-1 px-3 py-2 rounded-xl text-xs font-medium transition-all ${selectedCategory === cat.id
                                                            ? 'bg-purple-100 text-purple-700 border-2 border-purple-300'
                                                            : 'bg-gray-100 text-gray-600 border-2 border-gray-200'
                                                            }`}
                                                    >
                                                        <div className="relative">
                                                            <i className={`fas ${cat.icon} text-sm`}></i>
                                                            {/* Badge de validation */}
                                                            {isFullyCompleted && (
                                                                <div className="absolute -top-1 -right-2 w-4 h-4 bg-green-500 rounded-full flex items-center justify-center">
                                                                    <i className="fas fa-check text-white text-xs"></i>
                                                                </div>
                                                            )}
                                                            {/* Badge de progression partielle */}
                                                            {hasProgress && !isFullyCompleted && (
                                                                <div className="absolute -top-1 -right-2 w-4 h-4 bg-orange-500 rounded-full flex items-center justify-center">
                                                                    <span className="text-white text-xs font-bold">{completedInCategory}</span>
                                                                </div>
                                                            )}
                                                        </div>
                                                        <span>{cat.label}</span>
                                                        {/* Barre de progression sous le texte */}
                                                        {categoryAccomplishments.length > 0 && (
                                                            <div className="w-full h-1 bg-gray-200 rounded-full mt-1">
                                                                <div
                                                                    className={`h-1 rounded-full transition-all duration-300 ${isFullyCompleted ? 'bg-green-500' : 'bg-orange-500'
                                                                        }`}
                                                                    style={{
                                                                        width: `${Math.round((completedInCategory / categoryAccomplishments.length) * 100)}%`
                                                                    }}
                                                                ></div>
                                                            </div>
                                                        )}
                                                    </button>
                                                );
                                            })}
                                        </div>

                                        {/* Liste des accomplissements */}
                                        <div className="space-y-3">
                                            {accomplishmentData[currentMilestoneAge]?.[selectedCategory]?.map((item, index) => {
                                                const accomplishmentText = item.replace('{babyName}', user?.babyName || 'bÃ©bÃ©');
                                                const status = accomplishments[currentMilestoneAge]?.[item] || 'none';

                                                return (
                                                    <div key={index} className="bg-gray-50 rounded-2xl p-4 border border-gray-200">
                                                        <p className="text-sm text-gray-800 mb-3 font-medium leading-relaxed">
                                                            {accomplishmentText}
                                                        </p>

                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => {
                                                                    setSelectedMilestone({ age: currentMilestoneAge, item, status: 'partial' });
                                                                    setShowAccomplishments(false); // Fermer le menu
                                                                }}
                                                                className={`flex-1 py-2 px-3 rounded-xl text-sm font-medium border-2 transition-all ${status === 'partial'
                                                                    ? 'bg-orange-100 text-orange-700 border-orange-300'
                                                                    : 'bg-white text-gray-600 border-gray-200 hover:border-orange-300'
                                                                    }`}
                                                            >
                                                                Partielle
                                                            </button>
                                                            <button
                                                                onClick={() => {
                                                                    setSelectedMilestone({ age: currentMilestoneAge, item, status: 'complete' });
                                                                    setShowAccomplishments(false); // Fermer le menu
                                                                }}
                                                                className={`flex-1 py-2 px-3 rounded-xl text-sm font-medium border-2 transition-all ${status === 'complete'
                                                                    ? 'bg-green-100 text-green-700 border-green-300'
                                                                    : 'bg-white text-gray-600 border-gray-200 hover:border-green-300'
                                                                    }`}
                                                            >
                                                                ComplÃ¨te
                                                            </button> </div>

                                                        {status !== 'none' && (
                                                            <div className="mt-2 text-xs text-gray-500">
                                                                {status === 'partial' ? 'En cours d\'acquisition' : 'MaÃ®trisÃ©'}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* Modal confirmation statut */}
                        {selectedMilestone && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-60">
                                <div className="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl">
                                    <div className="text-center mb-4">
                                        <div className={`w-16 h-16 mx-auto rounded-full flex items-center justify-center mb-3 ${selectedMilestone.status === 'complete'
                                            ? 'bg-green-100'
                                            : 'bg-orange-100'
                                            }`}>
                                            <i className={`fas ${selectedMilestone.status === 'complete'
                                                ? 'fa-trophy text-green-600'
                                                : 'fa-clock text-orange-600'
                                                } text-xl`}></i>
                                        </div>
                                        <h3 className="text-lg font-bold text-gray-900 mb-2">
                                            {selectedMilestone.status === 'complete' ? 'ComplÃ¨te' : 'Partielle'}
                                        </h3>
                                        <p className="text-sm text-gray-600 mb-4">
                                            {selectedMilestone.status === 'complete'
                                                ? `${user?.babyName} peut rÃ©pÃ©ter cette action sans votre aide`
                                                : `${user?.babyName} peut effectuer cette action temporairement ou avec votre aide`
                                            }
                                        </p>
                                        <div className="text-xs text-gray-500 mb-4">
                                            L'Ã¢ge de {user?.babyName} lorsque cette compÃ©tence a Ã©tÃ© dÃ©montrÃ©e
                                        </div>
                                        <div className="bg-gray-100 rounded-xl p-3 mb-4">
                                            <div className="text-2xl font-bold text-gray-800">
                                                {formatAgeDisplay(calculateAge())}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex gap-3">
                                        <button
                                            onClick={() => setSelectedMilestone(null)}
                                            className="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-medium active:scale-95 transition-transform"
                                        >
                                            <i className="fas fa-times mr-2"></i>
                                            Annuler
                                        </button>
                                        <button
                                            onClick={async () => {
                                                const { age, item, status } = selectedMilestone;
                                                const newAccomplishments = { ...accomplishments };
                                                if (!newAccomplishments[age]) newAccomplishments[age] = {};

                                                // VÃ©rifier si c'est la premiÃ¨re fois qu'on atteint 100%
                                                const currentCompletedCount = accomplishments[age]
                                                    ? Object.values(accomplishments[age]).filter(s => s === 'complete').length
                                                    : 0;
                                                const totalItems = Object.values(accomplishmentData[age]).flat().length;
                                                const wasAlready100 = currentCompletedCount === totalItems;

                                                newAccomplishments[age][item] = status;

                                                // Calculer le nouveau pourcentage
                                                const newCompletedCount = Object.values(newAccomplishments[age]).filter(s => s === 'complete').length;
                                                const newProgress = Math.round((newCompletedCount / totalItems) * 100);

                                                setAccomplishments(newAccomplishments);

                                                // Sauvegarder dans Firebase
                                                // Sauvegarder dans Firebase
                                                try {
                                                    await db.collection('families').doc(user.code).update({
                                                        accomplishments: newAccomplishments,
                                                        lastAccomplishmentUpdate: new Date().toISOString()
                                                    });
                                                    console.log('Accomplissements sauvegardÃ©s avec succÃ¨s');
                                                } catch (error) {
                                                    console.error('Erreur sauvegarde accomplissements:', error);
                                                    // Afficher un message d'erreur Ã  l'utilisateur
                                                    showCustomAlert('Erreur lors de la sauvegarde. Veuillez rÃ©essayer.');
                                                    return; // EmpÃªcher la fermeture du modal en cas d'erreur
                                                }

                                                setSelectedMilestone(null);

                                                // Animation de fÃ©licitations si on atteint 100% pour la premiÃ¨re fois
                                                if (newProgress === 100 && !wasAlready100) {
                                                    setTimeout(() => {
                                                        const congratsDiv = document.createElement('div');
                                                        congratsDiv.innerHTML = `
                                    <div style="
                                        position: fixed; 
                                        top: 50%; 
                                        left: 50%; 
                                        transform: translate(-50%, -50%); 
                                        background: linear-gradient(135deg, #fbbf24, #f59e0b); 
                                        color: white; 
                                        padding: 2rem 1.5rem; 
                                        border-radius: 2rem; 
                                        box-shadow: 0 25px 60px rgba(251, 191, 36, 0.4);
                                        z-index: 9999;
                                        text-align: center;
                                        animation: bounceIn 0.8s ease-out;
                                        max-width: 280px;
                                        width: 90%;
                                        border: 3px solid rgba(255,255,255,0.2);
                                    ">
                                        <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸŽ‰</div>
                                        <h3 style="font-size: 1.8rem; font-weight: bold; margin-bottom: 0.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">FÃ©licitations !</h3>
                                        <p style="margin: 0; opacity: 0.95; font-size: 1rem; line-height: 1.4;">${user?.babyName} a terminÃ© tous les accomplissements de ${age === '2months' ? '2 mois' : age === '4months' ? '4 mois' : age === '6months' ? '6 mois' : '9 mois'} !</p>
                                    </div>
                                    <style>
                                        @keyframes bounceIn {
                                            0% { 
                                                transform: translate(-50%, -50%) scale(0.5) rotate(-5deg); 
                                                opacity: 0; 
                                            }
                                            60% { 
                                                transform: translate(-50%, -50%) scale(1.1) rotate(2deg); 
                                                opacity: 1;
                                            }
                                            80% { 
                                                transform: translate(-50%, -50%) scale(0.95) rotate(-1deg); 
                                            }
                                            100% { 
                                                transform: translate(-50%, -50%) scale(1) rotate(0deg); 
                                                opacity: 1; 
                                            }
                                        }
                                    </style>
                                `;
                                                        document.body.appendChild(congratsDiv);

                                                        // Supprimer aprÃ¨s 4 secondes
                                                        setTimeout(() => {
                                                            if (document.body.contains(congratsDiv)) {
                                                                document.body.removeChild(congratsDiv);
                                                            }
                                                        }, 4000);
                                                    }, 500);
                                                }
                                            }}
                                            className={`flex-1 text-white py-3 rounded-xl font-bold active:scale-95 transition-transform shadow-lg ${selectedMilestone.status === 'complete'
                                                ? 'bg-gradient-to-r from-green-500 to-green-600'
                                                : 'bg-gradient-to-r from-orange-500 to-orange-600'
                                                }`}
                                        >
                                            Enregistrer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Vue Pricing/Tarification */}
                        {currentView === 'pricing' && (
                            <div className="space-y-6 pb-8">
                                {/* Header avec animation */}
                                <div className="text-center">
                                    <div className="w-24 h-24 mx-auto bg-gradient-to-br from-yellow-400 via-orange-500 to-pink-500 rounded-full flex items-center justify-center mb-4 shadow-2xl animate-pulse">
                                        <i className="fas fa-crown text-white text-4xl"></i>
                                    </div>
                                    <h2 className="text-3xl font-bold text-gray-900 mb-2">Plans VIP</h2>
                                    <p className="text-gray-600 mb-4">Choisissez l'offre qui vous convient</p>

                                    {/* Badge promo si applicable */}
                                    {(() => {
                                        const accountCreationDate = new Date(user?.createdAt);
                                        const now = new Date();
                                        const daysSinceCreation = Math.floor((now - accountCreationDate) / (1000 * 60 * 60 * 24));
                                        const isPromoActive = daysSinceCreation <= 7;

                                        if (isPromoActive) {
                                            return (
                                                <div className="inline-block bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-3 rounded-2xl shadow-lg animate-bounce">
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-xl">ðŸŽ‰</span>
                                                        <span className="font-bold">-50% sur votre 1er mois !</span>
                                                    </div>
                                                </div>
                                            );
                                        }
                                    })()}
                                </div>

                                {/* Plan actuel si Freemium */}
                                {currentPlan === 'Freemium' && (
                                    <div className="bg-gray-100 rounded-2xl p-5 border-2 border-gray-300">
                                        <div className="flex items-center justify-between mb-3">
                                            <div>
                                                <div className="flex items-center gap-2 mb-1">
                                                    <h3 className="text-lg font-bold text-gray-800">Plan DÃ©couverte</h3>
                                                    <span className="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full font-medium">Actuel</span>
                                                </div>
                                                <p className="text-sm text-gray-600">Votre plan actuel</p>
                                            </div>
                                            <div className="text-2xl font-bold text-gray-800">Gratuit</div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2 text-xs">
                                            <div className="flex items-center gap-2 text-green-700">
                                                <i className="fas fa-check"></i>
                                                <span>Suivi de base</span>
                                            </div>
                                            <div className="flex items-center gap-2 text-red-600">
                                                <i className="fas fa-times"></i>
                                                <span>Historique 48h</span>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Plans VIP */}
                                <div className="space-y-4">
                                    {/* Plan Solo - RecommandÃ© */}
                                    <div className="relative bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl p-6 border-3 border-blue-400 shadow-xl">
                                        <div className="absolute -top-3 left-1/2 transform -translate-x-1/2">
                                            <div className="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-1 rounded-full text-xs font-bold shadow-lg">
                                                â­ RECOMMANDÃ‰
                                            </div>
                                        </div>

                                        <div className="flex items-start justify-between mb-4 mt-2">
                                            <div className="flex-1">
                                                <h3 className="text-2xl font-bold text-blue-900 mb-1">Plan VIP Solo</h3>
                                                <p className="text-sm text-blue-700 flex items-center gap-1">
                                                    <i className="fas fa-user text-xs"></i>
                                                    1 compte utilisateur
                                                </p>
                                            </div>
                                            <div className="text-right">
                                                {(() => {
                                                    const accountCreationDate = new Date(user?.createdAt);
                                                    const now = new Date();
                                                    const daysSinceCreation = Math.floor((now - accountCreationDate) / (1000 * 60 * 60 * 24));
                                                    const isPromoActive = daysSinceCreation <= 7;

                                                    if (isPromoActive) {
                                                        return (
                                                            <div>
                                                                <div className="text-sm line-through text-blue-600 opacity-70">3,99â‚¬</div>
                                                                <div className="text-4xl font-black text-blue-900">1,99â‚¬</div>
                                                                <div className="text-xs text-blue-700 font-medium">1er mois puis 3,99â‚¬/mois</div>
                                                            </div>
                                                        );
                                                    } else {
                                                        return (
                                                            <div>
                                                                <div className="text-4xl font-black text-blue-900">3,99â‚¬</div>
                                                                <div className="text-xs text-blue-700">par mois</div>
                                                            </div>
                                                        );
                                                    }
                                                })()}
                                            </div>
                                        </div>

                                        <div className="space-y-2 mb-5">
                                            {[
                                                'Historique illimitÃ©',
                                                'Analytics avancÃ©es',
                                                'Export PDF pour pÃ©diatre',
                                                'Suivi sommeil & croissance',
                                                'Diversification alimentaire',
                                                'Garde-robe & stocks',
                                                'Accomplissements'
                                            ].map((feature, i) => (
                                                <div key={i} className="flex items-center gap-3 text-sm text-blue-900">
                                                    <div className="w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                                                        <i className="fas fa-check text-white text-xs"></i>
                                                    </div>
                                                    <span className="font-medium">{feature}</span>
                                                </div>
                                            ))}
                                        </div>

                                        <button
                                            onClick={() => startFreeTrial('Solo')}
                                            className="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 rounded-xl font-bold text-lg active:scale-95 transition-transform shadow-lg"
                                        >
                                            ðŸŽ Essayer 7 jours gratuits
                                        </button>
                                        <p className="text-center text-xs text-blue-700 mt-2">
                                            Sans engagement â€¢ Annulable Ã  tout moment
                                        </p>
                                    </div>

                                    {/* Plan Parentale */}
                                    <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl p-6 border-2 border-purple-300 shadow-lg">
                                        <div className="flex items-start justify-between mb-4">
                                            <div className="flex-1">
                                                <h3 className="text-xl font-bold text-purple-900 mb-1">Plan VIP Parentale</h3>
                                                <p className="text-sm text-purple-700 flex items-center gap-1">
                                                    <i className="fas fa-users text-xs"></i>
                                                    2 comptes utilisateurs
                                                </p>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-3xl font-bold text-purple-900">4,99â‚¬</div>
                                                <div className="text-xs text-purple-700">par mois</div>
                                            </div>
                                        </div>

                                        <div className="space-y-2 mb-4">
                                            {[
                                                'Tout du plan Solo',
                                                '2 utilisateurs connectÃ©s',
                                                'Synchronisation temps rÃ©el',
                                                'Partage des donnÃ©es'
                                            ].map((feature, i) => (
                                                <div key={i} className="flex items-center gap-3 text-sm text-purple-900">
                                                    <div className="w-5 h-5 bg-purple-500 rounded-full flex items-center justify-center flex-shrink-0">
                                                        <i className="fas fa-check text-white text-xs"></i>
                                                    </div>
                                                    <span>{feature}</span>
                                                </div>
                                            ))}
                                        </div>

                                        <button
                                            onClick={() => startFreeTrial('Parentale')}
                                            className="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white py-4 rounded-xl font-bold active:scale-95 transition-transform shadow-lg"
                                        >
                                            Essayer 7 jours gratuits
                                        </button>
                                    </div>

                                    {/* Plan Familial */}
                                    <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl p-6 border-2 border-green-300 shadow-lg">
                                        <div className="flex items-start justify-between mb-4">
                                            <div className="flex-1">
                                                <h3 className="text-xl font-bold text-green-900 mb-1">Plan VIP Familial</h3>
                                                <p className="text-sm text-green-700 flex items-center gap-1">
                                                    <i className="fas fa-users text-xs"></i>
                                                    4 comptes utilisateurs
                                                </p>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-3xl font-bold text-green-900">5,99â‚¬</div>
                                                <div className="text-xs text-green-700">par mois</div>
                                            </div>
                                        </div>

                                        <div className="space-y-2 mb-4">
                                            {[
                                                'Tout du plan Parentale',
                                                '4 utilisateurs connectÃ©s',
                                                'IdÃ©al grands-parents',
                                                'Support prioritaire'
                                            ].map((feature, i) => (
                                                <div key={i} className="flex items-center gap-3 text-sm text-green-900">
                                                    <div className="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                                                        <i className="fas fa-check text-white text-xs"></i>
                                                    </div>
                                                    <span>{feature}</span>
                                                </div>
                                            ))}
                                        </div>

                                        <button
                                            onClick={() => startFreeTrial('Familial')}
                                            className="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-xl font-bold active:scale-95 transition-transform shadow-lg"
                                        >
                                            Essayer 7 jours gratuits
                                        </button>
                                    </div>
                                </div>

                                {/* FAQ */}
                                <div className="bg-white/90 rounded-2xl p-6 shadow-xl border border-white/50">
                                    <h3 className="font-bold text-gray-900 mb-4 text-lg flex items-center gap-2">
                                        <i className="fas fa-question-circle text-blue-500"></i>
                                        Questions frÃ©quentes
                                    </h3>
                                    <div className="space-y-4">
                                        <div>
                                            <p className="font-semibold text-gray-800 mb-1">âœ… Puis-je annuler Ã  tout moment ?</p>
                                            <p className="text-sm text-gray-600">Oui, vous pouvez annuler votre abonnement Ã  tout moment depuis votre profil, sans frais.</p>
                                        </div>
                                        <div>
                                            <p className="font-semibold text-gray-800 mb-1">ðŸŽ L'essai gratuit est-il vraiment gratuit ?</p>
                                            <p className="text-sm text-gray-600">Oui, 7 jours totalement gratuits sans engagement. Annulez avant la fin pour ne rien payer.</p>
                                        </div>
                                        <div>
                                            <p className="font-semibold text-gray-800 mb-1">ðŸ’³ Que se passe-t-il aprÃ¨s l'essai ?</p>
                                            <p className="text-sm text-gray-600">Si vous ne rÃ©siliez pas, l'abonnement mensuel dÃ©marre automatiquement au prix choisi.</p>
                                        </div>
                                        <div>
                                            <p className="font-semibold text-gray-800 mb-1">ðŸ”„ Puis-je changer de plan ?</p>
                                            <p className="text-sm text-gray-600">Oui, vous pouvez upgrader ou downgrader votre plan Ã  tout moment.</p>
                                        </div>
                                    </div>
                                </div>

                                {/* Garantie */}
                                <div className="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-2xl p-5 text-center shadow-lg">
                                    <div className="text-3xl mb-2">ðŸ›¡ï¸</div>
                                    <p className="font-bold mb-1">Garantie satisfait ou remboursÃ©</p>
                                    <p className="text-sm opacity-90">7 jours pour essayer sans risque</p>
                                </div>
                            </div>
                        )}
                        {/* Modal d'export PDF */}
                        {showExportMenu && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                                <div className="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl">
                                    <div className="text-center mb-6">
                                        <div className="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-3">
                                            <i className="fas fa-file-pdf text-blue-600 text-2xl"></i>
                                        </div>
                                        <h3 className="text-lg font-bold text-gray-900 mb-2">Export PDF</h3>
                                        <p className="text-gray-600">Choisissez la pÃ©riode Ã  exporter</p>
                                    </div>

                                    <div className="space-y-3 mb-6">
                                        {[
                                            { value: 'day', label: 'Aujourd\'hui' },
                                            { value: 'week', label: '7 derniers jours' },
                                            { value: 'month', label: '30 derniers jours' }
                                        ].map(period => (
                                            <button
                                                key={period.value}
                                                onClick={() => setExportPeriod(period.value)}
                                                className={`w-full p-3 rounded-xl border-2 transition-all ${exportPeriod === period.value
                                                    ? 'bg-blue-100 border-blue-300 text-blue-800'
                                                    : 'bg-gray-50 border-gray-200 text-gray-600'
                                                    }`}
                                            >
                                                {period.label}
                                            </button>
                                        ))}
                                    </div>

                                    <div className="flex gap-3">
                                        <button
                                            onClick={() => setShowExportMenu(false)}
                                            className="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-medium"
                                        >
                                            Annuler
                                        </button>
                                        <button
                                            onClick={() => {
                                                if (isExporting) return;
                                                exportToPDF();
                                            }}
                                            disabled={isExporting}
                                            className="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 rounded-xl font-bold disabled:opacity-50"
                                        >
                                            {isExporting ? 'Export...' : 'TÃ©lÃ©charger'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* Alert personnalisÃ©e */}
                        {customAlert && (
                            <CustomAlert
                                message={customAlert.message}
                                type={customAlert.type}
                                onClose={() => setCustomAlert(null)}
                            />
                        )}
                    </div>

                </div>
            );
        };
        ReactDOM.render(<BabyTracker />, document.getElementById('root'));
    </script>
</body>

</html>